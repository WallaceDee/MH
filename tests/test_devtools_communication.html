<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTools通信测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #40a9ff;
        }
        .log-area {
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #f6ffed; color: #52c41a; }
        .status.error { background: #fff2f0; color: #ff4d4f; }
        .status.info { background: #e6f7ff; color: #1890ff; }
    </style>
</head>
<body>
    <h1>CBG爬虫助手 - DevTools通信测试</h1>
    
    <div class="test-section">
        <h2>通信流程说明</h2>
        <p>这个测试页面模拟了DevTools扩展的通信流程：</p>
        <ol>
            <li><strong>devtools.js</strong> 监听网络请求，当检测到CBG API请求时调用 <code>handleResponseReceived</code></li>
            <li><strong>handleResponseReceived</strong> 通过 <code>chrome.runtime.sendMessage</code> 发送消息到 background.js</li>
            <li><strong>background.js</strong> 接收消息并转发到所有DevTools面板</li>
            <li><strong>DevToolsPanel.vue</strong> 通过 <code>chrome.runtime.onMessage</code> 监听消息并更新UI</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>模拟测试</h2>
        <p>点击下面的按钮来模拟不同的通信场景：</p>
        
        <button class="test-button" onclick="simulateRequestWillBeSent()">
            模拟请求发送
        </button>
        
        <button class="test-button" onclick="simulateResponseReceived()">
            模拟响应接收
        </button>
        
        <button class="test-button" onclick="simulateLoadingFinished()">
            模拟加载完成
        </button>
        
        <button class="test-button" onclick="simulateDebuggerWarning()">
            模拟调试器冲突警告
        </button>
        
        <button class="test-button" onclick="clearLogs()">
            清空日志
        </button>
    </div>

    <div class="test-section">
        <h2>测试日志</h2>
        <div id="logArea" class="log-area"></div>
    </div>

    <div class="test-section">
        <h2>预期结果</h2>
        <p>如果通信正常，你应该看到：</p>
        <ul>
            <li>DevTools面板中显示检测到的请求列表</li>
            <li>请求状态从 "pending" 变为 "completed"</li>
            <li>响应数据能够正确显示和展开</li>
            <li>清空数据功能正常工作</li>
        </ul>
    </div>

    <script>
        let logCount = 0;
        
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `
                <span class="status ${type}">[${timestamp}]</span> ${message}
            `;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            logCount++;
        }
        
        function simulateRequestWillBeSent() {
            log('🔍 模拟 handleRequestWillBeSent 被调用', 'info');
            log('检测到CBG API请求: https://cbg.163.com/api/recommend.py?server_id=1&page=1', 'info');
            
            // 模拟发送消息到background
            const requestData = {
                requestId: 'test_' + Date.now(),
                url: 'https://cbg.163.com/api/recommend.py?server_id=1&page=1',
                method: 'GET',
                timestamp: Date.now(),
                status: 'pending'
            };
            
            log(`发送消息到background: updateRecommendData`, 'info');
            log(`数据: ${JSON.stringify(requestData, null, 2)}`, 'info');
        }
        
        function simulateResponseReceived() {
            log('📥 模拟 handleResponseReceived 被调用', 'info');
            log('检测到CBG API响应: https://cbg.163.com/api/recommend.py?server_id=1&page=1', 'info');
            
            const responseData = {
                requestId: 'test_' + Date.now(),
                response: {
                    status: 200,
                    statusText: 'OK',
                    timestamp: Date.now()
                },
                status: 'completed'
            };
            
            log(`更新请求状态为 completed`, 'success');
            log(`响应数据: ${JSON.stringify(responseData, null, 2)}`, 'info');
        }
        
        function simulateLoadingFinished() {
            log('📦 模拟 handleLoadingFinished 被调用', 'info');
            log('获取响应内容成功', 'success');
            
            const mockResponseData = {
                code: 200,
                data: {
                    items: [
                        { id: 1, name: '测试装备1', price: 1000 },
                        { id: 2, name: '测试装备2', price: 2000 }
                    ],
                    total: 2
                },
                message: 'success'
            };
            
            log(`解析响应内容: ${JSON.stringify(mockResponseData, null, 2)}`, 'info');
            log('DevToolsPanel应该收到 updateRecommendData 消息并更新UI', 'success');
        }
        
        function simulateDebuggerWarning() {
            log('⚠️ 模拟调试器冲突警告', 'error');
            log('检测到其他调试器已连接，请关闭Chrome开发者工具后重新加载页面', 'error');
            log('DevToolsPanel应该显示警告消息', 'info');
        }
        
        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
            logCount = 0;
            log('日志已清空', 'info');
        }
        
        // 初始化
        log('DevTools通信测试页面已加载', 'success');
        log('请按照说明进行测试', 'info');
    </script>
</body>
</html>
