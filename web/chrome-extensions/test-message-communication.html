<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>消息通信测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #005a87;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>消息通信测试页面</h1>
        
        <div class="test-section">
            <h3>基础连接测试</h3>
            <button class="test-button" onclick="testPing()">测试 Ping</button>
            <button class="test-button" onclick="testGetData()">测试获取数据</button>
            <div id="basic-status" class="status info">等待测试...</div>
        </div>
        
        <div class="test-section">
            <h3>消息发送测试</h3>
            <button class="test-button" onclick="testSendMessage()">发送测试消息</button>
            <button class="test-button" onclick="testClearData()">清空数据</button>
            <div id="send-status" class="status info">等待测试...</div>
        </div>
        
        <div class="test-section">
            <h3>Side Panel 测试</h3>
            <button class="test-button" onclick="testSidePanel()">打开 Side Panel</button>
            <button class="test-button" onclick="testSidePanelCommunication()">测试 Side Panel 通信</button>
            <div id="sidepanel-status" class="status info">等待测试...</div>
        </div>
        
        <div class="test-section">
            <h3>测试日志</h3>
            <button class="test-button" onclick="clearLog()">清空日志</button>
            <div id="test-log" class="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('test-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        // 测试 Ping
        async function testPing() {
            log('开始测试 Ping...');
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ action: 'ping' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                if (response && response.success) {
                    setStatus('basic-status', 'Ping 测试成功', 'success');
                    log('✅ Ping 测试成功', 'success');
                } else {
                    throw new Error('Ping 响应异常');
                }
            } catch (error) {
                setStatus('basic-status', `Ping 测试失败: ${error.message}`, 'error');
                log(`❌ Ping 测试失败: ${error.message}`, 'error');
            }
        }

        // 测试获取数据
        async function testGetData() {
            log('开始测试获取数据...');
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ action: 'getRecommendData' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                if (response && response.success) {
                    const dataCount = response.data ? response.data.length : 0;
                    setStatus('basic-status', `获取数据成功，共 ${dataCount} 条数据`, 'success');
                    log(`✅ 获取数据成功，共 ${dataCount} 条数据`, 'success');
                } else {
                    throw new Error('获取数据响应异常');
                }
            } catch (error) {
                setStatus('basic-status', `获取数据失败: ${error.message}`, 'error');
                log(`❌ 获取数据失败: ${error.message}`, 'error');
            }
        }

        // 测试发送消息
        async function testSendMessage() {
            log('开始测试发送消息...');
            try {
                const testMessage = {
                    action: 'testMessage',
                    data: { test: true, timestamp: Date.now() }
                };
                
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage(testMessage, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                setStatus('send-status', '消息发送成功', 'success');
                log('✅ 消息发送成功', 'success');
            } catch (error) {
                setStatus('send-status', `消息发送失败: ${error.message}`, 'error');
                log(`❌ 消息发送失败: ${error.message}`, 'error');
            }
        }

        // 测试清空数据
        async function testClearData() {
            log('开始测试清空数据...');
            try {
                const response = await new Promise((resolve, reject) => {
                    chrome.runtime.sendMessage({ action: 'clearRecommendData' }, (response) => {
                        if (chrome.runtime.lastError) {
                            reject(new Error(chrome.runtime.lastError.message));
                        } else {
                            resolve(response);
                        }
                    });
                });
                
                setStatus('send-status', '清空数据成功', 'success');
                log('✅ 清空数据成功', 'success');
            } catch (error) {
                setStatus('send-status', `清空数据失败: ${error.message}`, 'error');
                log(`❌ 清空数据失败: ${error.message}`, 'error');
            }
        }

        // 测试 Side Panel
        async function testSidePanel() {
            log('开始测试 Side Panel...');
            try {
                await chrome.sidePanel.open({});
                setStatus('sidepanel-status', 'Side Panel 打开成功', 'success');
                log('✅ Side Panel 打开成功', 'success');
            } catch (error) {
                setStatus('sidepanel-status', `Side Panel 打开失败: ${error.message}`, 'error');
                log(`❌ Side Panel 打开失败: ${error.message}`, 'error');
            }
        }

        // 测试 Side Panel 通信
        async function testSidePanelCommunication() {
            log('开始测试 Side Panel 通信...');
            try {
                // 发送一个测试消息到 side panel
                const testMessage = {
                    action: 'devtoolsConnected',
                    message: '测试消息：Side Panel 通信正常'
                };
                
                chrome.runtime.sendMessage(testMessage).then(() => {
                    setStatus('sidepanel-status', 'Side Panel 通信成功', 'success');
                    log('✅ Side Panel 通信成功', 'success');
                }).catch((error) => {
                    setStatus('sidepanel-status', `Side Panel 通信失败: ${error.message}`, 'error');
                    log(`❌ Side Panel 通信失败: ${error.message}`, 'error');
                });
            } catch (error) {
                setStatus('sidepanel-status', `Side Panel 通信测试失败: ${error.message}`, 'error');
                log(`❌ Side Panel 通信测试失败: ${error.message}`, 'error');
            }
        }

        // 页面加载完成后自动测试
        document.addEventListener('DOMContentLoaded', function() {
            log('测试页面已加载');
            setTimeout(() => {
                testPing();
            }, 1000);
        });
    </script>
</body>
</html>
