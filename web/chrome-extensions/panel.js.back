// CBGçˆ¬è™«åŠ©æ‰‹é¢æ¿è„šæœ¬
class CBGPanel {
  constructor() {
    this.recommendData = []
    this.init()
  }

  init() {
    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      console.log('CBGçˆ¬è™«åŠ©æ‰‹é¢æ¿å·²åŠ è½½')
      this.bindEvents()
    })
  }

  bindEvents() {
    // ç»‘å®šæŒ‰é’®äº‹ä»¶
    const clearBtn = document.querySelector('[data-action="clear"]')
    const testBtn = document.querySelector('[data-action="test"]')

    if (clearBtn) {
      clearBtn.addEventListener('click', () => this.clearData())
    }

    if (testBtn) {
      testBtn.addEventListener('click', () => this.testClick())
    }
  }

  // æµ‹è¯•ç‚¹å‡»äº‹ä»¶
  testClick() {
    console.log('ğŸ§ª æµ‹è¯•æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼')
    console.log('ğŸ“Š å½“å‰æ¨èæ•°æ®:', this.recommendData || 'æ— æ•°æ®')

    // æ˜¾ç¤ºå½“å‰æ•°æ®çŠ¶æ€
    const dataCount = this.recommendData ? this.recommendData.length : 0
    alert(`æµ‹è¯•æŒ‰é’®å·¥ä½œæ­£å¸¸ï¼\nå½“å‰æ•°æ®é‡: ${dataCount}\nè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–è¯¦ç»†æ—¥å¿—`)
  }

  // æ¸…ç©ºæ•°æ®
  clearData() {
    try {
      console.log('æ¸…ç©ºæ•°æ®...')
      chrome.runtime.sendMessage({
        action: 'clearRecommendData'
      })
      this.updateDataDisplay([])
      console.log('æ•°æ®å·²æ¸…ç©º')
    } catch (error) {
      console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error)
    }
  }

  // æ›´æ–°æ•°æ®æ˜¾ç¤º
  updateDataDisplay(data) {
    const container = document.getElementById('data-container')

    if (!container) {
      console.error('æ‰¾ä¸åˆ°æ•°æ®æ˜¾ç¤ºå®¹å™¨')
      return
    }

    console.log('ğŸ”„ æ›´æ–°æ•°æ®æ˜¾ç¤ºï¼Œæ•°æ®é‡:', data ? data.length : 0)

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®ï¼Œè¯·è®¿é—®CBGç½‘ç«™</div>'
      return
    }

    let html = ''
    data.forEach((item, index) => {
      html += `
                <div class="data-item">
                    <div class="data-header">
                        è¯·æ±‚ #${index + 1} - ${item.method} ${item.status}
                    </div>
                    <div class="data-url">${item.url}</div>
                    ${
                      item.responseData
                        ? `
                        <div class="data-response">${JSON.stringify(
                          item.responseData,
                          null,
                          2
                        )}</div>
                    `
                        : ''
                    }
                </div>
            `
    })

    container.innerHTML = html
  }

  // æ˜¾ç¤ºè°ƒè¯•å™¨å†²çªè­¦å‘Š
  showDebuggerWarning(message) {
    const container = document.getElementById('data-container')
    
    if (!container) {
      console.error('æ‰¾ä¸åˆ°æ•°æ®æ˜¾ç¤ºå®¹å™¨')
      return
    }

    container.innerHTML = `
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 15px; margin: 10px 0;">
        <div style="display: flex; align-items: center; margin-bottom: 10px;">
          <span style="font-size: 18px; margin-right: 8px;">âš ï¸</span>
          <strong style="color: #856404;">è°ƒè¯•å™¨å†²çªè­¦å‘Š</strong>
        </div>
        <p style="margin: 0; color: #856404; font-size: 14px;">${message}</p>
        <div style="margin-top: 10px;">
          <button onclick="location.reload()" style="padding: 6px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 8px;">
            é‡æ–°åŠ è½½é¡µé¢
          </button>
          <button onclick="this.parentElement.parentElement.style.display='none'" style="padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
            å…³é—­
          </button>
        </div>
      </div>
    `
  }
}

// åˆå§‹åŒ–é¢æ¿
const panel = new CBGPanel()

// ç›‘å¬æ•°æ®æ›´æ–°
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  if (message.action === 'updateRecommendData') {
    console.log('ğŸ“¨ æ”¶åˆ°æ•°æ®æ›´æ–°æ¶ˆæ¯:', message.data)
    panel.recommendData = message.data
    panel.updateDataDisplay(message.data)
  } else if (message.action === 'showDebuggerWarning') {
    console.warn('è°ƒè¯•å™¨å†²çªè­¦å‘Š:', message.message)
    panel.showDebuggerWarning(message.message)
  }
})
