<template>
    <el-card class="spider-system-card" shadow="never">
        <el-row slot="header" class="card-header" type="flex" justify="space-between" align="middle">
            <div><span class="emoji-icon">‚öôÔ∏è</span> ÈÖçÁΩÆ</div>
            <div class="tool-buttons">
                <el-dropdown split-button type="danger" @click="stopTask">
                    üõë ÂÅúÊ≠¢
                    <el-dropdown-menu slot="dropdown">
                        <el-dropdown-item @click.native="resetTask">üõë ÈáçÁΩÆ‰ªªÂä°</el-dropdown-item>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
        </el-row>
        <el-row type="flex">
            <div style="width: 140px;text-align: center;">
                <template v-if="externalParams.action">
                    <el-col :span="24">
                        <p class="cBlue" style="margin-bottom: 5px;">üéØÁõÆÊ†áÔºö</p>
                    </el-col>
                    <EquipmentImage v-if="externalParams.action === 'similar_equip'" :equipment="externalParams"
                        :popoverWidth="450"
                        style="display: flex;flex-direction: column;height: 50px;width: 100%;align-items: center;" />
                    <PetImage v-if="externalParams.action === 'similar_pet'" :pet="externalParams"
                        :equipFaceImg="externalParams.equip_face_img" />
                    <template v-if="externalParams.action">
                        <!-- <el-cascader :options="server_data" size="mini" filterable v-model="server_data_value" clearable /> -->
                        <div style="display: inline-block; margin-left: 8px">
                            <el-link @click="openCBGSearch" :type="isCookieValid ? 'danger' : 'info'"
                                :style="cbgLinkStyle" :disabled="!isCookieValid">
                                ËóèÂÆùÈòÅ
                            </el-link>
                            <el-tooltip v-if="!isCookieValid" content="ËØ∑ÂÖàÁôªÂΩïËóèÂÆùÈòÅÔºåÁ°Æ‰øùCookiesÊúâÊïàÂêéÂÜç‰ΩøÁî®Ê≠§ÂäüËÉΩ" placement="top">
                                <i class="el-icon-warning" style="color: #e6a23c; margin-left: 4px"></i>
                            </el-tooltip>
                        </div>
                    </template>

                </template>
            </div>
            <!-- ÂÖ®Â±ÄËÆæÁΩÆ -->
            <el-form style="width: 100%;flex-shrink: 1;" :model="globalSettings" v-show="activeTab !== 'playwright'">
                <el-row :gutter="40">
                    <el-col :span="6">
                        <el-form-item label="üìÑ Áà¨ÂèñÈ°µÊï∞" size="small">
                            <el-input-number v-model="globalSettings.max_pages" :min="1" :max="100"
                                controls-position="right" style="width: 100%"></el-input-number>
                        </el-form-item>
                    </el-col>
                    <el-col :span="8">
                        <el-form-item
                            :label="`‚è±Ô∏è Âª∂ËøüËåÉÂõ¥(Áßí) ÂΩìÂâçÔºö${globalSettings.delay_min} - ${globalSettings.delay_max} Áßí`"
                            size="small">
                            <el-slider v-model="delayRange" range show-stops :min="8" :max="30" :step="1"
                                @change="onDelayRangeChange" style="width: 100%;display: inline-block;">
                            </el-slider>
                        </el-form-item>
                    </el-col>
                    <el-col :span="10">
                        <el-form-item label="‚ö° Âø´ÈÄüÈÖçÁΩÆ" size="small" style="width: 100%;">
                            <br>
                            <el-row type="flex" align="middle" style="height:32px;">
                                <el-tag size="mini" @click="quickConfig('small')" style="cursor: pointer;">10È°µ</el-tag>
                                <el-divider direction="vertical"></el-divider>
                                <el-tag size="mini" @click="quickConfig('medium')" style="cursor: pointer;">50È°µ</el-tag>
                                <el-divider direction="vertical"></el-divider>
                                <el-tag size="mini" @click="quickConfig('large')" style="cursor: pointer;">100È°µ</el-tag>
                            </el-row>
                        </el-form-item></el-col>
                </el-row>
                <el-row type="flex" align="middle" v-if="activeTab !== 'role'">
                    <el-col :span="12">
                        <el-row type="flex">
                            <el-form-item label="üåé ÂÖ®ÊúçÊêúÁ¥¢" size="small" style="width: 150px;">
                                <el-switch v-model="globalSettings.overall"></el-switch>
                            </el-form-item>
                            <el-form-item v-if="!globalSettings.overall" label=" Â§öÂå∫ÊêúÁ¥¢" size="small"
                                style="width: 150px;">
                                <el-switch v-model="globalSettings.multi"></el-switch>
                            </el-form-item>
                        </el-row>
                    </el-col>
                    <el-col v-if="!globalSettings.overall" :span="12">
                        <el-form-item label="üéØ ÁõÆÊ†áÊúçÂä°Âô®" size="small">
                            <el-cascader v-show="globalSettings.multi" :options="hotServers" :props="{
                                value: 'server_id', label: 'server_name', multiple: true,
                                emitPath: false
                            }" collapse-tags size="mini" filterable v-model="target_server_list"
                                @change="onTargetServerChange" />
                            <el-cascader v-show="!globalSettings.multi" :options="server_data" size="mini" filterable
                                v-model="server_data_value" clearable @change="onServerDataChange" />
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row type="flex" align="middle">
                    <el-form-item label="ÊúÄ‰Ωé‰ª∑Ê†º" size="small">
                        <el-checkbox v-model="price_min_trigger"> </el-checkbox>
                        <el-input-number v-model="price_min" :min="10" :controls="false"
                            style="margin-left: 5px;"></el-input-number>
                    </el-form-item>
                </el-row>
            </el-form>
        </el-row>
        <el-tabs v-model="activeTab" tab-position="left">
            <!-- PlaywrightÂçäËá™Âä®Êî∂ÈõÜÂô® -->
            <el-tab-pane label="üñêÔ∏è ÊâãÂä®ÊäìÂèñ" name="playwright" :disabled="!!externalParams.action">
                <el-form :model="playwrightForm" label-width="120px" size="small">
                    <el-form-item label="Êó†Â§¥Ê®°Âºè">
                        <el-switch v-model="playwrightForm.headless" @change="onHeadlessToggle"></el-switch>
                        <span class="form-tip">ÂÖ≥Èó≠ÂêéÂèØ‰ª•ÁúãÂà∞ÊµèËßàÂô®Êìç‰ΩúËøáÁ®ã</span>
                    </el-form-item>

                    <el-form-item label="ÁõÆÊ†áURL">
                        <el-select v-model="playwrightForm.target_url" style="width: 100%" @change="onTargetUrlChange">
                            <el-option label="ËßíËâ≤Êé®ËçêÊêúÁ¥¢" value="role_recommend"></el-option>
                            <el-option label="Ë£ÖÂ§áÊé®ËçêÊêúÁ¥¢" value="equip_recommend"></el-option>
                            <el-option label="ÂÆ†Áâ©Êé®ËçêÊêúÁ¥¢" value="pet_recommend"></el-option>
                            <el-option label="Ëá™ÂÆö‰πâURL" value="custom"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="Ëá™ÂÆö‰πâURL" v-if="playwrightForm.target_url === 'custom'">
                        <el-input v-model="playwrightForm.custom_url" placeholder="ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁöÑCBG URL" style="width: 100%">
                            <template slot="prepend">https://</template>
                        </el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="startPlaywrightCollector" :loading="isRunning">
                            üöÄ ÂêØÂä®
                        </el-button>
                    </el-form-item>
                </el-form>
            </el-tab-pane>
            <!-- ËßíËâ≤Áà¨Ëô´ -->
            <el-tab-pane label="üë§ ËßíËâ≤" name="role" :disabled="!!externalParams.action">
                <el-form :model="roleForm" label-width="100px" size="small">
                    <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
                    <div class="params-editor">
                        <div class="params-actions">
                            <el-button type="text" size="mini" @click="() => resetParam('role')">ÈáçÁΩÆ</el-button>
                            <el-button type="primary" size="mini" @click="() => saveParam('role')" :loading="roleSaving"
                                :disabled="!!roleJsonError">
                                ‰øùÂ≠òÈÖçÁΩÆ
                            </el-button>
                        </div>
                        <div class="json-editor-wrapper">
                            <el-input type="textarea" v-model="roleParamsJson" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤Áà¨Ëô´ÂèÇÊï∞JSON" :rows="8"
                                @blur="() => validateParam('role')" class="json-editor">
                            </el-input>
                            <div v-if="roleJsonError" class="json-error">
                                <i class="el-icon-warning"></i> {{ roleJsonError }}
                            </div>
                        </div>
                    </div>

                    <el-form-item>
                        <el-button type="primary" @click="() => startSpiderByType('role')" :loading="isRunning">
                            üöÄ ÂêØÂä®
                        </el-button>
                    </el-form-item>
                </el-form>
            </el-tab-pane>

            <!-- Ë£ÖÂ§áÁà¨Ëô´ -->
            <el-tab-pane label="‚öîÔ∏è Ë£ÖÂ§á" name="equip"
                :disabled="externalParams.action && externalParams.action !== 'similar_equip'">
                <el-form :model="equipForm" label-width="100px" size="small">
                    <el-form-item label="Ë£ÖÂ§áÁ±ªÂûã">
                        <el-select v-model="equipForm.equip_type" :disabled="externalParams.action === 'similar_equip'"
                            @change="onEquipTypeChange" style="width: 100%">
                            <el-option label="ÊôÆÈÄöË£ÖÂ§á" value="normal"></el-option>
                            <el-option label="ÁÅµÈ•∞Ë£ÖÂ§á" value="lingshi"></el-option>
                            <el-option label="ÂÆ†Áâ©Ë£ÖÂ§á" value="pet"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="Â•óË£ÖÊïàÊûú" v-if="equipForm.equip_type === 'normal' && targetFeatures.suit_effect">
                        <el-radio-group v-model="suit_effect_type">
                            <el-radio label=""><span v-html="formatSuitEffect({suit_effect: targetFeatures.suit_effect})"></span> </el-radio>
                            <el-radio label="select">Ëá™ÈÄâ</el-radio>
                            <el-radio label="agility_detailed.A">ÊïèÊç∑AÂ•ó</el-radio>
                            <el-radio label="agility_detailed.B">ÊïèÊç∑BÂ•ó</el-radio>
                            <el-radio label="magic_detailed.A">È≠îÂäõAÂ•ó</el-radio>
                            <el-radio label="magic_detailed.B">È≠îÂäõBÂ•ó</el-radio>
                        </el-radio-group>
                        <el-cascader v-if="suit_effect_type === 'select'" :options="suitOptions" placeholder="ËØ∑ÈÄâÊã©Â•óË£ÖÊïàÊûú"
                            separator="" clearable filterable @change="handleSuitChange" />
                        <el-radio-group v-if="suit_effect_type?.split('.').length > 1" v-model="select_suit_effect">
                            <el-radio
                                v-for="itemId in equipConfig?.suits[suit_effect_type.split('.')[0]][suit_effect_type.split('.')[1]]"
                                :label="itemId.toString()" :key="itemId">{{ suit_transform_skills[itemId] }}</el-radio>
                        </el-radio-group>
                    </el-form-item>
                    <el-alert v-if="equipForm.equip_type === 'lingshi'" show-icon :closable="false"
                        style="margin-bottom: 10px;">
                        <span slot="title" v-html="lingshiTips"></span>
                    </el-alert>
                    <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
                    <div class="params-editor">
                        <div class="params-actions">
                            <el-button type="text" size="mini" @click="() => resetParam('equip')">ÈáçÁΩÆ</el-button>
                            <el-button type="primary" size="mini" @click="() => saveParam('equip')"
                                :loading="equipSaving" :disabled="!!equipJsonError">
                                ‰øùÂ≠òÈÖçÁΩÆ
                            </el-button>
                        </div>
                        <el-row type="flex">
                            <div class="json-editor-wrapper" v-if="externalParams.action === 'similar_equip'">
                                <el-input type="textarea" v-model="externalSearchParams" placeholder="ÊêúÁ¥¢ÊåáÂÆöÂèÇÊï∞" :rows="10"
                                    class="json-editor">
                                </el-input>
                                <div v-if="equipJsonError" class="json-error">
                                    <i class="el-icon-warning"></i> {{ equipJsonError }}
                                </div>
                            </div>
                            <div class="json-editor-wrapper">
                                <el-input type="textarea" v-model="equipParamsJson" placeholder="ËØ∑ËæìÂÖ•Ë£ÖÂ§áÁà¨Ëô´ÂèÇÊï∞JSON"
                                    :rows="10" @blur="() => validateParam('equip')" class="json-editor">
                                </el-input>
                                <div v-if="equipJsonError" class="json-error">
                                    <i class="el-icon-warning"></i> {{ equipJsonError }}
                                </div>
                            </div>
                            <div class="json-editor-wrapper">
                                <el-input type="textarea" readonly :value="cached_params" :rows="10"
                                    class="json-editor">
                                </el-input>
                            </div>
                        </el-row>
                    </div>

                    <el-form-item>
                        <el-button type="primary" @click="() => startSpiderByType('equip')" :loading="isRunning">
                            üöÄ ÂêØÂä®
                        </el-button>
                    </el-form-item>
                </el-form>
            </el-tab-pane>

            <!-- Âè¨Âî§ÂÖΩÁà¨Ëô´ -->
            <el-tab-pane label="üê≤ Âè¨Âî§ÂÖΩ" name="pet"
                :disabled="externalParams.action && externalParams.action !== 'similar_pet'">
                <el-form :model="petForm" label-width="100px" size="small">
                    <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
                    <div class="params-editor">
                        <div class="params-actions">
                            <el-button type="mini" size="mini" @click="() => resetParam('pet')">ÈáçÁΩÆ</el-button>
                            <el-button type="primary" size="mini" @click="() => saveParam('pet')" :loading="petSaving"
                                :disabled="!!petJsonError">
                                ‰øùÂ≠òÈÖçÁΩÆ
                            </el-button>
                        </div>
                        <el-row type="flex">
                            <div class="json-editor-wrapper" v-if="externalParams.action === 'similar_pet'">
                                <el-input type="textarea" v-model="externalSearchParams" :rows="10" class="json-editor">
                                </el-input>
                            </div>
                            <div class="json-editor-wrapper">
                                <el-input type="textarea" v-model="petParamsJson" placeholder="ËØ∑ËæìÂÖ•Âè¨Âî§ÂÖΩÁà¨Ëô´ÂèÇÊï∞JSON"
                                    :rows="10" @blur="() => validateParam('pet')" class="json-editor">
                                </el-input>
                                <div v-if="petJsonError" class="json-error">
                                    <i class="el-icon-warning"></i> {{ petJsonError }}
                                </div>
                            </div>
                            <div class="json-editor-wrapper">
                                <el-input type="textarea" readonly :value="cached_params" :rows="10"
                                    class="json-editor">
                                </el-input>
                            </div>
                        </el-row>
                    </div>

                    <el-form-item>
                        <el-button type="primary" @click="() => startSpiderByType('pet')" :loading="isRunning">
                            üöÄ ÂêØÂä®
                        </el-button>
                    </el-form-item>
                </el-form>
            </el-tab-pane>

        </el-tabs>
        <LogMonitor :maxLines="8" simpleMode :isRunning="isRunning" v-if="log" />
    </el-card>
</template>

<script>
import str2gbk from 'str2gbk'
import qs from 'qs'
import EquipmentImage from '@/components/EquipmentImage/EquipmentImage.vue'
import PetImage from '@/components/PetImage.vue'
import LogMonitor from '@/components/LogMonitor.vue'
import windowReuseManager from '@/utils/windowReuseManager'
import { equipmentMixin } from '@/utils/mixins/equipmentMixin'

const server_data_list = []
for (let key in window.server_data) {
    let [parent, children] = window.server_data[key]
    const [label, , , , value] = parent
    children = children.map(([value, label]) => ({ value, label }))
    server_data_list.push({
        label,
        value,
        children
    })
}
export default {
    name: 'AutoParams',
    props: {
        log: {
            type: Boolean,
            default: true
        }
    },
    mixins: [equipmentMixin],
    components: {
        EquipmentImage,
        LogMonitor,
        PetImage
    },
    data() {
        return {
            price_min: 1,
            price_min_trigger: false,
            suit_transform_skills: window.AUTO_SEARCH_CONFIG.suit_transform_skills,
            suitOptions: [],
            suit_effect_type: '',
            select_suit_effect: '',
            equipConfig: {},
            hotServers: [],
            server_data: server_data_list,
            target_server_list: [], // Â≠òÂÇ®server_idÁöÑÊï∞ÁªÑÔºàÁî®‰∫éel-cascaderÁöÑv-modelÔºâ
            target_server_objects: [], // Â≠òÂÇ®ÂÆåÊï¥ÊúçÂä°Âô®ÂØπË±°ÁöÑÊï∞ÁªÑ
            // ÂÖ®Â±ÄËÆæÁΩÆ
            globalSettings: {
                max_pages: 5,
                delay_min: 8,
                delay_max: 20,
                overall: false,
                multi: false,
            },
            // Âª∂ËøüËåÉÂõ¥ÊªëÂùó
            delayRange: [8, 20],
            // ËßíËâ≤Áà¨Ëô´Ë°®Âçï
            roleForm: {
            },
            // Ë£ÖÂ§áÁà¨Ëô´Ë°®Âçï
            equipForm: {
                equip_type: 'normal',
            },
            // Âè¨Âî§ÂÖΩÁà¨Ëô´Ë°®Âçï
            petForm: {
            },
            // ‰ª£ÁêÜÁà¨Ëô´Ë°®Âçï
            proxyForm: {},
            // PlaywrightÊî∂ÈõÜË°®Âçï
            playwrightForm: {
                headless: false,
                target_url: 'role_recommend',
                custom_url: ''
            },
            // JSONÂèÇÊï∞Â≠óÁ¨¶‰∏≤
            roleParamsJson: '',
            equipParamsJson: '{}',
            petParamsJson: '',
            // JSONÈ™åËØÅÈîôËØØ
            roleJsonError: '',
            equipJsonError: '',
            petJsonError: '',
            // ÈªòËÆ§ÂèÇÊï∞Ê®°ÊùøÔºàÂ∞Ü‰ªéAPIÂä®ÊÄÅÂä†ËΩΩÔºâ
            defaultParams: {
                role: {},
                equip_normal: {},
                equip_lingshi: {},
                equip_pet: {},
                equip_pet_equip: {},
                pet: {}
            },
            // Âä†ËΩΩÁä∂ÊÄÅ
            isRunning: false,
            paramsLoading: false,

            // TabÁõ∏ÂÖ≥
            activeTab: 'playwright',
            // Áä∂ÊÄÅÁõëÊéß
            statusMonitor: null,
            // ‰øùÂ≠òÁä∂ÊÄÅ
            roleSaving: false,
            equipSaving: false,
            petSaving: false,
            // ÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®
            cacheCleanupTimer: null,

            // Â§ñÈÉ®ÂèÇÊï∞
            externalSearchParams: '{}',
            targetFeatures: {},

            // ÂèÇÊï∞ÁÆ°ÁêÜÂô®ÈÖçÁΩÆ - Áªü‰∏ÄÁÆ°ÁêÜÊâÄÊúâÂèÇÊï∞Á±ªÂûã
            paramManager: {
                role: {
                    jsonKey: 'roleParamsJson',
                    errorKey: 'roleJsonError',
                    savingKey: 'roleSaving',
                    paramType: 'role',
                    successMessage: 'ËßíËâ≤ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü',
                    spiderType: 'role',
                    spiderName: 'ËßíËâ≤Áà¨Ëô´',
                    getParams: () => ({
                        ...this.globalSettings,
                        ...this.roleForm,
                        cached_params: JSON.parse(this.roleParamsJson)
                    })
                },
                equip: {
                    jsonKey: 'equipParamsJson',
                    errorKey: 'equipJsonError',
                    savingKey: 'equipSaving',
                    paramType: 'equip',
                    successMessage: 'Ë£ÖÂ§áÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü',
                    spiderType: 'equip',
                    spiderName: 'Ë£ÖÂ§áÁà¨Ëô´',
                    getParamType: () => this.getEquipParamKey(this.equipForm.equip_type),
                    getSuccessMessage: () => `${this.getEquipTypeName(this.equipForm.equip_type)}ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü`,
                    getParams: () => {
                        //TODO:target_server_objectsË¶ÅÊääthis.cached_params.server_idÊéíÂ∫èÂà∞Á¨¨‰∏Ä‰∏™
                        const params = {
                            target_server_list: this.target_server_objects,
                            ...this.equipForm,
                            ...this.globalSettings,
                            cached_params: JSON.parse(this.cached_params)
                        }
                        if (params.overall) {
                            params.multi = false
                            params.target_server_list = undefined
                        }
                        return params
                    }
                },
                pet: {
                    jsonKey: 'petParamsJson',
                    errorKey: 'petJsonError',
                    savingKey: 'petSaving',
                    paramType: 'pet',
                    successMessage: 'ÂÆ†Áâ©ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü',
                    spiderType: 'pet',
                    spiderName: 'Âè¨Âî§ÂÖΩÁà¨Ëô´',
                    getParams: () => ({
                        target_server_list: this.target_server_objects,
                        ...this.petForm,
                        ...this.globalSettings,
                        cached_params: JSON.parse(this.cached_params)
                    })
                }
            }
        }
    },
    computed: {
        lingshiTips() {
            const labels = {
                1: 'Âõ∫‰º§', 2: '‰º§ÂÆ≥', 3: 'ÈÄüÂ∫¶', 4: 'Ê≥ï‰º§', 5: 'ÁãÇÊö¥', 6: 'Áâ©ÁêÜÊö¥Âáª', 7: 'Ê≥ïÊúØÊö¥Âáª',
                8: 'Â∞ÅÂç∞', 9: 'Ê≥ï‰º§ÁªìÊûú', 10: 'Á©øÂà∫', 11: 'Ê≤ªÁñó', 12: 'Ê∞îË°Ä', 13: 'Èò≤Âæ°', 14: 'Ê≥ïÈò≤',
                15: 'ÊäóÁâ©ÁêÜÊö¥Âáª', 16: 'ÊäóÊ≥ïÊúØÊö¥Âáª', 17: 'ÊäóÂ∞Å', 18: 'Ê†ºÊå°', 19: 'ÂõûÂ§ç'
            }
            const highlighted = new Set()
            for (let key in JSON.parse(this.externalSearchParams)) {
                if (key.startsWith('added_attr.')) {
                    const typeId = Number(key.replace('added_attr.', ''))
                    if (!Number.isNaN(typeId)) highlighted.add(typeId)
                }
            }
            const parts = []
            for (let i = 1; i <= 19; i++) {
                const name = labels[i]
                const text = highlighted.has(i) ? `<b style="color:#F56C6C;">${name}</b>` : name
                parts.push(`<b ${highlighted.has(i) ? 'style="color:#F56C6C;"' : ''}>${i}:</b> ${text}`)
            }
            return parts.join(', ')
        },
        view_loc() {
            return {
                view_loc: this.globalSettings.overall ? 'overall_search' : 'search_cond'
            }
        },
        currentServerData() {
            const { server_id, areaid, server_name } = this.$store.getters.getCurrentServerData
            return { server_id, areaid, server_name }
        },
        externalParams() {
            const query = JSON.parse(JSON.stringify(this.$route.query))
            if (query.action === 'similar_pet') {
                query.evol_skill_list = JSON.parse(query.evol_skill_list || '{}')
                query.neidan = JSON.parse(query.neidan || '{}')
                query.equip_list = JSON.parse(query.equip_list || '{}')
                query.texing = JSON.parse(query.texing || '{}')
            }
            return query
        },
        // ‰ªéVuex storeËé∑Âèñserver_data_valueTODO:::::
        server_data_value: {
            get() {
                return this.$store?.state.server_data_value || {}
            },
            set(value) {
                this.$store.dispatch('setServerDataValue', value)
            }
        },
        // Ê£ÄÊü•cookiesÊòØÂê¶ÊúâÊïà
        isCookieValid() {
            return this.$store.getters['cookie/isCookieCacheValid']
        },
        // ËóèÂÆùÈòÅÈìæÊé•Ê†∑Âºè
        cbgLinkStyle() {
            return {
                color: this.isCookieValid ? '#f56c6c' : '#c0c4cc',
                cursor: this.isCookieValid ? 'pointer' : 'not-allowed',
                textDecoration: this.isCookieValid ? 'underline' : 'none'
            }
        },
        cached_params() {
            try {
                let diyParams = JSON.parse(this.equipParamsJson)
                if (this.activeTab === 'pet') {
                    diyParams = JSON.parse(this.petParamsJson)
                }
                const mode_params = {
                    ...this.view_loc,
                    hide_lingshi: this.activeTab === 'equip' && this.equipForm.equip_type === 'normal' ? 1 : undefined
                }
                const currentServerData = this.globalSettings.overall ? { server_id: undefined, server_name: undefined, areaid: undefined } : this.currentServerData
                return JSON.stringify(Object.assign(JSON.parse(this.externalSearchParams), diyParams, currentServerData, mode_params), null, 2)
            } catch (error) {
                return '{}'
            }
        }
    },
    watch: {
        price_min(newVal) {
            if(this.price_min_trigger){
            const params = JSON.parse(this.equipParamsJson)
            params.price_min = this.price_min_trigger ? newVal * 100 : undefined
            this.equipParamsJson = JSON.stringify(params, null, 2)
        }
        },
        price_min_trigger(newVal) {
            const params = JSON.parse(this.equipParamsJson)
            params.price_min = newVal ? this.price_min * 100 : undefined
            this.equipParamsJson = JSON.stringify(params, null, 2)
        },
        select_suit_effect(newVal) {
            const params = JSON.parse(this.equipParamsJson)
            params.suit_effect = newVal ? newVal : undefined
            this.equipParamsJson = JSON.stringify(params, null, 2)
        },
        suit_effect_type(newVal) {
            if (!newVal) {
                this.select_suit_effect = ''
            }
        },
        isRunning(newVal) {
            this.$emit('update:isRunning', newVal)
            if (newVal) {
                this.startStatusMonitor()
            } else {
                this.stopStatusMonitor()
            }
        },
        'globalSettings.multi'(val) {
            if (val) {
                // Â§öÊúçÂä°Âô®Ê®°ÂºèÂºÄÂêØÊó∂ÔºåËá™Âä®ËÆæÁΩÆÂêåÁ∫ßÂà´ÊúçÂä°Âô®
                const server_id = Number(this.externalParams.serverid)
                console.log('ÂºÄÂêØÂ§öÊúçÂä°Âô®Ê®°ÂºèÔºåÂΩìÂâçÊúçÂä°Âô®ID:', server_id)
                this.globalSettings.max_pages = 1
                // Ê†πÊçÆserver_idÂú®hotServers‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÂêåÁ∫ßÂà´ÁöÑÊúçÂä°Âô®
                this.setTargetServersByLevel(server_id)
            } else {
                // Â§öÊúçÂä°Âô®Ê®°ÂºèÂÖ≥Èó≠Êó∂ÔºåÊ∏ÖÁ©∫ÁõÆÊ†áÊúçÂä°Âô®ÂàóË°®
                this.target_server_list = []
                this.target_server_objects = []
                console.log('ÂÖ≥Èó≠Â§öÊúçÂä°Âô®Ê®°ÂºèÔºåÊ∏ÖÁ©∫ÁõÆÊ†áÊúçÂä°Âô®ÂàóË°®')
            }
        }
    },
    async mounted() {
        // Á≠âÂæÖVuexÁä∂ÊÄÅÊÅ¢Â§çÂêéÂÜçÊâßË°åÂÖ∂‰ªñÊìç‰Ωú
        // Ëá™Âä®Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
        this.$store.dispatch('cookie/cleanExpiredCache')

        // ÂêØÂä®ÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®ÔºàÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°Ôºâ
        this.cacheCleanupTimer = setInterval(() => {
            this.$store.dispatch('cookie/cleanExpiredCache')
        }, 60 * 1000)

        this.loadHotServers()
        await this.loadSearchParams()
        // È°µÈù¢Âä†ËΩΩÊó∂ËØ∑Ê±Ç‰∏ÄÊ¨°Áä∂ÊÄÅ
        this.checkTaskStatus()
        // ÂàùÂßãÂåñÂª∂ËøüËåÉÂõ¥ÊªëÂùó
        this.delayRange = [this.globalSettings.delay_min, this.globalSettings.delay_max]

        this.loadExternalParams()
        // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÈªòËÆ§ÁöÑserver_data_valueÔºàÂ¶ÇÊûústore‰∏≠Ê≤°ÊúâÁöÑËØùÔºâ
        if (
            this.externalParams.action &&
            (!this.$store?.state.server_data_value || this.$store?.state.server_data_value.length === 0)
        ) {
            this.$store.dispatch('setServerDataValue', [43, 77])
        }
        if (this.externalParams.action) {
            this.getFeatures().then(() => {
                this.loadEquipConfig()
            })
        }
        this.initSuitOptions()
        // ÂàùÂßãÂåñÁ™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®
        this.initWindowReuseManager()
    },
    beforeDestroy() {
        this.stopStatusMonitor()
        // Ê∏ÖÁêÜÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®
        if (this.cacheCleanupTimer) {
            clearInterval(this.cacheCleanupTimer)
        }
    },
    methods: {
        handleSuitChange(value) {
            const [, suitValue] = value
            const actualValue = suitValue?.split('_').pop() // ÊèêÂèñÁúüÂÆûÁöÑÂ•óË£ÖID
            this.select_suit_effect = actualValue || ''
        },
        onServerDataChange() {
            const { server_id, areaid, server_name } = this.$store.getters.getCurrentServerData
            console.log('server_data_value', { server_id, areaid, server_name })
        },
        // Â§ÑÁêÜÁõÆÊ†áÊúçÂä°Âô®ÈÄâÊã©ÂèòÂåñ
        onTargetServerChange(selectedServerIds) {
            // ÂΩìÊúçÂä°Âô®ÈÄâÊã©ÂèëÁîüÂèòÂåñÊó∂ÔºåÊ†πÊçÆserver_idÊü•ÊâæÂÆåÊï¥ÁöÑÊúçÂä°Âô®ÂØπË±°
            this.target_server_objects = []

            if (selectedServerIds && selectedServerIds.length > 0) {
                // ÈÅçÂéÜÊâÄÊúâÈÄâ‰∏≠ÁöÑserver_id
                selectedServerIds.forEach(serverId => {
                    // Âú®hotServers‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑÂÆåÊï¥ÊúçÂä°Âô®ÂØπË±°
                    this.findServerInHotServers(serverId)
                })
            }
        },
        // Âú®hotServersÂµåÂ•óÁªìÊûÑ‰∏≠Êü•ÊâæÊúçÂä°Âô®
        findServerInHotServers(serverId) {
            for (const area of this.hotServers) {
                if (area.children) {
                    for (const server of area.children) {
                        if (server.server_id === serverId) {
                            this.target_server_objects.push({
                                server_id: server.server_id,
                                areaid: area.areaid || server.areaid,
                                server_name: server.server_name
                            })
                            return
                        }
                    }
                }
            }
        },

        // Ê†πÊçÆÊúçÂä°Âô®IDÊâæÂà∞ÂêåÁ∫ßÂà´ÁöÑÊúçÂä°Âô®Âπ∂ËÆæÁΩÆ‰∏∫ÁõÆÊ†áÊúçÂä°Âô®
        setTargetServersByLevel(serverId) {
            if (!this.hotServers || this.hotServers.length === 0) {
                console.warn('hotServersÊï∞ÊçÆÊú™Âä†ËΩΩÔºåÊó†Ê≥ïËÆæÁΩÆÁõÆÊ†áÊúçÂä°Âô®')
                return
            }

            // Êü•ÊâæÂΩìÂâçÊúçÂä°Âô®ÊâÄÂú®ÁöÑÁÉüËä±Á≠âÁ∫ßÁªÑ
            let currentLevel = null
            let currentServer = null

            for (const level of this.hotServers) {
                if (level.children) {
                    for (const server of level.children) {
                        if (server.server_id === serverId) {
                            currentLevel = level
                            currentServer = server
                            break
                        }
                    }
                    if (currentLevel) break
                }
            }

            if (!currentLevel || !currentServer) {
                console.warn(`Êú™ÊâæÂà∞ÊúçÂä°Âô®ID ${serverId} ÂØπÂ∫îÁöÑÁÉüËä±Á≠âÁ∫ßÁªÑ`)
                return
            }

            console.log(`ÊâæÂà∞ÊúçÂä°Âô® ${currentServer.server_name} Âú®ÁÉüËä±Á≠âÁ∫ßÁªÑ: ${currentLevel.server_name}`)

            // ËÆæÁΩÆÂêåÁ∫ßÂà´ÊúçÂä°Âô®ÁöÑÁõÆÊ†áÂàóË°®
            this.target_server_objects = []
            this.target_server_list = []

            // ÈÅçÂéÜÂêåÁ∫ßÂà´ÁöÑÊâÄÊúâÊúçÂä°Âô®
            currentLevel.children.forEach(server => {
                const serverObject = {
                    server_id: server.server_id,
                    areaid: currentLevel.areaid || server.areaid,
                    server_name: server.server_name
                }

                this.target_server_objects.push(serverObject)
                this.target_server_list.push(server.server_id)
            })

            console.log(`Â∑≤ËÆæÁΩÆ ${this.target_server_objects.length} ‰∏™ÂêåÁ∫ßÂà´ÊúçÂä°Âô®‰∏∫ÁõÆÊ†áÊúçÂä°Âô®:`, this.target_server_objects)

        },
        // ÂàùÂßãÂåñÁ™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®
        initWindowReuseManager() {
            try {
                // Á°Æ‰øùÁ™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®Â∑≤Ê≠£Á°ÆÂàùÂßãÂåñ
                if (windowReuseManager && windowReuseManager.isSetup) {
                    console.log('Á™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®Â∑≤ÂàùÂßãÂåñÔºåÁä∂ÊÄÅ:', windowReuseManager.getStatus())
                } else {
                    console.log('Á™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®Ê≠£Âú®ÂàùÂßãÂåñ...')
                    // Á≠âÂæÖÂàùÂßãÂåñÂÆåÊàê
                    setTimeout(() => {
                        if (windowReuseManager && windowReuseManager.isSetup) {
                            console.log('Á™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàêÔºåÁä∂ÊÄÅ:', windowReuseManager.getStatus())
                        } else {
                            console.warn('Á™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Ë¥•')
                        }
                    }, 1000)
                }

                // ÁõëÂê¨ÂèÇÊï∞Êõ¥Êñ∞‰∫ã‰ª∂
                window.addEventListener('params-updated', (event) => {
                    const { params, timestamp } = event.detail
                    console.log('Á™óÂè£ÂèÇÊï∞Â∑≤Êõ¥Êñ∞:', params)

                    // Âº∫Âà∂Âà∑Êñ∞ÁªÑ‰ª∂Êï∞ÊçÆ
                    this.$forceUpdate()

                    // ÈáçÊñ∞Âä†ËΩΩÂ§ñÈÉ®ÂèÇÊï∞
                    this.loadExternalParams()

                    // ÈáçÊñ∞Ëé∑ÂèñÁâπÂæÅ
                    if (params.action) {
                        this.getFeatures()
                    }

                    // ÈáçÊñ∞ÂàùÂßãÂåñË£ÖÂ§áÁ±ªÂûãÁõ∏ÂÖ≥ÁöÑÈÖçÁΩÆ
                    if (params.equip_type) {
                        this.equipForm.equip_type = params.equip_type
                        // ÈáçÊñ∞Âä†ËΩΩË£ÖÂ§áÂèÇÊï∞ÈÖçÁΩÆ
                        this.loadSearchParams()
                    }

                    // ÈáçÊñ∞ËÆæÁΩÆactiveTab
                    if (params.activeTab) {
                        this.activeTab = params.activeTab
                    }

                    console.log('‚úÖ È°µÈù¢Êï∞ÊçÆÂ∑≤Âà∑Êñ∞')
                })
            } catch (error) {
                console.warn('ÂàùÂßãÂåñÁ™óÂè£Â§çÁî®ÁÆ°ÁêÜÂô®Â§±Ë¥•:', error)
            }
        },

        // ÂÅúÊ≠¢‰ªªÂä°
        async stopTask() {
            try {
                const response = await this.$api.spider.stopTask()
                if (response.code === 200) {
                    this.$notify.success({
                        title: '‰ªªÂä°Áä∂ÊÄÅ',
                        message: response.data?.message || '‰ªªÂä°Â∑≤ÂÅúÊ≠¢'
                    })
                    this.isRunning = false
                } else {
                    this.$notify.error({
                        title: '‰ªªÂä°Áä∂ÊÄÅ',
                        message: response.message || 'ÂÅúÊ≠¢Â§±Ë¥•'
                    })
                }
            } catch (error) {
                this.$notify.error({
                    title: '‰ªªÂä°Áä∂ÊÄÅ',
                    message: error.message
                })
            }
        },

        // ÈáçÁΩÆ‰ªªÂä°Áä∂ÊÄÅ
        async resetTask() {
            try {
                const response = await this.$api.spider.resetTask()
                if (response.code === 200) {
                    this.$notify.success({
                        title: '‰ªªÂä°Áä∂ÊÄÅ',
                        message: response.data?.message || '‰ªªÂä°Áä∂ÊÄÅÂ∑≤ÈáçÁΩÆ'
                    })
                    this.isRunning = false
                } else {
                    this.$notify.error({
                        title: '‰ªªÂä°Áä∂ÊÄÅ',
                        message: response.message || 'ÈáçÁΩÆÂ§±Ë¥•'
                    })
                }
            } catch (error) {
                this.$notify.error({
                    title: '‰ªªÂä°Áä∂ÊÄÅ',
                    message: error.message
                })
            }
        },

        genaratePetSearchParams() {
            const searchParams = {}
            searchParams.skill = this.externalParams.all_skill.replace(/\|/g, ',')
            searchParams.texing = this.externalParams.texing?.id
            searchParams.lingxing = this.externalParams.lx
            searchParams.growth = this.externalParams.growth * 1000
            return searchParams
        },
        genarateEquipmentSearchParams({ kindid, ...features }) {
            const searchParams = {}
            if (window.is_pet_equip(kindid)) {
                this.equipForm.equip_type = 'pet'
                searchParams.level = features.equip_level
                searchParams.speed = features.speed > 0 ? features.speed : undefined
                searchParams.shanghai = features.shanghai > 0 ? features.shanghai : undefined
                searchParams.hp = features.qixue > 0 ? features.qixue : undefined
                searchParams.fangyu = features.fangyu > 0 ? features.fangyu : undefined
                searchParams.xiang_qian_level = features.xiang_qian_level > 0 ? features.xiang_qian_level : undefined
                let addon_sum = 0
                    ;['fali', 'liliang', 'lingli', 'minjie', 'naili'].forEach((item) => {
                        searchParams[`addon_${item}`] = this.targetFeatures[`addon_${item}`] > 0 ? 1 : undefined
                        if (item === 'minjie' && this.targetFeatures[`addon_${item}`] < 0) {
                            searchParams.addon_minjie_reduce = this.targetFeatures[`addon_${item}`] * -1
                        } else {
                            addon_sum += this.targetFeatures[`addon_${item}`]
                        }
                    })
                searchParams.addon_sum = addon_sum > 0 ? addon_sum : undefined
                searchParams.addon_sum_min = searchParams.addon_sum
                searchParams.addon_status = features.addon_status
                if (features.fangyu > 0) {
                    searchParams.equip_pos = 1
                } else if (features.speed > 0) {
                    searchParams.equip_pos = 2
                } else {
                    searchParams.equip_pos = 3
                }
            } else if (window.is_lingshi_equip(kindid)) {
                searchParams.kindid = kindid
                this.equipForm.equip_type = 'lingshi'
                if (features.equip_level) {
                    searchParams.equip_level_min = features.equip_level
                    searchParams.equip_level_max = features.equip_level * 1 + 9
                }
                // ÁÅµÈ•∞ÈôÑÂä†Â±ûÊÄßÈÖçÁΩÆ
                const { lingshi_added_attr1, lingshi_added_attr2 } = window.AUTO_SEARCH_CONFIG

                // Â±ûÊÄßÂêçÁß∞Êò†Â∞ÑË°® - ÂâçÁ´ØÊòæÁ§∫ÂêçÁß∞Âà∞ÂêéÁ´ØÂ≠óÊÆµÂêçÁöÑÊò†Â∞Ñ
                const attr_name_map = {
                    'Ê≥ï‰º§ÁªìÊûú': 'Ê≥ïÊúØ‰º§ÂÆ≥ÁªìÊûú',
                    'Ê≥ï‰º§': 'Ê≥ïÊúØ‰º§ÂÆ≥',
                    'Âõ∫‰º§': 'Âõ∫ÂÆö‰º§ÂÆ≥',
                    'Ê≥ïÊúØÊö¥Âáª': 'Ê≥ïÊúØÊö¥ÂáªÁ≠âÁ∫ß',
                    'Áâ©ÁêÜÊö¥Âáª': 'Áâ©ÁêÜÊö¥ÂáªÁ≠âÁ∫ß',
                    'Â∞ÅÂç∞': 'Â∞ÅÂç∞ÂëΩ‰∏≠Á≠âÁ∫ß',
                    'ÁãÇÊö¥': 'ÁãÇÊö¥Á≠âÁ∫ß',
                    'Á©øÂà∫': 'Á©øÂà∫Á≠âÁ∫ß',
                    'Ê≤ªÁñó': 'Ê≤ªÁñóËÉΩÂäõ',
                    '‰º§ÂÆ≥': '‰º§ÂÆ≥',
                    'ÈÄüÂ∫¶': 'ÈÄüÂ∫¶',
                    'ÊäóÊ≥ïÊúØÊö¥Âáª': 'ÊäóÊ≥ïÊúØÊö¥ÂáªÁ≠âÁ∫ß',
                    'ÊäóÁâ©ÁêÜÊö¥Âáª': 'ÊäóÁâ©ÁêÜÊö¥ÂáªÁ≠âÁ∫ß',
                    'ÊäóÂ∞Å': 'ÊäµÊäóÂ∞ÅÂç∞Á≠âÁ∫ß',
                    'ÂõûÂ§ç': 'Ê∞îË°ÄÂõûÂ§çÊïàÊûú',
                    'Ê≥ïÈò≤': 'Ê≥ïÊúØÈò≤Âæ°',
                    'Èò≤Âæ°': 'Èò≤Âæ°',
                    'Ê†ºÊå°': 'Ê†ºÊå°ÂÄº',
                    'Ê∞îË°Ä': 'Ê∞îË°Ä'
                }

                // ÊûÑÂª∫Â±ûÊÄßÂÄºÂà∞ÊêúÁ¥¢ÂèÇÊï∞ÁöÑÊò†Â∞Ñ
                const buildAttrValueMapping = () => {
                    const mapping = {}

                    // ÂêàÂπ∂‰∏§‰∏™Â±ûÊÄßÈÖçÁΩÆ
                    const allAttrs = { ...lingshi_added_attr1, ...lingshi_added_attr2 }

                    // ÈÅçÂéÜÊâÄÊúâÂ±ûÊÄßÔºåÂª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª
                    Object.entries(allAttrs).forEach(([value, displayName]) => {
                        const backendFieldName = attr_name_map[displayName]
                        if (backendFieldName) {
                            mapping[backendFieldName] = value
                        }
                    })

                    return mapping
                }

                // Â§ÑÁêÜ‰∏ªÂ±ûÊÄß
                const processMainAttributes = () => {
                    const mainAttrs = ['damage', 'defense', 'magic_damage', 'magic_defense', 'fengyin', 'anti_fengyin', 'speed']
                    mainAttrs.forEach(attr => {
                        if (features[attr] && features[attr] > 0) {
                            searchParams[attr] = features[attr]
                        }
                    })
                }

                // Â§ÑÁêÜÁ≤æÁÇºÁ≠âÁ∫ß
                const processGemLevel = () => {
                    if (features.gem_level && features.gem_level > 0) {
                        searchParams.jinglian_level = features.gem_level
                    }
                }

                // Â§ÑÁêÜÈôÑÂä†Â±ûÊÄß
                const processAddedAttributes = () => {
                    if (!features.attrs || !Array.isArray(features.attrs)) {
                        return
                    }

                    const attrValueMapping = buildAttrValueMapping()
                    const addedAttrsCount = {}

                    // ÁªüËÆ°ÊØèÁßçÈôÑÂä†Â±ûÊÄßÁöÑÂá∫Áé∞Ê¨°Êï∞
                    features.attrs.forEach(({ attr_type }) => {
                        const searchValue = attrValueMapping[attr_type]
                        if (searchValue) {
                            addedAttrsCount[searchValue] = (addedAttrsCount[searchValue] || 0) + 1
                        }
                    })

                    // Â∞ÜÁªüËÆ°ÁªìÊûúÊ∑ªÂä†Âà∞ÊêúÁ¥¢ÂèÇÊï∞
                    Object.entries(addedAttrsCount).forEach(([value, count]) => {
                        searchParams[`added_attr.${value}`] = count
                    })
                }

                // ÊâßË°åÂ§ÑÁêÜ
                processMainAttributes()
                processGemLevel()
                processAddedAttributes()
            } else {
                searchParams.kindid = kindid
                let sum_attr_value = 0
                const sum_attr_type_list = []
                    ;[['moli', 'magic'], ['liliang', 'power'], ['tizhi', 'physique'], ['minjie', 'dex'], ['naili', 'endurance']].forEach(([featureKey, searchKey]) => {
                        if (this.targetFeatures[`addon_${featureKey}`] > 0) {
                            sum_attr_type_list.push(searchKey)
                        }
                        sum_attr_value += this.targetFeatures[`addon_${featureKey}`]
                    })
                if (sum_attr_value > 0) {
                    searchParams.sum_attr_type = sum_attr_type_list.join(',')
                    searchParams.sum_attr_value = sum_attr_value
                }
                if (features.gem_level > 0) {
                    searchParams.gem_level = features.gem_level
                    searchParams.gem_value = features.gem_value.join(',')
                }
                if (features.equip_level) {
                    searchParams.level_min = features.equip_level
                    searchParams.level_max = features.equip_level * 1 + 9
                }
                if (features.special_effect && features.special_effect.length > 0) {
                    searchParams.special_mode = 'and'
                    searchParams.special_effect = features.special_effect.join(',')
                }
                if (features.suit_effect) {
                    searchParams.suit_effect = features.suit_effect
                }
                if (features.special_skill) {
                    searchParams.special_skill = features.special_skill
                }
                if (features.hole_num) {
                    searchParams.hole_num = features.hole_num
                }

                const paramsKey = [
                    // 'init_damage', //all_damageÂ∑≤ÁªèÂåÖÂê´init_damage
                    'init_damage_raw',
                    'init_defense',
                    'init_hp',
                    'init_dex',
                    'init_wakan',
                    'all_wakan',
                    'all_damage',
                    'damage'
                ]
                //Â¶ÇÊûúÊòØÊ≠¶Âô®ÊâìÂè™Â§™Èò≥Áü≥ÔºåÂàôÂøΩÁï•all_damage
                if (searchParams.gem_value === '2') {
                    paramsKey.splice(paramsKey.indexOf('all_damage'), 1)
                } else if (searchParams.gem_value === '1') {
                    //Â¶ÇÊûúÊòØÊ≠¶Âô®ÊâìÂè™Á∫¢ÁéõÁëôÔºåÂàôÂøΩÁï•init_damage
                    paramsKey.splice(paramsKey.indexOf('init_damage'), 1)
                }

                paramsKey.forEach((value) => {
                    if (features[value]) {
                        searchParams[value] = features[value]
                    }
                })
            }
            return searchParams
        },
        // ÈÄöËøáserver_idÂú®window.server_data‰∏≠ÂèçÊü•ÂØπÂ∫îÁöÑareaid
        getAreaIdByServerId(serverId) {
            if (!window || !window.server_data) return undefined
            const sid = Number(serverId)
            for (let key in window.server_data) {
                const [parent, children] = window.server_data[key]
                const areaValue = parent && parent.length >= 5 ? parent[4] : undefined
                if (!Array.isArray(children)) continue
                for (const child of children) {
                    if (Array.isArray(child) && child[0] === sid) {
                        return areaValue
                    }
                }
            }
            return undefined
        },
        async getFeatures() {
            let query = {}
            if (this.externalParams.action === 'similar_equip') {

                await this.$api.equipment
                    .extractFeatures({
                        equipment_data: {
                            kindid: this.externalParams.kindid * 1 || undefined,
                            type: this.externalParams.type * 1 || undefined,
                            large_equip_desc: this.externalParams.large_equip_desc
                        },
                        data_type: 'equipment'
                    })
                    .then((res) => {
                        if (res.code === 200 && res.data.features) {
                            this.targetFeatures = res.data.features
                            // ‰ΩøÁî®equip_name,large_equip_descÊîπÂèòÂΩìÂâçtitle
                            document.title = this.targetFeatures.equip_level + 'Á∫ß' + this.externalParams.equip_name + ' - ' + this.externalParams.large_equip_desc.replace(/#r|#Y|#G|#c4DBAF4|#W|#cEE82EE|#c7D7E82/g, '')
                            //‰ΩøÁî® this.externalParams.equip_face_imgÂä®ÊÄÅÊîπÂèòÁΩëÈ°µÁöÑfavicon.ico
                            document.querySelector('link[rel="icon"]').href = this.externalParams.equip_face_img
                            query = this.genarateEquipmentSearchParams(res.data.features)
                        }
                    })
            } else if (this.externalParams.action === 'similar_pet') {
                query = this.genaratePetSearchParams()
            }
            if (this.externalParams.serverid) {
                // Â¶ÇÊûúserveridÂ≠òÂú®ÔºåÂàôËÆæÁΩÆserver_idÔºåÂπ∂Ê†πÊçÆserver_dataËÆ°ÁÆóareaid
                const server_id = Number(this.externalParams.serverid)
                const areaid = this.getAreaIdByServerId(server_id)
                query.server_id = server_id
                if (areaid !== undefined) {
                    query.areaid = areaid
                }
                this.server_data_value = [areaid, server_id]
                query.server_name = this.externalParams.server_name
            }
            this.externalSearchParams = JSON.stringify(query, null, 2)
        },
        async openCBGSearch() {
            // Ê£ÄÊü•cookiesÊòØÂê¶ÊúâÊïà
            const isCookieValid = this.$store.getters['cookie/isCookieCacheValid']

            if (!isCookieValid) {
                // CookiesÊó†ÊïàÔºåÊèêÁ§∫Áî®Êà∑ÂÖàÁôªÂΩï
                this.$notify.warning({
                    message: 'ËØ∑ÂÖàÁôªÂΩïËóèÂÆùÈòÅÔºåÁ°Æ‰øùCookiesÊúâÊïàÂêéÂÜç‰ΩøÁî®Ê≠§ÂäüËÉΩ',
                    duration: 3000,
                    showClose: true
                })
                return
            }

            let prefix = ''
            let search_type = 'search_role_equip'
            let query = {}
            if (this.externalParams.action === 'similar_equip') {
                if (window.is_pet_equip(this.targetFeatures.kindid)) {
                    // ‰ΩøÁî®Vuex store‰∏≠ÁöÑÊúçÂä°Âô®Êï∞ÊçÆ
                    search_type = 'search_pet_equip'
                } else if (window.is_lingshi_equip(this.targetFeatures.kindid)) {
                    search_type = 'search_lingshi'
                } else {
                    search_type += '&hide_lingshi=1'
                }
                query = this.genarateEquipmentSearchParams(this.targetFeatures)
            } else {
                search_type = 'search_pet'
                query = this.genaratePetSearchParams()
            }
            const serverData = this.$store.getters.getCurrentServerData
            prefix = `https://xyq.cbg.163.com/cgi-bin/recommend.py?callback=Request.JSONP.request_map.request_0&_=${new Date().getTime()}&act=recommd_by_role&server_id=${serverData.server_id
                }&areaid=${serverData.areaid}&server_name=${serverData.server_name
                }&page=1&query_order=price%20ASC&view_loc=search_cond&count=15&search_type=${search_type}&`

            let target_url = prefix + qs.stringify(query)
            console.log(target_url, 'target_url')
            this.$api.spider.startPlaywright({
                headless: false,
                target_url
            })
        },
        /**
        * GBKÁºñÁ†ÅÁöÑURLÁºñÁ†Å
        * @param {string} str - Ë¶ÅÁºñÁ†ÅÁöÑÂ≠óÁ¨¶‰∏≤
        * @returns {Promise<string>} - GBKÁºñÁ†ÅÁöÑURLÁºñÁ†ÅÂ≠óÁ¨¶‰∏≤
        */
        encodeGBK(str) {
            if (!str) return ''

            try {
                const gbkBytes = str2gbk(str)
                // Â∞ÜÂ≠óËäÇÊï∞ÁªÑËΩ¨Êç¢‰∏∫URLÁºñÁ†ÅÊ†ºÂºè
                return Array.from(gbkBytes)
                    .map((b) => `%${b.toString(16).toUpperCase().padStart(2, '0')}`)
                    .join('')
            } catch (error) {
                console.warn('GBKÁºñÁ†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®UTF-8ÁºñÁ†Å‰Ωú‰∏∫ÈôçÁ∫ßÊñπÊ°à:', error)
                // ÈôçÁ∫ßÂà∞UTF-8ÁºñÁ†Å
                return window.encodeURI(str)
            }
        },
        async loadExternalParams() {
            if (this.externalParams.activeTab) {
                this.activeTab = this.externalParams.activeTab
            }
            if (this.externalParams.equip_type) {
                this.equipForm.equip_type = this.externalParams.equip_type
            }
        },
        // Âø´ÈÄüÈÖçÁΩÆÊñπÊ≥ï - Ê†πÊçÆÂΩìÂâçactiveTabÈÖçÁΩÆ
        quickConfig(size) {
            const configs = {
                small: { max_pages: 10, delay_min: 10, delay_max: 15 },
                medium: { max_pages: 50, delay_min: 15, delay_max: 20 },
                large: { max_pages: 100, delay_min: 20, delay_max: 30 }
            }
            const system = configs[size]
            Object.assign(this.globalSettings, system)
            // ÂêåÊ≠•Êõ¥Êñ∞ÊªëÂùóÂÄº
            this.delayRange = [this.globalSettings.delay_min, this.globalSettings.delay_max]
        },

        // Âª∂ËøüËåÉÂõ¥ÊªëÂùóÂèòÂåñÂ§ÑÁêÜ
        onDelayRangeChange(value) {
            this.globalSettings.delay_min = value[0]
            this.globalSettings.delay_max = value[1]
        },
        async loadEquipConfig() {
            const response = await this.$api.equipment.getEquipConfig()
            this.equipConfig = response.data
            if (this.targetFeatures.suit_effect) {
                this.suit_effect_type = ''
            }
        },
        async loadHotServers() {
            try {
                const response = await this.$api.system.getHotServers()
                this.hotServers = response
                console.log('ÁÉ≠Èó®ÊúçÂä°Âô®Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', this.hotServers)

                // Âú®ÁÉ≠Èó®ÊúçÂä°Âô®Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåÂ§ÑÁêÜÂèØËÉΩÂ∑≤Â≠òÂú®ÁöÑtarget_server_list
                if (this.target_server_list && this.target_server_list.length > 0) {
                    this.onTargetServerChange(this.target_server_list)
                }

                // Â¶ÇÊûúÂ§öÊúçÂä°Âô®Ê®°ÂºèÂ∑≤ÂºÄÂêØÔºåËá™Âä®ËÆæÁΩÆÂêåÁ∫ßÂà´ÊúçÂä°Âô®
                if (this.globalSettings.multi && this.externalParams.serverid) {
                    const server_id = Number(this.externalParams.serverid)
                    console.log('Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéÔºåËá™Âä®ËÆæÁΩÆÂ§öÊúçÂä°Âô®Ê®°ÂºèÁöÑÁõÆÊ†áÊúçÂä°Âô®:', server_id)
                    this.setTargetServersByLevel(server_id)
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁÉ≠Èó®ÊúçÂä°Âô®Êï∞ÊçÆÂ§±Ë¥•:', error)
                this.$notify.error('Âä†ËΩΩÁÉ≠Èó®ÊúçÂä°Âô®Êï∞ÊçÆÂ§±Ë¥•: ' + error.message)
            }
        },
        // Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆ
        async loadSearchParams() {
            try {
                this.paramsLoading = true
                const response = await this.$api.system.getSearchParams()

                if (response.code === 200) {
                    // Êõ¥Êñ∞ÈªòËÆ§ÂèÇÊï∞
                    this.defaultParams = {
                        role: response.data.role || {},
                        equip_normal: response.data.equip_normal || {},
                        equip_lingshi: response.data.equip_lingshi || {},
                        equip_pet: response.data.equip_pet || {},
                        equip_pet_equip: response.data.equip_pet_equip || {},
                        pet: response.data.pet || {}
                    }

                    // ÂàùÂßãÂåñJSONÁºñËæëÂô®
                    this.initializeDefaultParams()
                } else {
                    this.$notify.error(response.message || 'Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•')
                    // ‰ΩøÁî®ÈªòËÆ§ÂÄº
                    this.initializeDefaultParams()
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•:', error)
                this.$notify.error('Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•: ' + error.message)
                // ‰ΩøÁî®ÈªòËÆ§ÂÄº
                this.initializeDefaultParams()
            } finally {
                this.paramsLoading = false
            }
        },

        // ÂàùÂßãÂåñÈªòËÆ§ÂèÇÊï∞
        initializeDefaultParams() {
            this.roleParamsJson = JSON.stringify(this.defaultParams.role, null, 2)
            // Ê†πÊçÆÂΩìÂâçË£ÖÂ§áÁ±ªÂûãÂàùÂßãÂåñË£ÖÂ§áÂèÇÊï∞
            const equipParamKey = this.getEquipParamKey(this.equipForm.equip_type)
            this.equipParamsJson = JSON.stringify(this.defaultParams[equipParamKey], null, 2)
            this.petParamsJson = JSON.stringify(this.defaultParams.pet, null, 2)
        },
        // PlaywrightÊî∂ÈõÜÁõ∏ÂÖ≥ÊñπÊ≥ï
        onHeadlessToggle(headless) {
            if (headless) {
                this.$notify.info({
                    title: 'Êó†Â§¥Ê®°Âºè',
                    message: 'ÊµèËßàÂô®Â∞ÜÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÊòæÁ§∫ÁïåÈù¢'
                })
            } else {
                this.$notify.info({
                    title: 'ÊúâÂ§¥Ê®°Âºè',
                    message: 'ÊµèËßàÂô®Â∞ÜÊòæÁ§∫ÁïåÈù¢ÔºåÂèØ‰ª•ÁúãÂà∞Êìç‰ΩúËøáÁ®ã'
                })
            }
        },

        onTargetUrlChange(value) {
            if (value === 'custom') {
                this.playwrightForm.custom_url = ''
            }
        },

        onEquipTypeChange() {
            // Ë£ÖÂ§áÁ±ªÂûãÊîπÂèòÊó∂ÂàáÊç¢ÂØπÂ∫îÁöÑÈªòËÆ§ÂèÇÊï∞
            this.resetParam('equip')
        },

        // Ëé∑ÂèñË£ÖÂ§áÂèÇÊï∞ÈîÆ
        getEquipParamKey(equipType) {
            const paramKeyMap = {
                normal: 'equip_normal',
                lingshi: 'equip_lingshi',
                pet: 'equip_pet_equip'  // ‰øÆÂ§çÔºöÂÆ†Áâ©Ë£ÖÂ§áÂ∫îËØ•‰ΩøÁî®equip_pet_equip
            }
            return paramKeyMap[equipType] || 'equip_normal'
        },

        // ÈÄöÁî®ÂèÇÊï∞Êìç‰ΩúÊñπÊ≥ï
        getParamConfig(type) {
            return this.paramManager[type]
        },

        // È™åËØÅÊåáÂÆöÁ±ªÂûãÁöÑÂèÇÊï∞
        validateParam(type) {
            const config = this.getParamConfig(type)
            if (!config) return false

            this[config.errorKey] = this.validateJson(this[config.jsonKey], type)
            return !this[config.errorKey]
        },

        // ÈáçÁΩÆÂèÇÊï∞ÊñπÊ≥ï - Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÂèÇÊï∞ÈáçÁΩÆ
        resetParam(type) {
            const config = this.getParamConfig(type)
            if (!config) return

            const paramKey = config.getParamType ? config.getParamType() : config.paramType
            this[config.jsonKey] = JSON.stringify(this.defaultParams[paramKey], null, 2)
            this[config.errorKey] = ''
        },

        // ‰øùÂ≠òÂèÇÊï∞ÊñπÊ≥ï - Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÂèÇÊï∞‰øùÂ≠ò
        async saveParam(type) {
            const config = this.getParamConfig(type)
            if (!config) return false

            // Ê£ÄÊü•JSONÈîôËØØ
            if (!this.validateParam(type)) {
                this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
                return false
            }

            this[config.savingKey] = true
            try {
                const params = JSON.parse(this[config.jsonKey])
                const paramType = config.getParamType ? config.getParamType() : config.paramType
                const response = await this.$api.system.updateSearchParam(paramType, params)

                if (response.code === 200) {
                    const successMessage = config.getSuccessMessage ? config.getSuccessMessage() : config.successMessage
                    this.$notify.success(successMessage)
                    // Êõ¥Êñ∞Êú¨Âú∞ÈªòËÆ§ÂèÇÊï∞
                    this.defaultParams[paramType] = params
                    return true
                } else {
                    this.$notify.error({
                        title: '‰øùÂ≠òÂ§±Ë¥•',
                        message: response.message || '‰øùÂ≠òÂ§±Ë¥•'
                    })
                    return false
                }
            } catch (error) {
                console.error(`‰øùÂ≠ò${type}ÂèÇÊï∞Â§±Ë¥•:`, error)
                this.$notify.error({
                    title: '‰øùÂ≠òÂ§±Ë¥•',
                    message: '‰øùÂ≠òÂ§±Ë¥•: ' + error.message
                })
                return false
            } finally {
                this[config.savingKey] = false
            }
        },

        // JSONÈ™åËØÅÊñπÊ≥ï - Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑJSONÈ™åËØÅ
        validateJson(jsonStr, type) {
            try {
                if (!jsonStr.trim()) {
                    return `${type}ÂèÇÊï∞‰∏çËÉΩ‰∏∫Á©∫`
                }
                const parsed = JSON.parse(jsonStr)
                if (typeof parsed !== 'object' || parsed === null) {
                    return 'JSONÂøÖÈ°ªÊòØ‰∏Ä‰∏™ÂØπË±°'
                }
                return ''
            } catch (e) {
                return `JSONÊ†ºÂºèÈîôËØØ: ${e.message}`
            }
        },



        // Âä†ËΩΩÁºìÂ≠òÂèÇÊï∞
        async loadCachedParams() {
            try {
                await this.loadSearchParams()
                this.$notify.success({
                    title: 'ÁºìÂ≠òÂèÇÊï∞',
                    message: 'ÁºìÂ≠òÂèÇÊï∞Â∑≤Âà∑Êñ∞'
                })
            } catch (error) {
                this.$notify.error({
                    title: 'Ëé∑ÂèñÂ§±Ë¥•',
                    message: 'Ëé∑ÂèñÁºìÂ≠òÂèÇÊï∞Â§±Ë¥•: ' + error.message
                })
            }
        },

        // ÈÄöÁî®ÂêØÂä®Áà¨Ëô´ÊñπÊ≥ï
        async startSpiderByType(type) {
            if (this.isRunning) return

            const config = this.paramManager[type]
            if (!config) return

            // Ê£ÄÊü•JSONÈîôËØØ
            if (this[config.errorKey]) {
                this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
                return
            }

            try {
                const params = config.getParams()
                const response = await this.$api.spider[`start${config.spiderType.charAt(0).toUpperCase() + config.spiderType.slice(1)}`](params)

                if (response.code === 200) {
                    this.$notify.success({
                        title: 'Áà¨Ëô´ÂêØÂä®',
                        message: `${config.spiderName}Â∑≤ÂêØÂä®`
                    })
                    this.activeTab = type // Á°Æ‰øùÂàáÊç¢Âà∞ÂØπÂ∫îtab
                    this.isRunning = true // Á´ãÂç≥ËÆæÁΩÆËøêË°åÁä∂ÊÄÅ
                } else {
                    this.$notify.error({
                        title: 'ÂêØÂä®Â§±Ë¥•',
                        message: response.message || 'ÂêØÂä®Â§±Ë¥•'
                    })
                }
            } catch (error) {
                this.$notify.error({
                    title: 'ÂêØÂä®Â§±Ë¥•',
                    message: 'ÂêØÂä®Â§±Ë¥•: ' + error.message
                })
            }
        },



        // ÂêØÂä®PlaywrightÊî∂ÈõÜ
        async startPlaywrightCollector() {
            if (this.isRunning) return

            try {
                const params = {
                    headless: this.playwrightForm.headless
                    // ‰∏ç‰º†ÈÄítarget_urlÔºå‰ΩøÁî®ÂêéÁ´ØÈªòËÆ§ÂÄº
                }

                console.log('ÂêØÂä®PlaywrightÊî∂ÈõÜÔºåÂèÇÊï∞:', params)

                const response = await this.$api.spider.startPlaywright(params)
                if (response.code === 200) {
                    this.$notify.success('PlaywrightÊî∂ÈõÜÂ∑≤ÂêØÂä®')
                    this.activeTab = 'playwright'
                    this.isRunning = true
                } else {
                    this.$notify.error(response.message || 'ÂêØÂä®Â§±Ë¥•')
                }
            } catch (error) {
                this.$notify.error('ÂêØÂä®Â§±Ë¥•: ' + error.message)
            }
        },

        // Ëé∑ÂèñË£ÖÂ§áÁ±ªÂûãÂêçÁß∞
        getEquipTypeName(type) {
            const names = {
                normal: 'ÊôÆÈÄöË£ÖÂ§á',
                lingshi: 'ÁÅµÈ•∞Ë£ÖÂ§á',
                pet: 'ÂÆ†Áâ©Ë£ÖÂ§á'
            }
            return names[type] || 'Ë£ÖÂ§á'
        },
        // Ê£ÄÊü•‰ªªÂä°Áä∂ÊÄÅ
        async checkTaskStatus() {
            try {
                const response = await this.$api.spider.getStatus()
                if (response.code === 200) {
                    const status = response.data.status

                    // Êõ¥Êñ∞ËøêË°åÁä∂ÊÄÅ
                    this.isRunning = (status === 'running')

                    // Â¶ÇÊûú‰ªªÂä°ÂÆåÊàêÊàñÂá∫ÈîôÔºåÊòæÁ§∫Ê∂àÊÅØÂπ∂ÂÅúÊ≠¢ÁõëÊéß
                    if (status === 'completed' || status === 'error' || status === 'stopped') {
                        if (status === 'error') {
                            this.$notify.error(response.data.message || '‰ªªÂä°ÊâßË°åÂá∫Èîô')
                        } else if (status === 'stopped') {
                            this.$notify.info(response.data.message || '‰ªªÂä°Â∑≤ÂÅúÊ≠¢')
                        }
                        this.isRunning = false
                    }
                }
            } catch (error) {
                console.error('Áä∂ÊÄÅÁõëÊéßÈîôËØØ:', error)
            }
        },
        // Áä∂ÊÄÅÁõëÊéßÊñπÊ≥ï
        startStatusMonitor() {
            // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÂÆöÊó∂Âô®
            this.stopStatusMonitor()

            // ÂêØÂä®Áä∂ÊÄÅÁõëÊéßÂÆöÊó∂Âô®
            this.statusMonitor = setInterval(async () => {
                await this.checkTaskStatus()
            }, 5000) // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°Áä∂ÊÄÅ
        },
        stopStatusMonitor() {
            if (this.statusMonitor) {
                clearInterval(this.statusMonitor)
                this.statusMonitor = null
            }
        },
    }
}
</script>

<style scoped>
.auto-params-view {}

/* ÂèÇÊï∞ÁºñËæëÂô®Ê†∑Âºè */
.params-editor {
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 6px;
    margin: 15px 0;
    border-left: 4px solid #409eff;
}

.params-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e4e7ed;
}

.json-editor-wrapper {
    position: relative;
    width: 100%;
}

.json-editor {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
}

.json-editor textarea {
    background-color: #2d3748;
    color: #e2e8f0;
    border: 1px solid #4a5568;
    border-radius: 4px;
    padding: 12px;
}

.json-editor textarea:focus {
    border-color: #409eff;
    box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
}

.json-error {
    margin-top: 8px;
    padding: 8px 12px;
    background-color: #fef0f0;
    border: 1px solid #fbc4c4;
    border-radius: 4px;
    color: #f56c6c;
    font-size: 12px;
    line-height: 1.4;
}

.json-error i {
    margin-right: 4px;
}
</style>