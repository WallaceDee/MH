<template>
  <div class="role-list">
    <el-card class="filters" shadow="never">
      <div slot="header" class="card-header">
        <div><span class="emoji-icon">üîç</span> Á≠õÈÄâ</div>
      </div>
      <el-form :model="searchForm" class="search-form" :inline="true">
        <el-form-item label="ÈÄâÊã©Êúà‰ªΩ">
          <el-date-picker v-model="searchForm.selectedDate" :clearable="false" type="month" placeholder="ÈÄâÊã©Êúà‰ªΩ"
            format="yyyy-MM" value-format="yyyy-MM" @change="handleDateChange" />
        </el-form-item>
        <el-form-item label="‰∫∫Áâ©Á≠âÁ∫ß">
          <el-input-number :controls="false" v-model="searchForm.level_min" :min="0" :max="175" style="width: 60px"
            size="mini" @change="handleLevelChange" />
          <span class="mx-2">-</span>
          <el-input-number :controls="false" v-model="searchForm.level_max" :min="0" :max="175" style="width: 60px"
            size="mini" @change="handleLevelChange" />
          <div class="level-quick-select">
            <el-tag size="mini" v-for="level in [109, 129, 155, 159, 175]" :key="level" :effect="getLevelEffect(level)"
              @click="handleQuickLevelSelect(level)" style="cursor: pointer;margin-right: 4px;">
              {{ level }}Á∫ß
            </el-tag>
          </div>
        </el-form-item>
        <el-form-item label="Áâ©ÂìÅÊï∞Èáè‚â§">
          <el-input v-model.number="searchForm.equip_num" style="width: 60px" clearable />
        </el-form-item>
        <el-form-item label="ÂÆ†Áâ©Êï∞Èáè‚â§">
          <el-input v-model.number="searchForm.pet_num" style="width: 60px" clearable />
        </el-form-item>
        <el-form-item label="ÂÆ†Áâ©Á≠âÁ∫ß‚â•">
          <el-input v-model.number="searchForm.pet_num_level" style="width: 60px" clearable />
        </el-form-item>
        <el-form-item label="Êé•ÂèóËøò‰ª∑">
          <el-checkbox v-model="searchForm.accept_bargain" true-label="1" false-label="" />
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="handleSearch">ÊêúÁ¥¢</el-button>
          <el-button @click="handleReset">ÈáçÁΩÆ</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    <el-checkbox-group v-model="checkedList">
      <el-table ref="roleTable" v-loading="loading" :data="stickyRoleList.concat(tableData)"
        style="width: 100%;border: 1px solid #9ea0bf;" stripe @sort-change="handleSortChange">
        <!-- Âü∫Êú¨‰ø°ÊÅØ -->
        <el-table-column width="110" align="center" fixed="left">
          <template #header>
            <el-link :underline="false" v-if="stickyRoleList.length > 0" href="javascript:void(0);"
              @click.native="clearAllStickyRoles" class="cell"
              style="font-size: 12px;font-weight: bold;color: #909399;white-space: nowrap;">ÊâπÈáèËß£ÈîÅ ({{
                stickyRoleList.length }})</el-link>
          </template>
          <template slot-scope="scope">
            <div class="sticky-wrapper">
              <RoleImage :key="scope.row.eid" :other_info="scope.row.other_info" :roleInfo="scope.row.roleInfo">
              </RoleImage>
              <el-checkbox :label="scope.row.eid" @change="handleSingleCheckboxChange">ÈîÅÂÆö</el-checkbox>
            </div><el-link :href="getCBGLinkByType(scope.row.eid, 'role')" type="danger" target="_blank"
              style="white-space: nowrap;text-overflow: ellipsis;overflow: hidden;display: block;font-size: 12px;"> {{
                scope.row.seller_nickname || scope.row.seller_nickname }}</el-link>
          </template>
        </el-table-column>
        <el-table-column prop="sum_exp" label="Èó®Ê¥æ/Á≠âÁ∫ß/ÁªèÈ™å" width="160" align="center" sortable="custom">
          <template slot-scope="scope">
            <span class="vertical-middle">
              <i class="icon-chai" v-if="scope.row.is_split_independent_role === 1"></i>
              <i class="icon-zheng" v-if="scope.row.is_split_main_role === 1"></i>
              {{ scope.row.server_name }}/
              {{ get_school_name(scope.row.school) }}
            </span>
            <div class="js-level cGray">{{ scope.row.level }}Á∫ß/{{
              scope.row.sum_exp
            }}‰∫ø</div>
          </template>
        </el-table-column>
        <el-table-column prop="highlight" label="‰∫ÆÁÇπ" width="100" align="center" sortable="custom">>
          <template slot-scope="scope">
            <span v-html="gen_highlight(scope.row.highlight)"></span>
          </template>
        </el-table-column>
        <el-table-column prop="dynamic_tags" label="Âä®ÊÄÅ" width="100" align="center" sortable="custom">
          <template slot-scope="scope">
            <span v-html="gen_dynamic_tags(scope.row.dynamic_tags)"></span>
          </template>
        </el-table-column>
        <el-table-column prop="price" label="‰ª∑Ê†º (ÂÖÉ)" width="140" sortable="custom" align="center">
          <template #default="scope">
            <div v-html="formatFullPrice(scope.row)"></div>
            <el-tag v-if="get_price_change(scope.row) !== undefined"
              :type="get_price_change(scope.row) < 0 ? 'danger' : 'success'">
              <i :class="`el-icon-${get_price_change(scope.row) < 0 ? 'bottom' : 'top'}`"
                :style="`color: #${get_price_change(scope.row) < 0 ? 'F56C6C;' : '67C23A'}`">{{
                  get_price_change(scope.row) }}</i>
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column label="‰º∞‰ª∑" width="220" align="center">
          <template #default="scope">
            <div class="role-valuation-cell">
              <div>
                <el-tag>üë§<span v-html="formatFullPriceWithoutPerfix({ price: scope.row.base_price })"
                    style="font-size: 12px;"></span></el-tag>
                <el-tag v-if="get_equip_num(scope.row.roleInfo) > 0">‚öîÔ∏è<span
                    v-html="formatFullPriceWithoutPerfix({ price: scope.row.equip_price })"
                    style="font-size: 12px;"></span></el-tag>
                <el-tag v-if="get_pet_num(scope.row.roleInfo) > 0">üê≤<span
                    v-html="formatFullPriceWithoutPerfix({ price: scope.row.pet_price })"
                    style="font-size: 12px;"></span></el-tag>
              </div>
              <el-tag type="success">ÊÄª‰º∞‰ª∑Ôºö
                <span
                  v-html="formatFullPriceWithoutPerfix({ price: scope.row.base_price + scope.row.equip_price + scope.row.pet_price })"
                  style="font-size: 12px;"></span></el-tag>
            </div>
          </template>
        </el-table-column>
        <el-table-column label="Ë£ÖÂ§á‰º∞‰ª∑" width="120" align="center">
          <template #default="scope">
            <SimilarRoleModal :role="scope.row" :similar-data="roleSimilarData"
              @show="loadSimilarRoles($event, scope.$index)">
              <div> <el-link type="primary" href="javascript:void(0)">üë§ Ë£∏Âè∑</el-link></div>
            </SimilarRoleModal>
            <div v-if="get_equip_num(scope.row.roleInfo) > 0"> <el-link
                @click.native="handleEquipPrice(scope.row, scope.$index)" type="primary" href="javascript:void(0)">‚öîÔ∏è {{
                  get_equip_num(scope.row.roleInfo) }}‰ª∂</el-link></div>
            <el-link v-if="get_pet_num(scope.row.roleInfo) > 0"
              @click.native="handlSummonePrice(scope.row, scope.$index)" type="primary" href="javascript:void(0)">üê≤ {{
                get_pet_num(scope.row.roleInfo) }}Âè™
            </el-link>
          </template>
        </el-table-column>
        <el-table-column prop="history_price" label="ÂéÜÂè≤‰ª∑Ê†º" width="120" align="center" sortable="custom">
          <template slot-scope="scope">
            <div v-for="(history, index) in JSON.parse(scope.row.history_price)" :key="index" :title="history.timestamp"
              v-html="formatFullPrice(history.price, true)"
              style="text-decoration: line-through;filter: grayscale(100%);"></div>
          </template>
        </el-table-column>
        <el-table-column prop="accept_bargain" label="Ëøò‰ª∑" width="80" align="center" sortable="custom">
          <template slot-scope="scope">
            <el-tag type="success" v-if="scope.row.accept_bargain == 1">Êé•Âèó</el-tag>
            <el-tag type="danger" v-else>ÊãíÁªù</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="collect_num" label="Êî∂Ëóè" width="80" align="center" sortable="custom">
        </el-table-column>
        <!-- ‰øÆÁÇº‰ø°ÊÅØ -->
        <el-table-column label="‰øÆÁÇº/ÊéßÂà∂Âäõ" min-width="400" align="center">
          <template slot-scope="scope">
            <el-tag v-for="xiulian in scope.row.roleInfo.role_xiulian" :key="xiulian.name">{{ xiulian.name.replace('‰øÆÁÇº',
              '') }}{{ xiulian.info }}</el-tag>
            <br>
            <el-tag v-for="ctrl_skill in scope.row.roleInfo.pet_ctrl_skill" :key="ctrl_skill.name">{{ ctrl_skill.name
            }}{{
                ctrl_skill.grade }}</el-tag>
          </template>
        </el-table-column>
        <!-- Êó∂Èó¥‰ø°ÊÅØ -->
        <el-table-column prop="update_time" label="ÂàõÂª∫„ÄÅÊõ¥Êñ∞" width="200">
          <template slot-scope="scope">
            <el-tag type="info">{{ scope.row.create_time }}</el-tag>
            <el-tag>{{ scope.row.update_time }}</el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="server" label="Êìç‰Ωú" width="100" fixed="right">
          <template slot-scope="scope">
            <el-link href="javascript:void(0)" type="danger" @click.native="handleDelete(scope.row)">Âà†Èô§</el-link>
            <el-link v-if="roleType === 'normal'" type="primary" href="javascript:void(0)"
              @click.native="changeRoleType(scope.row)">ËΩ¨‰∏∫ÈîöÁÇπ</el-link>
            <el-link v-else type="primary" href="javascript:void(0)"
              @click.native="changeRoleType(scope.row)">ÁßªÈô§ÈîöÁÇπ</el-link>
          </template>
        </el-table-column>
      </el-table>
    </el-checkbox-group>
    <div class="pagination-container">
      <el-pagination :current-page.sync="currentPage" :page-size.sync="pageSize" :total="total"
        :page-sizes="[10, 20, 50, 100]" layout="total, sizes, prev, pager, next" @size-change="handleSizeChange"
        @current-change="handleCurrentChange" />
    </div>

    <!-- Ë£ÖÂ§á‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü -->
    <el-dialog :visible.sync="valuationDialogVisible" width="1000px" :close-on-click-modal="false"
      :close-on-press-escape="false" custom-class="batch-valuation-dialog">
      <span slot="title" class="el-dialog__title">
        <el-tag size="mini">{{ valuationDialogTitle.server_name }}</el-tag>
        /
        <el-tag type="info" size="mini">{{ valuationDialogTitle.school }}</el-tag>/
        <el-link :href="getCBGLinkByType(valuationDialogTitle.eid)" target="_blank">{{ valuationDialogTitle.nickname
        }}</el-link>
      </span>
      <EquipBatchValuationResult :results="valuationResults" :total-value="valuationTotalValue"
        :equipment-list="valuationEquipmentList" :valuate-params="batchValuateParams" :loading="valuationLoading"
        @close="closeValuationDialog" />
    </el-dialog>

    <!-- ÂÆ†Áâ©‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü -->
    <el-dialog :visible.sync="petValuationDialogVisible" width="900px" :close-on-click-modal="false"
      :close-on-press-escape="false" custom-class="batch-valuation-dialog">
      <span slot="title" class="el-dialog__title">
        <el-tag size="mini">{{ petValuationDialogTitle.server_name }}</el-tag>
        /
        <el-tag type="info" size="mini">{{ petValuationDialogTitle.school }}</el-tag>/
        <el-link :href="getCBGLinkByType(petValuationDialogTitle.eid)" target="_blank">{{
          petValuationDialogTitle.nickname
        }}</el-link>
      </span>
      <PetBatchValuationResult :results="petValuationResults" :total-value="petValuationTotalValue"
        :pet-list="petValuationList" :valuate-params="batchValuateParams" :loading="petValuationLoading"
        @close="closePetValuationDialog" />
    </el-dialog>
  </div>
</template>

<script>
import dayjs from 'dayjs'
import EquipBatchValuationResult from '@/components/EquipBatchValuationResult.vue'
import PetBatchValuationResult from '@/components/PetBatchValuationResult.vue'
import SimilarRoleModal from '@/components/SimilarRoleModal.vue'
import RoleImage from '@/components/RoleInfo/RoleImage.vue'
import { commonMixin } from '@/utils/mixins/commonMixin'
export default {
  name: 'RoleList',
  mixins: [commonMixin],
  components: {
    RoleImage,
    EquipBatchValuationResult,
    PetBatchValuationResult,
    SimilarRoleModal
  },
  computed: {
    roleType() {
      return this.$route.params.type || 'normal'
    }
  },
  watch: {
    roleType() {
      this.currentPage = 1

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: this.$route.params.levelRange
      }

      this.$router.replace({
        name: 'RoleList',
        params: newParams
      })

      this.fetchData()
    },

    // ÁõëÂê¨Ë∑ØÁî±ÂèÇÊï∞ÂèòÂåñÔºåÂêåÊ≠•Êõ¥Êñ∞Ë°®Âçï
    '$route.params.levelRange': {
      handler(newLevelRange) {
        if (newLevelRange) {
          const [min, max] = newLevelRange.split(',').map(Number)
          if (!isNaN(min) && !isNaN(max)) {
            this.searchForm.level_min = min
            this.searchForm.level_max = max
          }
        } else {
          // ÂΩìË∑ØÁî±ÂèÇÊï∞‰∏∫ undefined Êó∂ÔºåÊ∏ÖÁ©∫Ë°®ÂçïÁ≠âÁ∫ß
          this.searchForm.level_min = undefined
          this.searchForm.level_max = undefined
        }
      },
      immediate: true
    },

    // ÁõëÂê¨Ë∑ØÁî±ÂèÇÊï∞ÂèòÂåñÔºåÂêåÊ≠•Êõ¥Êñ∞È°µÁ†Å
    '$route.params.page': {
      handler(newPage) {
        if (newPage) {
          const pageNum = parseInt(newPage)
          if (!isNaN(pageNum) && pageNum > 0) {
            this.currentPage = pageNum
          } else {
            this.currentPage = 1
          }
        } else {
          this.currentPage = 1
        }
      },
      immediate: true
    },

    // ÁõëÂê¨Ë∑ØÁî±queryÂèÇÊï∞ÂèòÂåñÔºåÂêåÊ≠•Êõ¥Êñ∞ÊêúÁ¥¢Ë°®ÂçïÂíåÊéíÂ∫èÁä∂ÊÄÅ
    '$route.query': {
      handler(newQuery) {
        // ÂêåÊ≠•ÊêúÁ¥¢Ë°®ÂçïÂèÇÊï∞
        if (newQuery.selectedDate) {
          this.searchForm.selectedDate = newQuery.selectedDate
        }
        if (newQuery.equip_num !== undefined) {
          this.searchForm.equip_num = newQuery.equip_num ? parseInt(newQuery.equip_num) : undefined
        }
        if (newQuery.pet_num !== undefined) {
          this.searchForm.pet_num = newQuery.pet_num ? parseInt(newQuery.pet_num) : undefined
        }
        if (newQuery.pet_num_level !== undefined) {
          this.searchForm.pet_num_level = newQuery.pet_num_level ? parseInt(newQuery.pet_num_level) : undefined
        }
        if (newQuery.accept_bargain !== undefined) {
          this.searchForm.accept_bargain = newQuery.accept_bargain
        }

        // ÂêåÊ≠•ÊéíÂ∫èÂèÇÊï∞
        if (newQuery.sort_by && newQuery.sort_order) {
          const sortFields = newQuery.sort_by.split(',')
          const sortOrders = newQuery.sort_order.split(',')

          // Ê∏ÖÁ©∫ÂΩìÂâçÊéíÂ∫èÁä∂ÊÄÅ
          this.sortState = {}

          // ÈáçÊñ∞ËÆæÁΩÆÊéíÂ∫èÁä∂ÊÄÅ
          sortFields.forEach((field, index) => {
            const order = sortOrders[index]
            if (order === 'ASC') {
              this.sortState[field] = 'ascending'
            } else if (order === 'DESC') {
              this.sortState[field] = 'descending'
            }
          })

          // Êõ¥Êñ∞searchForm‰∏≠ÁöÑÊéíÂ∫èÂèÇÊï∞
          this.$set(this.searchForm, 'sort_by', newQuery.sort_by)
          this.$set(this.searchForm, 'sort_order', newQuery.sort_order)
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÊéíÂ∫èÂèÇÊï∞ÔºåÊ∏ÖÁ©∫ÊéíÂ∫èÁä∂ÊÄÅ
          this.sortState = {}
          this.$set(this.searchForm, 'sort_by', undefined)
          this.$set(this.searchForm, 'sort_order', undefined)
        }
      },
      immediate: true
    }
  },
  data() {
    return {
      roleSimilarData: null,
      valuationDialogTitle: {
        nickname: '',
        school: '',
        server_name: '',
        eid: ''
      },
      stickyRoleList: [],
      checkedList: [],
      valuationLoading: false,
      batchValuateParams: {
        similarity_threshold: 0.8,
        max_anchors: 30,
        serverid: undefined,
        server_name: undefined
      },
      valuationResults: [],
      valuationTotalValue: 0,
      valuationEquipmentList: [],
      valuationDialogVisible: false,
      // ÂÆ†Áâ©‰º∞‰ª∑Áõ∏ÂÖ≥
      petValuationResults: [],
      petValuationTotalValue: 0,
      petValuationList: [],
      petValuationDialogVisible: false,
      petValuationLoading: false,
      petValuationDialogTitle: {
        nickname: '',
        school: '',
        server_name: '',
        eid: ''
      },
      // ËßíËâ≤‰º∞‰ª∑Áõ∏ÂÖ≥
      loadingStates: {}, // Áî®‰∫éÊéßÂà∂ÂêÑ‰∏™Êìç‰ΩúÁöÑÂä†ËΩΩÁä∂ÊÄÅ
      loading: false,
      tableData: [],
      currentPage: 1,
      pageSize: 10,
      total: 0,
      searchForm: {
        selectedDate: dayjs().format('YYYY-MM'),
        level_min: undefined,
        level_max: undefined,
        equip_num: undefined,
        pet_num: undefined,
        pet_num_level: undefined,
        sort_by: undefined,
        sort_order: undefined,
        accept_bargain: undefined
      },
      activeCollapse: [],
      sortState: {
        price: null,
        level: null,
        create_time: null
      }
    }
  },

  mounted() {
    const originalGetHeaderCellClass = this.$refs.roleTable.$refs.tableHeader.getHeaderCellClass
    this.$refs.roleTable.$refs.tableHeader.getHeaderCellClass = (rowIndex, columnIndex, row, column) => {
      let classes = originalGetHeaderCellClass(rowIndex, columnIndex, row, column)
      if (this.sortState[column.property]) {
        classes += ' ' + this.sortState[column.property]
      }
      return classes
    }

    // ‰ªélocalStorageÂä†ËΩΩÈîÅÂÆöÁöÑËßíËâ≤ÂàóË°®
    this.loadStickyRoleList()

    this.fetchData()
  },

  beforeDestroy() {
    // È°µÈù¢Âç∏ËΩΩÂâç‰øùÂ≠òÊï∞ÊçÆÂà∞localStorage
    this.saveStickyRoleList()
  },

  methods: {
    formatFullPriceWithoutPerfix(item) {
      return this.formatFullPrice(item, true).replace('Ôø•', '').replace('-', '???')
    },
    // Ê£ÄÊü•Ë∑ØÁî±ÂèÇÊï∞ÊòØÂê¶ÊúâÂèòÂåñÁöÑÂ∑•ÂÖ∑ÊñπÊ≥ï
    hasRouteChanges(newParams, newQuery = null) {
      const hasParamChanges = JSON.stringify(newParams) !== JSON.stringify(this.$route.params)
      if (newQuery) {
        const hasQueryChanges = JSON.stringify(newQuery) !== JSON.stringify(this.$route.query)
        return hasParamChanges || hasQueryChanges
      }
      return hasParamChanges
    },

    // ÂÆâÂÖ®Êõ¥Êñ∞Ë∑ØÁî±ÁöÑÊñπÊ≥ï
    safeRouteUpdate(newParams, newQuery = null) {
      if (this.hasRouteChanges(newParams, newQuery)) {
        this.$router.replace({
          name: this.$route.name,
          params: newParams,
          query: newQuery || this.$route.query
        })
      }
    },

    get_price_change({ price, history_price }) {
      const history_price_list = JSON.parse(history_price).map(item => item.price)
      if (history_price_list.length === 0) return
      const max_price = Math.max(...history_price_list)
      return (price - max_price) / 100
    },
    // ‰øùÂ≠òÈîÅÂÆöÁöÑËßíËâ≤ÂàóË°®Âà∞localStorage
    saveStickyRoleList() {
      try {
        // ÂÖ®Èáè‰øùÂ≠òÊï∞ÊçÆÔºåÂåÖÊã¨ÊâÄÊúâËßíËâ≤‰ø°ÊÅØ
        const stickyData = this.stickyRoleList.map(item => {
          // Ê∑±Êã∑Ë¥ùÂØπË±°ÔºåÈÅøÂÖçÂºïÁî®ÈóÆÈ¢ò
          const fullData = JSON.parse(JSON.stringify(item))
          // Ê∑ªÂä†Êó∂Èó¥Êà≥
          fullData.timestamp = Date.now()
          return fullData
        })

        localStorage.setItem('cbg_sticky_role_list', JSON.stringify(stickyData))
        console.log('ÈîÅÂÆöËßíËâ≤ÂàóË°®Â∑≤ÂÖ®Èáè‰øùÂ≠òÂà∞localStorage:', stickyData.length)
      } catch (error) {
        console.error('‰øùÂ≠òÈîÅÂÆöËßíËâ≤ÂàóË°®Â§±Ë¥•:', error)
      }
    },

    // ‰ªélocalStorageÂä†ËΩΩÈîÅÂÆöÁöÑËßíËâ≤ÂàóË°®
    loadStickyRoleList() {
      try {
        const stored = localStorage.getItem('cbg_sticky_role_list')
        if (stored) {
          const stickyData = JSON.parse(stored)
          // ‰∏∫ÊØè‰∏™ÈîÅÂÆöÁöÑËßíËâ≤Ê∑ªÂä†is_stickyÊ†áËÆ∞
          const processedData = stickyData.map(item => ({
            ...item,
            is_sticky: true
          }))

          this.stickyRoleList = processedData
          // Êõ¥Êñ∞checkedList‰ª•‰øùÊåÅÂ§çÈÄâÊ°ÜÁä∂ÊÄÅÂêåÊ≠•
          this.checkedList = processedData.map(item => item.eid)
          console.log('‰ªélocalStorageÂä†ËΩΩÈîÅÂÆöËßíËâ≤ÂàóË°®:', processedData.length)
        }
      } catch (error) {
        console.error('Âä†ËΩΩÈîÅÂÆöËßíËâ≤ÂàóË°®Â§±Ë¥•:', error)
        // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•ÔºåÊ∏ÖÁ©∫localStorage‰∏≠ÁöÑÊï∞ÊçÆ
        localStorage.removeItem('cbg_sticky_role_list')
        this.stickyRoleList = []
        this.checkedList = []
      }
    },
    handleSingleCheckboxChange(checked, event) {
      const eid = event.target.value || event.target.labels[0].textContent
      if (checked) {
        const currentRow = this.tableData.find(item => item.eid === eid)
        if (currentRow) {
          // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÂ≠òÂú®‰∫éstickyRoleList‰∏≠
          const exists = this.stickyRoleList.find(item => item.eid === eid)
          if (!exists) {
            currentRow.is_sticky = true
            this.stickyRoleList.push(currentRow)
            // this.tableData = this.tableData.filter(item => item.eid !== eid)
            // ‰øùÂ≠òÂà∞localStorage
            this.saveStickyRoleList()

            this.$notify.success({
              title: 'ÈîÅÂÆöÊàêÂäü',
              message: `Â∑≤ÈîÅÂÆöËßíËâ≤: ${currentRow.seller_nickname}`,
              duration: 2000
            })
          }
        }
      } else {
        // ‰ªéstickyRoleList‰∏≠ÁßªÈô§
        this.stickyRoleList = this.stickyRoleList.filter(item => item.eid !== eid)
        // this.tableData.unshift(this.stickyRoleList.find(item => item.eid === eid))
        // ‰øùÂ≠òÂà∞localStorage
        this.saveStickyRoleList()

        // ÊâæÂà∞ÂØπÂ∫îÁöÑËßíËâ≤‰ø°ÊÅØÁî®‰∫éÊèêÁ§∫
        const removedRole = this.tableData.find(item => item.eid === eid)
        if (removedRole) {
          this.$notify.info({
            title: 'Ëß£ÈîÅÊàêÂäü',
            message: `Â∑≤Ëß£ÈîÅËßíËâ≤: ${removedRole.seller_nickname}`,
            duration: 2000
          })
        }
      }
    },

    // ÊâπÈáèËß£ÈîÅÊâÄÊúâÈîÅÂÆöÁöÑËßíËâ≤
    clearAllStickyRoles() {
      this.$confirm('Á°ÆÂÆöË¶ÅËß£ÈîÅÊâÄÊúâÈîÅÂÆöÁöÑËßíËâ≤ÂêóÔºü', 'Á°ÆËÆ§Ëß£ÈîÅ', {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }).then(() => {
        this.stickyRoleList = []
        this.checkedList = []
        // Ê∏ÖÈô§localStorage‰∏≠ÁöÑÊï∞ÊçÆ
        localStorage.removeItem('cbg_sticky_role_list')

        this.$notify.success({
          title: 'ÊâπÈáèËß£ÈîÅÊàêÂäü',
          message: 'Â∑≤Ëß£ÈîÅÊâÄÊúâÈîÅÂÆöÁöÑËßíËâ≤',
          duration: 2000
        })
      }).catch(() => {
        // Áî®Êà∑ÂèñÊ∂àÊìç‰Ωú
      })
    },
    getLevelEffect(level) {
      const [min, max] = this.$route.params.levelRange.split(',').map(Number)
      if (level >= min && level <= max) {
        return 'dark'
      }
      return 'light'
    },
    async changeRoleType(row) {
      try {
        // Á°ÆËÆ§ËΩ¨Áßª
        await this.$confirm(
          `Á°ÆÂÆöË¶ÅËΩ¨ÁßªËßíËâ≤ ${row.seller_nickname} ÂêóÔºü`,
          'Á°ÆËÆ§ËΩ¨Áßª',
          {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        )

        // Ëé∑ÂèñÂΩìÂâçÂπ¥Êúà
        const [year, month] = this.searchForm.selectedDate.split('-')

        // Ë∞ÉÁî®ËΩ¨ÁßªAPI
        const response = await this.$api.role.switchRoleType(row.eid, {
          year,
          month,
          role_type: this.roleType,
          target_role_type: this.roleType === 'empty' ? 'normal' : 'empty'
        })

        if (response.code === 200) {
          this.$notify.success({
            title: 'ÊàêÂäü',
            message: 'ËßíËâ≤ËΩ¨ÁßªÊàêÂäü'
          })
          // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
          await this.fetchData()
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'ËΩ¨ÁßªÂ§±Ë¥•'
          })
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('ËΩ¨ÁßªËßíËâ≤Â§±Ë¥•:', error)
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: 'ËΩ¨ÁßªËßíËâ≤Â§±Ë¥•'
          })
        }
      }
    },
    async handleDelete(row) {
      try {
        // Á°ÆËÆ§Âà†Èô§
        await this.$confirm(
          `Á°ÆÂÆöË¶ÅÂà†Èô§ËßíËâ≤ ${row.seller_nickname} ÂêóÔºü`,
          'Á°ÆËÆ§Âà†Èô§',
          {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        )

        // Ëé∑ÂèñÂΩìÂâçÂπ¥Êúà
        const [year, month] = this.searchForm.selectedDate.split('-')

        // Ë∞ÉÁî®Âà†Èô§API
        const response = await this.$api.role.deleteRole(row.eid, {
          year,
          month,
          role_type: this.roleType
        })

        if (response.code === 200) {
          this.$notify.success({
            title: 'ÊàêÂäü',
            message: 'ËßíËâ≤Âà†Èô§ÊàêÂäü'
          })
          // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
          await this.fetchData()
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'Âà†Èô§Â§±Ë¥•'
          })
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('Âà†Èô§ËßíËâ≤Â§±Ë¥•:', error)
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: 'Âà†Èô§ËßíËâ≤Â§±Ë¥•'
          })
        }
      }
    },
    // ÂÖ≥Èó≠Ë£ÖÂ§á‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü
    closeValuationDialog() {
      this.valuationDialogVisible = false
      this.valuationResults = []
      this.valuationTotalValue = 0
      this.valuationEquipmentList = []
      this.valuationLoading = false
      this.valuationDialogTitle = {
        nickname: '',
        school: '',
        server_name: '',
        eid: ''
      }
    },
    // ÂÖ≥Èó≠ÂÆ†Áâ©‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü
    closePetValuationDialog() {
      this.petValuationDialogVisible = false
      this.petValuationResults = []
      this.petValuationTotalValue = 0
      this.petValuationList = []
      this.petValuationLoading = false
      this.petValuationDialogTitle = {
        nickname: '',
        school: '',
        server_name: '',
        eid: ''
      }
    },
    // ËßíËâ≤‰º∞‰ª∑ÂíåÁõ∏‰ººËßíËâ≤Êï∞ÊçÆÂä†ËΩΩ
    async loadSimilarRoles(role, rowIndex) {
      try {
        this.roleSimilarData = null
        console.log('ËßíËâ≤‰º∞‰ª∑ÂíåÂä†ËΩΩÁõ∏‰ººÊï∞ÊçÆ:', role.eid)
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        this.$set(this.loadingStates, `basePrice_${rowIndex}`, true)
        // Ë∞ÉÁî®ËßíËâ≤‰º∞‰ª∑Êé•Âè£
        const [year, month] = this.searchForm.selectedDate.split('-')
        const response = await this.$api.role.getRoleValuation({
          eid: role.eid,
          year: parseInt(year),
          month: parseInt(month),
          role_type: this.roleType,
          strategy: 'fair_value',
          similarity_threshold: 0.7,
          max_anchors: 30
        })
        if (response.code === 200) {
          const result = response.data
          const estimatedPrice = result.estimated_price_yuan
          // Êõ¥Êñ∞ËßíËâ≤Êï∞ÊçÆ‰∏≠ÁöÑ‰º∞‰ª∑‰ø°ÊÅØÔºàÂêéÁ´ØÂ∑≤Ëá™Âä®Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÔºâ
          this.$set(role, 'base_price', result.estimated_price)

          // Êü•ËØ¢Áõ∏‰ººËßíËâ≤ÈîöÁÇπÊï∞ÊçÆ
          if (result?.anchor_count > 0) {
            try {
              // Ë∞ÉÁî®‰∏ìÈó®ÁöÑÈîöÁÇπÊü•ËØ¢Êé•Âè£
              const anchorsResponse = await this.$api.role.findRoleAnchors({
                eid: role.eid,
                year: parseInt(year),
                month: parseInt(month),
                role_type: this.roleType,
                similarity_threshold: 0.7,
                max_anchors: 30
              })

              if (anchorsResponse.code === 200 && anchorsResponse.data.anchors) {
                const anchorsData = anchorsResponse.data
                const parsedAnchors = anchorsData.anchors.map((item) => {
                  const roleInfo = new window.RoleInfoParser(item.large_equip_desc, { equip_level: item.equip_level })
                  item.RoleInfoParser = roleInfo
                  if (roleInfo.result) {
                    item.roleInfo = roleInfo.result
                  }
                  return item
                })

                // ‰øùÂ≠òÁõ∏‰ººËßíËâ≤Êï∞ÊçÆÔºåÁî®‰∫éÁõ∏‰ººËßíËâ≤Ê®°ÊÄÅÊ°Ü
                this.roleSimilarData = {
                  anchor_count: anchorsData.anchors.length,
                  similarity_threshold: 0.7,
                  max_anchors: 30,
                  anchors: parsedAnchors,
                  statistics: anchorsData.statistics,
                  valuation: {
                    estimated_price_yuan: estimatedPrice,
                    confidence: result.confidence,
                    strategy: result.strategy || 'fair_value'
                  }
                }
              } else {
                console.warn('Êú™Ëé∑ÂèñÂà∞Áõ∏‰ººËßíËâ≤ÈîöÁÇπÊï∞ÊçÆ:', anchorsResponse.message)
              }
            } catch (error) {
              console.error('Êü•ËØ¢Áõ∏‰ººËßíËâ≤ÈîöÁÇπÂ§±Ë¥•:', error)
              // ÈîöÁÇπÊü•ËØ¢Â§±Ë¥•‰∏çÂΩ±Âìç‰º∞‰ª∑ÁªìÊûúÊòæÁ§∫
            }
          }

        } else {
          // ‰º∞‰ª∑Â§±Ë¥•
          this.$notify.error({
            title: 'ËßíËâ≤‰º∞‰ª∑Â§±Ë¥•',
            message: response.message || '‰º∞‰ª∑ËÆ°ÁÆóÂ§±Ë¥•',
            duration: 3000
          })

          // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ
          if (response.data && response.data.error) {
            console.error('‰º∞‰ª∑ÈîôËØØËØ¶ÊÉÖ:', response.data.error)
          }
        }

      } catch (error) {
        console.error('ËßíËâ≤‰º∞‰ª∑Â§±Ë¥•:', error)
        this.$notify.error({
          title: '‰º∞‰ª∑ËØ∑Ê±ÇÂ§±Ë¥•',
          message: 'ÁΩëÁªúËØ∑Ê±ÇÂºÇÂ∏∏ÔºåËØ∑Á®çÂêéÈáçËØï',
          duration: 3000
        })
      } finally {
        // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
        this.$set(this.loadingStates, `basePrice_${rowIndex}`, false)
      }
    },
    async handlSummonePrice(role, rowIndex) {
      const pet_list_desc = [...role.roleInfo.pet_info, ...role.roleInfo.split_pets]
      let pet_list = JSON.parse(role.all_summon_json)
      console.log('pet_list', pet_list)
      if (!pet_list || pet_list.length === 0) {
        this.$notify.warning({
          title: 'ÊèêÁ§∫',
          message: 'Ê≤°ÊúâÂèØ‰º∞‰ª∑ÁöÑÂÆ†Áâ©'
        })
        return
      }
      pet_list = pet_list.map((item) => {
        //TODO:Á≠âÁ∫ß
        const role_grade_limit = window.CBG_GAME_CONFIG.pet_equip_type_to_grade_mapping[item.iType]
        const all_skill = []
        for (var typeid in item.all_skills) {
          all_skill.push('' + typeid)
        }
        // Ê†πÊçÆJavaScriptÈÄªËæëËÆ°ÁÆóevol_skill_list
        const evol_skill_list = this.calculateEvolSkillList(item)
        const texing = JSON.stringify(item.jinjie?.core)
        const lx = item.jinjie?.lx || 0
        const equip_list = []
        for (var i = 0; i < 3; i++) {
          var equip = item['summon_equip' + (i + 1)]
          var equip_info = window.CBG_GAME_CONFIG.equip_info[equip?.iType] || {}
          if (equip) {
            equip_list.push({
              type: equip.iType,
              desc: equip.cDesc,
              name: equip_info.name,
              icon: window.ResUrl + `/images/equip/small/${equip?.iType}.gif`,
              //lock_type: role.RoleInfoParser.get_lock_types(equip),
              static_desc: equip_info.desc?.replace(/#R/g, '<br />')
            })
          } else {
            equip_list.push(null)
          }
        }
        const neidan = []
        if (item.summon_core != undefined) {
          for (var p in item.summon_core) {
            var p_core = item.summon_core[p]
            neidan.push({
              name: window.CBG_GAME_CONFIG.pet_neidans[p] || '',
              level: p_core[0],
              isNeiDan: true
            })
          }
        }
        const pet_detail = pet_list_desc.find(pet => pet.equip_sn === item.equip_sn)
        //Âè¨Âî§ÂÖΩÁâπÂæÅÊèêÂèñÂøÖ‰º†ÂèÇÊï∞
        return {
          pet_detail,
          equip_sn: item.equip_sn,
          role_grade_limit,
          equip_level: item.iGrade,
          growth: item.grow / 1000,
          is_baobao: item.iBaobao == 1 ? 'ÊòØ' : 'Âê¶',
          all_skill: all_skill.join('|'),
          evol_skill_list: JSON.stringify(evol_skill_list),
          sp_skill: pet_detail.genius,
          texing,
          lx,
          equip_list: JSON.stringify(equip_list),
          neidan: JSON.stringify(neidan),
          serverid: role.serverid,
          server_name: role.server_name
        }
      })

      // ËÆæÁΩÆÂÆ†Áâ©‰º∞‰ª∑ÂØπËØùÊ°ÜÊ†áÈ¢ò
      this.petValuationDialogTitle = {
        nickname: role.roleInfo.basic_info.nickname,
        school: role.roleInfo.basic_info.school,
        server_name: role.server_name,
        eid: role.eid
      }

      try {
        // ÂÖàÊòæÁ§∫ÂºπÁ™óÂíåÈ™®Êû∂Â±è
        this.petValuationDialogVisible = true
        this.petValuationLoading = true
        this.petValuationResults = []
        this.petValuationTotalValue = 0
        this.petValuationList = pet_list

        // Ë∞ÉÁî®ÊâπÈáèÂÆ†Áâ©‰º∞‰ª∑API
        const response = await this.$api.pet.batchPetValuation({
          eid: role.eid,
          pet_list: pet_list.map(({ pet_detail, ...item }) => {
            return item
          }),
          strategy: 'fair_value',
          similarity_threshold: this.batchValuateParams.similarity_threshold,
          max_anchors: this.batchValuateParams.max_anchors
        })

        if (response.code === 200) {
          const data = response.data
          const results = data.results || []
          const totalValue = results.reduce((sum, result) => {
            return sum + (result.estimated_price || 0) + (result.equip_estimated_price || 0)
          }, 0)
          this.$set(this.tableData[rowIndex], 'pet_price', data.pet_price)
          // Êõ¥Êñ∞ÂºπÁ™óÂÜÖÂÆπÔºåÊòæÁ§∫ÂÆûÈôÖÊï∞ÊçÆ
          this.petValuationResults = results
          this.petValuationTotalValue = totalValue
          this.petValuationLoading = false
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'ÂÆ†Áâ©‰º∞‰ª∑Â§±Ë¥•'
          })
          this.closePetValuationDialog()
        }
      } catch (error) {
        console.error('ÂÆ†Áâ©‰º∞‰ª∑Â§±Ë¥•:', error)
        this.$notify.error({
          title: 'ÈîôËØØ',
          message: 'ÂÆ†Áâ©‰º∞‰ª∑Â§±Ë¥•'
        })
        this.closePetValuationDialog()
      } finally {
        this.petValuationLoading = false
      }
    },
    calculateEvolSkillList(pet) {
      const evol_skill_list = []

      if (!pet.EvolSkill || !window.CBG_GAME_CONFIG.pet_skill_high_to_other_level_mapping) {
        return evol_skill_list
      }

      // Ëß£ÊûêËøõÂåñÊäÄËÉΩID
      const cifu = pet.EvolSkill.split('|').map(Number)
      const cifuObj = {}
      cifu.forEach(function (number) {
        cifuObj[number] = 1
      })

      const evol_skills = cifuObj
      if (!evol_skills) {
        return evol_skill_list
      }

      const evol_skill_str = []
      for (const typeid in evol_skills) {
        evol_skill_str.push('' + typeid)
      }

      for (let i = 0, max = evol_skill_str.length; i < max; i++) {
        const typeid = evol_skill_str[i]
        const evol_skill_hash = window.CBG_GAME_CONFIG.pet_skill_high_to_other_level_mapping[typeid]

        if (!evol_skill_hash) {
          continue
        }

        const evol_skill_item = {
          skill_type: typeid,
          level: evol_skills[typeid],
          evol_type: typeid
        }

        if (pet.all_skills) {
          const isHighSkill = pet.all_skills[String(evol_skill_hash.high_skill)]
          const isLowSkill = pet.all_skills[String(evol_skill_hash.low_skill)]

          if (isHighSkill || isLowSkill) {
            evol_skill_item.hlightLight = true
            if (!isHighSkill) {
              evol_skill_item.evol_type = evol_skill_hash.low_skill
            }
          } else {
            evol_skill_item.hlightLight = false
          }
        }
        evol_skill_list.push(evol_skill_item)
      }

      return evol_skill_list
    },
    get_pet_num(roleInfo) {
      return roleInfo.pet_info.length + roleInfo.split_pets.length
    },
    get_equip_num(roleInfo) {
      return roleInfo.using_equips.length + roleInfo.not_using_equips.length + roleInfo.split_equips.length
    },
    async handleEquipPrice({ roleInfo: { using_equips, not_using_equips, split_equips, basic_info }, serverid, server_name, eid }, rowIndex) {
      console.log({ rowIndex })
      const equip_list = [...using_equips, ...not_using_equips, ...split_equips].map((item) => ({ ...item, iType: item.type, cDesc: item.desc, serverid, server_name }))
      this.valuationDialogTitle = {
        nickname: basic_info.nickname,
        school: basic_info.school,
        server_name,
        eid
      }

      try {
        // ÂÖàÊòæÁ§∫ÂºπÁ™óÂíåÈ™®Êû∂Â±è
        this.valuationDialogVisible = true
        this.valuationLoading = true
        this.valuationResults = []
        this.valuationTotalValue = 0
        this.valuationEquipmentList = equip_list
        // Ë∞ÉÁî®ÊâπÈáè‰º∞‰ª∑API
        const response = await this.$api.equipment.batchEquipmentValuation({
          eid,
          equipment_list: equip_list,
          strategy: 'fair_value',
          similarity_threshold: this.batchValuateParams.similarity_threshold,
          max_anchors: this.batchValuateParams.max_anchors
        })

        if (response.code === 200) {
          const data = response.data
          const results = data.results || []
          const totalValue = results.reduce((sum, result) => {
            return sum + (result.estimated_price || 0)
          }, 0)
          this.$set(this.tableData[rowIndex], 'equip_price', data.equip_price)
          // Êõ¥Êñ∞ÂºπÁ™óÂÜÖÂÆπÔºåÊòæÁ§∫ÂÆûÈôÖÊï∞ÊçÆ
          this.valuationResults = results
          this.valuationTotalValue = totalValue
          this.valuationLoading = false
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'Ë£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•'
          })
          this.closeValuationDialog()
        }
      } catch (error) {
        console.error('Ë£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•:', error)
        this.$notify.error({
          title: 'ÈîôËØØ',
          message: 'Ë£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•'
        })
        this.closeValuationDialog()
      } finally {
        this.valuationLoading = false
      }
    },
    get_school_name: window.get_school_name,
    handleSortChange({ prop, order }) {
      this.sortState[prop] = order

      const sortFields = []
      const sortOrders = []
      for (const [field, order] of Object.entries(this.sortState)) {
        if (order) {
          sortFields.push(field)
          sortOrders.push(order === 'ascending' ? 'ASC' : 'DESC')
        }
      }

      this.$set(this.searchForm, 'sort_by', sortFields.join(','))
      this.$set(this.searchForm, 'sort_order', sortOrders.join(','))

      // Êõ¥Êñ∞Ë∑ØÁî±queryÂèÇÊï∞ÔºåÂêåÊ≠•ÊéíÂ∫èÁä∂ÊÄÅÂà∞Âú∞ÂùÄÊ†è
      const newQuery = { ...this.$route.query }
      const oldSortBy = this.$route.query.sort_by
      const oldSortOrder = this.$route.query.sort_order

      if (sortFields.length > 0) {
        newQuery.sort_by = sortFields.join(',')
        newQuery.sort_order = sortOrders.join(',')
      } else {
        // Â¶ÇÊûúÊ≤°ÊúâÊéíÂ∫èÔºåÁßªÈô§ÊéíÂ∫èÂèÇÊï∞
        delete newQuery.sort_by
        delete newQuery.sort_order
      }

      // Âè™ÊúâÂΩìÊéíÂ∫èÂèÇÊï∞ÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Ë∑ØÁî±
      if (newQuery.sort_by !== oldSortBy || newQuery.sort_order !== oldSortOrder) {
        this.$router.replace({
          name: this.$route.name,
          params: this.$route.params,
          query: newQuery
        })
        this.handleSearch()
      }
    },
    async fetchData() {
      this.loading = true
      try {
        const [year, month] = this.searchForm.selectedDate.split('-')
        const params = {
          page: this.currentPage,
          page_size: this.pageSize,
          year,
          month,
          role_type: this.roleType // Ê∑ªÂä†ËßíËâ≤Á±ªÂûãÂèÇÊï∞
        }

        // Ê∑ªÂä†ÊêúÁ¥¢Êù°‰ª∂
        if (this.searchForm.level_min) {
          params.level_min = this.searchForm.level_min
        }
        if (this.searchForm.level_max) {
          params.level_max = this.searchForm.level_max
        }
        if (this.searchForm.equip_num !== undefined) {
          params.equip_num = this.searchForm.equip_num
        }
        if (this.searchForm.pet_num) {
          params.pet_num = this.searchForm.pet_num
        }
        if (this.searchForm.pet_num_level) {
          params.pet_num_level = this.searchForm.pet_num_level
        }
        if (this.searchForm.accept_bargain) {
          params.accept_bargain = this.searchForm.accept_bargain
        }
        // ÊéíÂ∫èÂèÇÊï∞
        if (this.searchForm.sort_by) params.sort_by = this.searchForm.sort_by
        if (this.searchForm.sort_order) params.sort_order = this.searchForm.sort_order

        // ‰ΩøÁî®Êñ∞ÁöÑAPI
        const response = await this.$api.role.getRoleApi(params)

        if (response.code === 200) {
          // Áé∞Âú®Áõ¥Êé•‰ΩøÁî®response.dataÂíåresponse.items
          this.tableData = response.data.data.map(item => {
            const roleInfo = new window.RoleInfoParser(item.large_equip_desc, { equip_level: item.equip_level })
            item.RoleInfoParser = roleInfo
            if (roleInfo.result) {
              item.roleInfo = roleInfo.result
            }
            // Ê£ÄÊü•ÂΩìÂâçËßíËâ≤ÊòØÂê¶Âú®ÈîÅÂÆöÂàóË°®‰∏≠
            item.is_sticky = this.stickyRoleList.some(sticky => sticky.eid === item.eid)
            return item
          }) || []
          this.total = response.data.total || 0
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'Ëé∑ÂèñÊï∞ÊçÆÂ§±Ë¥•'
          })
        }
      } finally {
        this.loading = false
      }
    },

    handleSizeChange(val) {
      this.pageSize = val
      this.currentPage = 1

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: this.$route.params.levelRange
      }

      this.safeRouteUpdate(newParams)

      this.fetchData()
    },

    handleCurrentChange(val) {
      this.currentPage = val

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞‰ª•ÂèçÊò†ÂΩìÂâçÈ°µÁ†Å
      const newParams = {
        type: this.roleType,
        levelRange: this.$route.params.levelRange
      }

      // Âè™ÊúâÂΩìÈ°µÁ†ÅÂ§ß‰∫é1Êó∂ÊâçÊ∑ªÂä†Âà∞Ë∑ØÁî±ÂèÇÊï∞‰∏≠
      if (val > 1) {
        newParams.page = val.toString()
      }

      this.safeRouteUpdate(newParams)

      this.fetchData()
    },

    handleDateChange() {
      this.currentPage = 1

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: this.$route.params.levelRange
      }

      this.safeRouteUpdate(newParams)

      this.fetchData()
    },


    handleQuickLevelSelect(level) {
      this.searchForm.level_min = level
      this.searchForm.level_max = level

      // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞
      const currentLevelRange = this.$route.params.levelRange
      const newLevelRange = `${level},${level}`

      // Âè™ÊúâÂΩìÁ≠âÁ∫ßËåÉÂõ¥ÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Ë∑ØÁî±
      if (currentLevelRange !== newLevelRange) {
        this.$router.replace({
          name: 'RoleList',
          params: {
            type: this.roleType,
            levelRange: newLevelRange,
            page: 1
          },
          query: this.$route.query
        })
      }

      this.fetchData()
    },

    handleLevelChange() {
      // ÂΩìÁ≠âÁ∫ßËæìÂÖ•Ê°ÜÂèòÂåñÊó∂ÔºåÊõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞
      const newLevelRange = this.searchForm.level_min && this.searchForm.level_max
        ? `${this.searchForm.level_min},${this.searchForm.level_max}`
        : undefined

      const currentLevelRange = this.$route.params.levelRange
      if (newLevelRange !== currentLevelRange) {
        this.$router.replace({
          name: 'RoleList',
          params: {
            type: this.roleType,
            levelRange: newLevelRange
          },
          query: this.$route.query
        })
      }
    },

    handleSearch() {
      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞‰ª•ÂèçÊò†ÂΩìÂâçÁöÑÊêúÁ¥¢Êù°‰ª∂
      const newLevelRange = this.searchForm.level_min && this.searchForm.level_max
        ? `${this.searchForm.level_min},${this.searchForm.level_max}`
        : undefined

      // ÊûÑÂª∫queryÂèÇÊï∞ÔºåÂåÖÂê´ÊâÄÊúâÊêúÁ¥¢Ë°®ÂçïÂèÇÊï∞
      const newQuery = { ...this.$route.query }
      
      // ÂêåÊ≠•ÊêúÁ¥¢Ë°®ÂçïÂèÇÊï∞Âà∞query
      if (this.searchForm.selectedDate) {
        newQuery.selectedDate = this.searchForm.selectedDate
      } else {
        delete newQuery.selectedDate
      }
      
      if (this.searchForm.equip_num !== undefined && this.searchForm.equip_num !== '') {
        newQuery.equip_num = this.searchForm.equip_num.toString()
      } else {
        delete newQuery.equip_num
      }
      
      if (this.searchForm.pet_num !== undefined && this.searchForm.pet_num !== '') {
        newQuery.pet_num = this.searchForm.pet_num.toString()
      } else {
        delete newQuery.pet_num
      }
      
      if (this.searchForm.pet_num_level !== undefined && this.searchForm.pet_num_level !== '') {
        newQuery.pet_num_level = this.searchForm.pet_num_level.toString()
      } else {
        delete newQuery.pet_num_level
      }
      
      if (this.searchForm.accept_bargain !== undefined && this.searchForm.accept_bargain !== '') {
        newQuery.accept_bargain = this.searchForm.accept_bargain
      } else {
        delete newQuery.accept_bargain
      }

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: newLevelRange
      }

      // Âè™ÊúâÂΩìÈ°µÁ†ÅÂ§ß‰∫é1Êó∂ÊâçÊ∑ªÂä†Âà∞Ë∑ØÁî±ÂèÇÊï∞‰∏≠
      if (this.currentPage > 1) {
        newParams.page = this.currentPage.toString()
      }

      // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞Ë∑ØÁî±
      const hasParamChanges = JSON.stringify(newParams) !== JSON.stringify(this.$route.params)
      const hasQueryChanges = JSON.stringify(newQuery) !== JSON.stringify(this.$route.query)

      if (hasParamChanges || hasQueryChanges) {
        this.$router.replace({
          name: 'RoleList',
          params: newParams,
          query: newQuery
        })
      }

      this.fetchData()
    },

    handleReset() {
      this.searchForm = {
        selectedDate: dayjs().format('YYYY-MM'),
        level_min: undefined,
        level_max: undefined,
        equip_num: undefined,
        pet_num: undefined,
        pet_num_level: undefined,
        sort_by: undefined,
        sort_order: undefined,
        accept_bargain: undefined
      }

      // Ê∏ÖÁ©∫ÊéíÂ∫èÁä∂ÊÄÅ
      this.sortState = {}

      this.currentPage = 1

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: undefined
      }

      // Ê∏ÖÈô§query‰∏≠ÁöÑÊâÄÊúâÊêúÁ¥¢ÂèÇÊï∞
      const newQuery = { ...this.$route.query }
      delete newQuery.selectedDate
      delete newQuery.equip_num
      delete newQuery.pet_num
      delete newQuery.pet_num_level
      delete newQuery.accept_bargain
      delete newQuery.sort_by
      delete newQuery.sort_order

      // Âè™ÊúâÂΩìÂèÇÊï∞ÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Ë∑ØÁî±
      const hasParamChanges = JSON.stringify(newParams) !== JSON.stringify(this.$route.params)
      const hasQueryChanges = JSON.stringify(newQuery) !== JSON.stringify(this.$route.query)

      if (hasParamChanges || hasQueryChanges) {
        this.$router.replace({
          name: 'RoleList',
          params: newParams,
          query: newQuery
        })
      }

      this.fetchData()
    },

    handleRoleTypeChange() {
      this.currentPage = 1

      // Êõ¥Êñ∞Ë∑ØÁî±ÂèÇÊï∞ÔºåÁßªÈô§È°µÁ†ÅÂèÇÊï∞ÔºàÂõ†‰∏∫ÈáçÁΩÆÂà∞Á¨¨1È°µÔºâ
      const newParams = {
        type: this.roleType,
        levelRange: this.$route.params.levelRange
      }

      this.safeRouteUpdate(newParams)

      this.fetchData()
    },

    extractServerId(equipId) {
      // ‰ªéequip_id‰∏≠ÊèêÂèñÊúçÂä°Âô®ID
      // Ê†ºÂºèÈÄöÂ∏∏ÊòØ: ÊúçÂä°Âô®ID_ÂÖ∂‰ªñ‰ø°ÊÅØ
      const parts = equipId.split('-')
      return parts[1] || null
    }
  }
}
</script>

<style scoped>
.page-header {
  margin-bottom: 20px;
  padding: 16px;
  background: #f5f7fa;
  border-radius: 8px;
  border-left: 4px solid #409eff;
}

.page-header h2 {
  margin: 0;
  color: #303133;
  font-size: 20px;
  font-weight: 600;
}

.filters {
  margin-bottom: 10px;
}

.pagination-container {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}

.mx-2 {
  margin: 0 8px;
}

.level-quick-select {
  margin-left: 16px;
  display: inline-block;
}

.level-quick-select .el-button {
  margin-right: 8px;
  margin-bottom: 8px;
}

.cultivation-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.cultivation-row {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.text-gray {
  color: #909399;
  font-size: 12px;
}

.role-link {
  color: #409eff;
  text-decoration: none;
}

.role-link:hover {
  text-decoration: underline;
}

.equip-desc {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sticky-wrapper {
  position: relative;
  width: 50px;
  height: 50px;
  margin: 0 auto;
}

.sticky-wrapper .el-checkbox {
  position: absolute;
  top: 0;
  right: 0;
  font-size: 0;
  line-height: 0;
  display: none;
}

.sticky-wrapper .el-checkbox.is-checked {
  display: block;
}

.sticky-wrapper :deep(.el-checkbox.is-checked .el-checkbox__inner) {
  background-color: #F56C6C !important;
  border-color: #F56C6C !important;
}

.sticky-wrapper :deep(.el-checkbox .el-checkbox__label) {
  display: none;
}

.hover-row .sticky-wrapper .el-checkbox {
  display: block;
}

/* ËßíËâ≤‰º∞‰ª∑ÂçïÂÖÉÊ†ºÊ†∑Âºè */
.role-valuation-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.role-valuation-cell>* {
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
</style>
