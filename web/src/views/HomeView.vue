<template>
  <div class="home">
    <!-- Áà¨Ëô´ÈÖçÁΩÆÂå∫Âüü -->
    <el-card class="spider-config-card" shadow="never">
      <div slot="header" class="card-header">
        <div><span class="emoji-icon">ü§°</span> ÈÖçÁΩÆ</div>
      </div>
      <el-row type="flex">
        <div style="width: 140px;text-align: center;">
          <template v-if="externalParams.action">
            <el-col :span="24">
              <p class="cBlue">üéØÁõÆÊ†áÔºö</p>
            </el-col>
            <EquipmentImage v-if="externalParams.action === 'similar_equip'" :equipment="externalParams"
              :popoverWidth="450" style="display: flex;flex-direction: column;height: 50px;width: 100%;align-items: center;" />
            <PetImage v-if="externalParams.action === 'similar_pet'" :pet="externalParams"
              :equipFaceImg="externalParams.equip_face_img" />
            <template v-if="externalParams.action">
              <el-cascader :options="server_data" size="mini" filterable v-model="server_data_value" clearable />
              <div style="display: inline-block; margin-left: 8px">
                <el-link @click="openCBGSearch" :type="isCookieValid ? 'danger' : 'info'" :style="cbgLinkStyle"
                  :disabled="!isCookieValid">
                  ËóèÂÆùÈòÅ
                </el-link>
                <el-tooltip v-if="!isCookieValid" content="ËØ∑ÂÖàÁôªÂΩïËóèÂÆùÈòÅÔºåÁ°Æ‰øùCookiesÊúâÊïàÂêéÂÜç‰ΩøÁî®Ê≠§ÂäüËÉΩ" placement="top">
                  <i class="el-icon-warning" style="color: #e6a23c; margin-left: 4px"></i>
                </el-tooltip>
              </div>
            </template>

          </template>
        </div>
        <!-- ÂÖ®Â±ÄËÆæÁΩÆ -->
        <el-form style="width: 100%;flex-shrink: 1;" :model="globalSettings" v-show="activeTab !== 'playwright'">
          <el-row :gutter="20">
            <el-col :span="4">
              <el-form-item label="üìÑ Áà¨ÂèñÈ°µÊï∞" size="small">
                <el-input-number v-model="globalSettings.max_pages" :min="1" :max="100" controls-position="right"
                  style="width: 100%"></el-input-number>
              </el-form-item>
            </el-col>
            <el-col :span="8">
              <el-form-item :label="`‚è±Ô∏è Âª∂ËøüËåÉÂõ¥(Áßí) ÂΩìÂâçÔºö${globalSettings.delay_min} - ${globalSettings.delay_max} Áßí`"
                size="small">
                <el-slider v-model="delayRange" range show-stops :min="5" :max="30" :step="1"
                  @change="onDelayRangeChange" style="width: 100%;display: inline-block;">
                </el-slider>
              </el-form-item>
            </el-col>

          </el-row>
          <el-row>
            <el-col :span="4">
              <el-form-item label="üåê ‰ΩøÁî®ÊµèËßàÂô®" size="small">
                <el-switch v-model="globalSettings.use_browser" @change="onGlobalBrowserToggle"></el-switch>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‚ö° Âø´ÈÄüÈÖçÁΩÆ" size="small" style="width: 100%;">
                <el-row type="flex"><el-button size="mini" @click="quickConfig('small')">10È°µ</el-button>
                  <el-button size="mini" @click="quickConfig('medium')">50È°µ</el-button>
                  <el-button size="mini" @click="quickConfig('large')">100È°µ</el-button></el-row>
              </el-form-item></el-col>
          </el-row>
        </el-form>
      </el-row>

      <el-tabs v-model="activeTab" @tab-click="handleTabClick" tab-position="left">
        <!-- PlaywrightÂçäËá™Âä®Êî∂ÈõÜÂô® -->
        <el-tab-pane label="üéØ Playwright" name="playwright">
          <el-form :model="playwrightForm" label-width="120px" size="small">
            <el-form-item label="Êó†Â§¥Ê®°Âºè">
              <el-switch v-model="playwrightForm.headless" @change="onHeadlessToggle"></el-switch>
              <span class="form-tip">ÂÖ≥Èó≠ÂêéÂèØ‰ª•ÁúãÂà∞ÊµèËßàÂô®Êìç‰ΩúËøáÁ®ã</span>
            </el-form-item>

            <el-form-item label="ÁõÆÊ†áURL">
              <el-select v-model="playwrightForm.target_url" style="width: 100%" @change="onTargetUrlChange">
                <el-option label="ËßíËâ≤Êé®ËçêÊêúÁ¥¢" value="role_recommend"></el-option>
                <el-option label="Ë£ÖÂ§áÊé®ËçêÊêúÁ¥¢" value="equip_recommend"></el-option>
                <el-option label="ÂÆ†Áâ©Êé®ËçêÊêúÁ¥¢" value="pet_recommend"></el-option>
                <el-option label="Ëá™ÂÆö‰πâURL" value="custom"></el-option>
              </el-select>
            </el-form-item>

            <el-form-item label="Ëá™ÂÆö‰πâURL" v-if="playwrightForm.target_url === 'custom'">
              <el-input v-model="playwrightForm.custom_url" placeholder="ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁöÑCBG URL" style="width: 100%">
                <template slot="prepend">https://</template>
              </el-input>
            </el-form-item>
            <el-form-item>
              <el-button type="primary" @click="startPlaywrightCollector" :loading="isRunning">
                üöÄ ÂêØÂä® üéØ
              </el-button>
            </el-form-item>
          </el-form>
        </el-tab-pane>
        <!-- ËßíËâ≤Áà¨Ëô´ -->
        <el-tab-pane label="üë§ ËßíËâ≤" name="role">

          <el-form :model="roleForm" label-width="100px" size="small">
            <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
            <div v-if="!globalSettings.use_browser" class="params-editor">
              <div class="params-actions">
                <el-button type="text" size="mini" @click="resetRoleParams">ÈáçÁΩÆ</el-button>
                <el-button type="primary" size="mini" @click="saveRoleParams" :loading="roleSaving"
                  :disabled="!!roleJsonError">
                  ‰øùÂ≠òÈÖçÁΩÆ
                </el-button>
              </div>
              <div class="json-editor-wrapper">
                <el-input type="textarea" v-model="roleParamsJson" placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤Áà¨Ëô´ÂèÇÊï∞JSON" :rows="8"
                  @blur="validateRoleJson" class="json-editor">
                </el-input>
                <div v-if="roleJsonError" class="json-error">
                  <i class="el-icon-warning"></i> {{ roleJsonError }}
                </div>
              </div>
            </div>

            <el-form-item>
              <el-button type="primary" @click="startRoleSpider" :loading="isRunning">
                üöÄ ÂêØÂä® üë§
              </el-button>
            </el-form-item>
          </el-form>
        </el-tab-pane>

        <!-- Ë£ÖÂ§áÁà¨Ëô´ -->
        <el-tab-pane label="‚öîÔ∏è Ë£ÖÂ§á" name="equip">
          <el-form :model="equipForm" label-width="100px" size="small">
            <el-form-item label="Ë£ÖÂ§áÁ±ªÂûã">
              <el-select v-model="equipForm.equip_type" @change="onEquipTypeChange" style="width: 100%">
                <el-option label="ÊôÆÈÄöË£ÖÂ§á" value="normal"></el-option>
                <el-option label="ÁÅµÈ•∞Ë£ÖÂ§á" value="lingshi"></el-option>
                <el-option label="ÂÆ†Áâ©Ë£ÖÂ§á" value="pet"></el-option>
              </el-select>
            </el-form-item>

            <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
            <div v-if="!globalSettings.use_browser" class="params-editor">
              <div class="params-actions">
                <el-button type="text" size="mini" @click="resetEquipParams">ÈáçÁΩÆ</el-button>
                <el-button type="primary" size="mini" @click="saveEquipParams" :loading="equipSaving"
                  :disabled="!!equipJsonError">
                  ‰øùÂ≠òÈÖçÁΩÆ
                </el-button>
              </div>
              <div class="json-editor-wrapper" v-if="externalParams.action === 'similar_equip'">
                <el-input type="textarea" v-model="externalSearchParams" placeholder="ÊêúÁ¥¢ÊåáÂÆöÂèÇÊï∞" :rows="10"
                  @blur="validateEquipJson" class="json-editor">
                </el-input>
                <div v-if="equipJsonError" class="json-error">
                  <i class="el-icon-warning"></i> {{ equipJsonError }}
                </div>
              </div>
              <div class="json-editor-wrapper">
                <el-input type="textarea" v-model="equipParamsJson" placeholder="ËØ∑ËæìÂÖ•Ë£ÖÂ§áÁà¨Ëô´ÂèÇÊï∞JSON" :rows="10"
                  @blur="validateEquipJson" class="json-editor">
                </el-input>
                <div v-if="equipJsonError" class="json-error">
                  <i class="el-icon-warning"></i> {{ equipJsonError }}
                </div>
              </div>
            </div>

            <el-form-item>
              <el-button type="success" @click="startEquipSpider" :loading="isRunning">
                üöÄ ÂêØÂä® ‚öîÔ∏è
              </el-button>
            </el-form-item>
          </el-form>
        </el-tab-pane>

        <!-- Âè¨Âî§ÂÖΩÁà¨Ëô´ -->
        <el-tab-pane label="üê≤ Âè¨Âî§ÂÖΩ" name="pet">
          <el-form :model="petForm" label-width="100px" size="small">
            <!-- JSONÂèÇÊï∞ÁºñËæëÂô® -->
            <div v-if="!globalSettings.use_browser" class="params-editor">
              <div class="params-actions">
                <el-button type="text" size="mini" @click="resetPetParams">ÈáçÁΩÆ</el-button>
                <el-button type="primary" size="mini" @click="savePetParams" :loading="petSaving"
                  :disabled="!!petJsonError">
                  ‰øùÂ≠òÈÖçÁΩÆ
                </el-button>
              </div>
              <div class="json-editor-wrapper" v-if="externalParams.action === 'similar_pet'">
                <el-input type="textarea" v-model="externalSearchParams" placeholder="ÊêúÁ¥¢ÊåáÂÆöÂèÇÊï∞" :rows="10"
                  @blur="validateEquipJson" class="json-editor">
                </el-input>
                <div v-if="equipJsonError" class="json-error">
                  <i class="el-icon-warning"></i> {{ equipJsonError }}
                </div>
              </div>
              <div class="json-editor-wrapper">
                <el-input type="textarea" v-model="petParamsJson" placeholder="ËØ∑ËæìÂÖ•Âè¨Âî§ÂÖΩÁà¨Ëô´ÂèÇÊï∞JSON" :rows="8"
                  @blur="validatePetJson" class="json-editor">
                </el-input>
                <div v-if="petJsonError" class="json-error">
                  <i class="el-icon-warning"></i> {{ petJsonError }}
                </div>
              </div>
            </div>

            <el-form-item>
              <el-button type="warning" @click="startPetSpider" :loading="isRunning">
                üöÄ ÂêØÂä® üê≤
              </el-button>
            </el-form-item>
          </el-form>
        </el-tab-pane>

      </el-tabs>
    </el-card>
    <!-- ÂÆûÊó∂Êó•ÂøóÁõëÊéß -->
    <el-card class="logs-card">
      <div slot="header" class="card-header">
        <span>üìù ÂÆûÊó∂Êó•Âøó</span>
        <div>
          <el-select v-model="selectedLogFile" placeholder="ÈÄâÊã©ÂéÜÂè≤Êó•ÂøóÊñá‰ª∂" size="small"
            style="width: 200px; margin-right: 10px;" @change="onLogFileChange" clearable>
            <el-option label="ÂΩìÂâçÊó•Âøó" value="current"></el-option>
            <el-option v-for="file in logFiles" :key="file.name" :label="file.name" :value="file.name">
              <span style="float: left">{{ file.name }}</span>
              <span style="float: right; color: #8492a6; font-size: 13px">{{ file.modified }}</span>
            </el-option>
          </el-select>
          <el-button type="text" @click="refreshLogs" :loading="logsLoading" size="small">Âà∑Êñ∞</el-button>
          <el-button type="text" @click="toggleLogStream" size="small">
            {{ isLogStreaming ? 'ÂÅúÊ≠¢' : 'ÂºÄÂßã' }}ÂÆûÊó∂ÁõëÊéß
          </el-button>
          <el-button type="text" @click="clearLogs" size="small">Ê∏ÖÁ©∫</el-button>
        </div>
      </div>
      <div class="status-content">
        <el-row :gutter="20">
          <el-col :span="8">
            <div class="status-item">
              <span class="status-label">Áä∂ÊÄÅ:</span>
              <el-tag :type="getStatusType(currentTaskStatus.status)" size="medium">
                {{ taskStatusText }}
              </el-tag>
            </div>
          </el-col>
          <el-col :span="8">
            <div class="status-item">
              <span class="status-label">ËøõÂ∫¶:</span>
              <div class="progress-wrapper">
                <el-progress :percentage="currentTaskStatus.progress || 0" :stroke-width="8" :show-text="true"
                  :text-inside="false">
                </el-progress>
              </div>
            </div>
          </el-col>
        </el-row>
      </div>
      <div class="logs-content">
        <div class="logs-info" v-if="logsInfo">
          <el-tag size="small" type="info">{{ logsInfo.log_file }}</el-tag>
          <el-tag size="small" type="success">{{ logsInfo.total_lines }} Ë°å</el-tag>
          <el-tag size="small" type="warning">{{ logsInfo.recent_lines }} Ë°åÊòæÁ§∫</el-tag>
          <el-tag size="small" type="info">{{ logsInfo.last_modified }}</el-tag>
        </div>
        <div class="logs-container" ref="logsContainer">
          <div v-if="logs.length === 0" class="no-logs">
            <i class="el-icon-document"></i>
            <p>ÊöÇÊó†Êó•ÂøóÊï∞ÊçÆ</p>
          </div>
          <div v-else class="log-lines">
            <div v-for="(log, index) in logs" :key="index" class="log-line" :class="getLogLevel(log)">
              <span class="log-time">{{ getLogTime(log) }}</span>
              <span class="log-content">{{ getLogContent(log) }}</span>
            </div>
          </div>
        </div>
      </div>
    </el-card>

    <!-- Á¨¨‰∫åË°å -->
    <el-row :gutter="20">
      <!-- Â∑•ÂÖ∑Êìç‰Ωú -->
      <el-col :span="24">
        <el-card class="spider-card">
          <div slot="header" class="card-header">
            <span>üîß Â∑•ÂÖ∑Êìç‰Ωú</span>
          </div>
          <div class="tool-buttons">
            <el-button type="danger" @click="manageProxies" :loading="isRunning">
              üåê Êõ¥Êñ∞‰ª£ÁêÜIPÊ±†
            </el-button>
            <el-button type="warning" @click="stopTask" :disabled="!isRunning">
              ‚èπÔ∏è ÂÅúÊ≠¢ÂΩìÂâç‰ªªÂä°
            </el-button>
            <el-button type="danger" @click="resetTask">
              üîÑ ÈáçÁΩÆ‰ªªÂä°Áä∂ÊÄÅ
            </el-button>
            <el-button type="info" @click="loadCachedParams" :loading="paramsLoading">
              üìã Âà∑Êñ∞ÁºìÂ≠òÂèÇÊï∞
            </el-button>
            <el-button type="info" @click="startProxySpider" :loading="isRunning">
              ÂêØÂä®‰ª£ÁêÜÁà¨Ëô´
            </el-button>
          </div>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
import str2gbk from 'str2gbk'
import qs from 'qs'
import EquipmentImage from '@/components/EquipmentImage.vue'
import PetImage from '@/components/PetImage.vue'
const server_data_list = []
for (let key in window.server_data) {
  let [parent, children] = window.server_data[key]
  const [label, , , , value] = parent
  children = children.map(([value, label]) => ({ value, label }))
  server_data_list.push({
    label,
    value,
    children
  })
}
export default {
  name: 'HomeView',
  components: {
    EquipmentImage,
    PetImage
  },
  data() {
    return {
      server_data: server_data_list,
      // ÂÖ®Â±ÄËÆæÁΩÆ
      globalSettings: {
        max_pages: 5,
        delay_min: 8,
        delay_max: 20,
        use_browser: false // Êñ∞Â¢û‰ΩøÁî®ÊµèËßàÂô®ÈÖçÁΩÆ
      },
      // Âª∂ËøüËåÉÂõ¥ÊªëÂùó
      delayRange: [8, 20],
      // ËßíËâ≤Áà¨Ëô´Ë°®Âçï
      roleForm: {
        use_browser: false
      },
      // Ë£ÖÂ§áÁà¨Ëô´Ë°®Âçï
      equipForm: {
        equip_type: 'normal',
        use_browser: false
      },
      // Âè¨Âî§ÂÖΩÁà¨Ëô´Ë°®Âçï
      petForm: {
        use_browser: false
      },
      // ‰ª£ÁêÜÁà¨Ëô´Ë°®Âçï
      proxyForm: {},
      // PlaywrightÊî∂ÈõÜË°®Âçï
      playwrightForm: {
        headless: false,
        target_url: 'role_recommend',
        custom_url: ''
      },
      // JSONÂèÇÊï∞Â≠óÁ¨¶‰∏≤
      roleParamsJson: '',
      equipParamsJson: '{}',
      petParamsJson: '',
      // JSONÈ™åËØÅÈîôËØØ
      roleJsonError: '',
      equipJsonError: '',
      petJsonError: '',
      // ÈªòËÆ§ÂèÇÊï∞Ê®°ÊùøÔºàÂ∞Ü‰ªéAPIÂä®ÊÄÅÂä†ËΩΩÔºâ
      defaultParams: {
        role: {},
        equip_normal: {},
        equip_lingshi: {},
        equip_pet: {},
        equip_pet_equip: {},
        pet: {}
      },
      // Âä†ËΩΩÁä∂ÊÄÅ
      isRunning: false,
      paramsLoading: false,
      logsLoading: false,
      // Êó•ÂøóÁõ∏ÂÖ≥
      logs: [],
      logsInfo: null,
      isLogStreaming: false,
      logEventSource: null,
      // TabÁõ∏ÂÖ≥
      activeTab: 'playwright',
      selectedLogFile: 'current',
      logFiles: [],
      // Áä∂ÊÄÅÁõëÊéß
      statusMonitor: null,
      taskStatus: null,
      // ‰øùÂ≠òÁä∂ÊÄÅ
      roleSaving: false,
      equipSaving: false,
      petSaving: false,
      // ÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®
      cacheCleanupTimer: null,

      // Â§ñÈÉ®ÂèÇÊï∞
      externalSearchParams: '{}',
      targetFeatures: {}
    }
  },
  computed: {
    externalParams() {
      const query = JSON.parse(JSON.stringify(this.$route.query))
      if (query.action === 'similar_pet') {
        query.evol_skill_list = JSON.parse(query.evol_skill_list)
        query.neidan = JSON.parse(query.neidan)
        query.equip_list = JSON.parse(query.equip_list)
        query.texing = JSON.parse(query.texing)
      }
      return query
    },
    // ÂΩìÂâç‰ªªÂä°Áä∂ÊÄÅ‰ø°ÊÅØ
    currentTaskStatus() {
      if (!this.taskStatus) {
        return {
          status: 'idle',
          message: 'Á≠âÂæÖ‰ªªÂä°ÂºÄÂßã...',
          progress: 0
        }
      }
      return this.taskStatus
    },

    // ‰ªªÂä°Áä∂ÊÄÅÊñáÊú¨
    taskStatusText() {
      const status = this.currentTaskStatus.status
      const statusMap = {
        'idle': 'Á©∫Èó≤',
        'running': 'ËøêË°å‰∏≠',
        'completed': 'Â∑≤ÂÆåÊàê',
        'error': 'Âá∫Èîô',
        'stopped': 'Â∑≤ÂÅúÊ≠¢'
      }
      return statusMap[status] || status
    },
    // ‰ªéVuex storeËé∑Âèñserver_data_valueTODO:::::
    server_data_value: {
      get() {
        return this.$store?.state.server_data_value || {}
      },
      set(value) {
        this.$store.dispatch('setServerDataValue', value)
      }
    },
    // Ê£ÄÊü•cookiesÊòØÂê¶ÊúâÊïà
    isCookieValid() {
      return this.$store.getters['cookie/isCookieCacheValid']
    },
    // ËóèÂÆùÈòÅÈìæÊé•Ê†∑Âºè
    cbgLinkStyle() {
      return {
        color: this.isCookieValid ? '#f56c6c' : '#c0c4cc',
        cursor: this.isCookieValid ? 'pointer' : 'not-allowed',
        textDecoration: this.isCookieValid ? 'underline' : 'none'
      }
    }

  },
  watch: {
    // ÁõëÂê¨server_data_valueÂèòÂåñÔºåÂêåÊ≠•Âà∞Vuex store
    server_data_value: {
      handler(newValue) {
        console.log(newValue, 'newValue')
        if (Array.isArray(newValue) && newValue.length >= 2) {
          this.$store.dispatch('setServerDataValue', newValue)
          const { server_id, areaid, server_name } = this.$store.getters.getCurrentServerData
          this.onExtractQuery({
            ...this.genarateEquipmentSearchParams(this.targetFeatures),
            server_id,
            areaid,
            server_name
          })
        }
      },
      deep: true
    }
  },
  mounted() {
    // Á≠âÂæÖVuexÁä∂ÊÄÅÊÅ¢Â§çÂêéÂÜçÊâßË°åÂÖ∂‰ªñÊìç‰Ωú
    this.$nextTick(() => {
      // Ëá™Âä®Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
      this.$store.dispatch('cookie/cleanExpiredCache')

      // ÂêØÂä®ÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®ÔºàÊØèÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°Ôºâ
      this.cacheCleanupTimer = setInterval(() => {
        this.$store.dispatch('cookie/cleanExpiredCache')
      }, 60 * 1000)

      this.loadSearchParams()
      this.loadLogFiles()
      // È°µÈù¢Âä†ËΩΩÊó∂ËØ∑Ê±Ç‰∏ÄÊ¨°Áä∂ÊÄÅ
      this.checkTaskStatus()
      // ÂàùÂßãÂåñÂª∂ËøüËåÉÂõ¥ÊªëÂùó
      this.delayRange = [this.globalSettings.delay_min, this.globalSettings.delay_max]

      this.loadExternalParams()
    })
    // ÂàùÂßãÂåñÊó∂ËÆæÁΩÆÈªòËÆ§ÁöÑserver_data_valueÔºàÂ¶ÇÊûústore‰∏≠Ê≤°ÊúâÁöÑËØùÔºâ
    if (
      this.externalParams.action &&
      (!this.$store?.state.server_data_value || this.$store?.state.server_data_value.length === 0)
    ) {
      this.$store.dispatch('setServerDataValue', [43, 77])
    }
    if (this.externalParams.action) {
      this.getFeatures()
    }
  },
  beforeDestroy() {
    this.stopLogStream()
    this.stopStatusMonitor()
    // Ê∏ÖÁêÜÁºìÂ≠òÊ∏ÖÁêÜÂÆöÊó∂Âô®
    if (this.cacheCleanupTimer) {
      clearInterval(this.cacheCleanupTimer)
    }
  },
  methods: {
    genaratePetSearchParams() {
      const searchParams = {}
      searchParams.skill = this.externalParams.all_skill.replace(/\|/g, ',')
      searchParams.texing = this.externalParams.texing?.id
      searchParams.lingxing = this.externalParams.lx
      searchParams.growth = this.externalParams.growth * 1000
      return searchParams
    },
    genarateEquipmentSearchParams({ kindid, ...features }) {
      const searchParams = {}
      if (window.is_pet_equip(kindid)) {
        searchParams.level = features.equip_level
        searchParams.speed = features.speed > 0 ? features.speed : undefined
        searchParams.shanghai = features.shanghai > 0 ? features.shanghai : undefined
        searchParams.hp = features.qixue > 0 ? features.qixue : undefined
        searchParams.fangyu = features.fangyu > 0 ? features.fangyu : undefined
        let addon_sum = 0
          ;['fali', 'liliang', 'lingli', 'minjie', 'naili'].forEach((item) => {
            searchParams[`addon_${item}`] = this.targetFeatures[`addon_${item}`] > 0 ? 1 : undefined
            if (item === 'minjie' && this.targetFeatures[`addon_${item}`] < 0) {
              searchParams.addon_minjie_reduce = this.targetFeatures[`addon_${item}`] * -1
            } else {
              addon_sum += this.targetFeatures[`addon_${item}`]
            }
          })
        searchParams.addon_sum = addon_sum > 0 ? addon_sum : undefined
        searchParams.addon_sum_min = searchParams.addon_sum
        searchParams.addon_status = features.addon_status
        if (features.fangyu > 0) {
          searchParams.equip_pos = 1
        } else if (features.speed > 0) {
          searchParams.equip_pos = 2
        } else {
          searchParams.equip_pos = 3
        }
      } else if (window.is_lingshi_equip(kindid)) {
        searchParams.kindid = kindid

        // ÁÅµÈ•∞ÈôÑÂä†Â±ûÊÄßÈÖçÁΩÆ
        const { lingshi_added_attr1, lingshi_added_attr2 } = window.AUTO_SEARCH_CONFIG

        // Â±ûÊÄßÂêçÁß∞Êò†Â∞ÑË°® - ÂâçÁ´ØÊòæÁ§∫ÂêçÁß∞Âà∞ÂêéÁ´ØÂ≠óÊÆµÂêçÁöÑÊò†Â∞Ñ
        const attr_name_map = {
          'Ê≥ï‰º§ÁªìÊûú': 'Ê≥ïÊúØ‰º§ÂÆ≥ÁªìÊûú',
          'Ê≥ï‰º§': 'Ê≥ïÊúØ‰º§ÂÆ≥',
          'Âõ∫‰º§': 'Âõ∫ÂÆö‰º§ÂÆ≥',
          'Ê≥ïÊúØÊö¥Âáª': 'Ê≥ïÊúØÊö¥ÂáªÁ≠âÁ∫ß',
          'Áâ©ÁêÜÊö¥Âáª': 'Áâ©ÁêÜÊö¥ÂáªÁ≠âÁ∫ß',
          'Â∞ÅÂç∞': 'Â∞ÅÂç∞ÂëΩ‰∏≠Á≠âÁ∫ß',
          'ÁãÇÊö¥': 'ÁãÇÊö¥Á≠âÁ∫ß',
          'Á©øÂà∫': 'Á©øÂà∫Á≠âÁ∫ß',
          'Ê≤ªÁñó': 'Ê≤ªÁñóËÉΩÂäõ',
          '‰º§ÂÆ≥': '‰º§ÂÆ≥',
          'ÈÄüÂ∫¶': 'ÈÄüÂ∫¶',
          'ÊäóÊ≥ïÊúØÊö¥Âáª': 'ÊäóÊ≥ïÊúØÊö¥ÂáªÁ≠âÁ∫ß',
          'ÊäóÁâ©ÁêÜÊö¥Âáª': 'ÊäóÁâ©ÁêÜÊö¥ÂáªÁ≠âÁ∫ß',
          'ÊäóÂ∞Å': 'ÊäµÊäóÂ∞ÅÂç∞Á≠âÁ∫ß',
          'ÂõûÂ§ç': 'Ê∞îË°ÄÂõûÂ§çÊïàÊûú',
          'Ê≥ïÈò≤': 'Ê≥ïÊúØÈò≤Âæ°',
          'Èò≤Âæ°': 'Èò≤Âæ°',
          'Ê†ºÊå°': 'Ê†ºÊå°ÂÄº',
          'Ê∞îË°Ä': 'Ê∞îË°Ä'
        }

        // ÊûÑÂª∫Â±ûÊÄßÂÄºÂà∞ÊêúÁ¥¢ÂèÇÊï∞ÁöÑÊò†Â∞Ñ
        const buildAttrValueMapping = () => {
          const mapping = {}

          // ÂêàÂπ∂‰∏§‰∏™Â±ûÊÄßÈÖçÁΩÆ
          const allAttrs = { ...lingshi_added_attr1, ...lingshi_added_attr2 }

          // ÈÅçÂéÜÊâÄÊúâÂ±ûÊÄßÔºåÂª∫Á´ãÊò†Â∞ÑÂÖ≥Á≥ª
          Object.entries(allAttrs).forEach(([value, displayName]) => {
            const backendFieldName = attr_name_map[displayName]
            if (backendFieldName) {
              mapping[backendFieldName] = value
            }
          })

          return mapping
        }

        // Â§ÑÁêÜ‰∏ªÂ±ûÊÄß
        const processMainAttributes = () => {
          const mainAttrs = ['damage', 'defense', 'magic_damage', 'magic_defense', 'fengyin', 'fengyin', 'speed']
          mainAttrs.forEach(attr => {
            if (features[attr] && features[attr] > 0) {
              searchParams[attr] = features[attr]
            }
          })
        }

        // Â§ÑÁêÜÁ≤æÁÇºÁ≠âÁ∫ß
        const processGemLevel = () => {
          if (features.gem_level && features.gem_level > 0) {
            searchParams.jinglian_level = features.gem_level
          }
        }

        // Â§ÑÁêÜÈôÑÂä†Â±ûÊÄß
        const processAddedAttributes = () => {
          if (!features.attrs || !Array.isArray(features.attrs)) {
            return
          }

          const attrValueMapping = buildAttrValueMapping()
          const addedAttrsCount = {}

          // ÁªüËÆ°ÊØèÁßçÈôÑÂä†Â±ûÊÄßÁöÑÂá∫Áé∞Ê¨°Êï∞
          features.attrs.forEach(({ attr_type }) => {
            const searchValue = attrValueMapping[attr_type]
            if (searchValue) {
              addedAttrsCount[searchValue] = (addedAttrsCount[searchValue] || 0) + 1
            }
          })

          // Â∞ÜÁªüËÆ°ÁªìÊûúÊ∑ªÂä†Âà∞ÊêúÁ¥¢ÂèÇÊï∞
          Object.entries(addedAttrsCount).forEach(([value, count]) => {
            searchParams[`added_attr.${value}`] = count
          })
        }

        // ÊâßË°åÂ§ÑÁêÜ
        processMainAttributes()
        processGemLevel()
        processAddedAttributes()
      } else {
        // Ë£ÖÂ§á
        searchParams.kindid = kindid
        let addon_sum = 0
          ;['moli', 'liliang', 'tizhi', 'minjie', 'naili'].forEach((item) => {
            searchParams[`addon_${item}`] = this.targetFeatures[`addon_${item}`] > 0 ? 1 : undefined
            if (item === 'minjie' && this.targetFeatures[`addon_${item}`] < 0) {
              searchParams.addon_minjie_reduce = this.targetFeatures[`addon_${item}`] * -1
            } else {
              addon_sum += this.targetFeatures[`addon_${item}`]
            }
          })
        searchParams.addon_sum = addon_sum > 0 ? addon_sum : undefined
        searchParams.addon_sum_min = searchParams.addon_sum
        if (features.equip_level) {
          searchParams.level_min = features.equip_level
          searchParams.level_max = features.equip_level * 1 + 9
        }

        if (features.suit_effect) {
          searchParams.suit_effect = features.suit_effect
        }
        if (features.special_skill) {
          searchParams.special_skill = features.special_skill
        }
        [
          'init_damage',
          'init_damage_raw',
          'init_defense',
          'init_hp',
          'init_dex',
          'init_wakan',
          'all_wakan',
          'all_damage',
          'damage'
        ].forEach((value) => {
          if (features[value]) {
            searchParams[value] = features[value]
          }
        })
      }
      return searchParams
    },
    async getFeatures() {
      const { server_id, areaid, server_name } = this.$store.getters.getCurrentServerData
      let query = {}
      if (this.externalParams.action === 'similar_equip') {
        console.log(this.externalParams.kindid * 1 || 0, 'kindid')
        await this.$api.equipment
          .extractFeatures({
            equipment_data: {
              kindid: this.externalParams.kindid * 1 || undefined,
              type: this.externalParams.type * 1 || undefined,
              large_equip_desc: this.externalParams.large_equip_desc
            },
            data_type: 'equipment'
          })
          .then((res) => {
            if (res.code === 200 && res.data.features) {
              this.targetFeatures = res.data.features
              query = this.genarateEquipmentSearchParams(res.data.features)
            }
          })
      } else if (this.externalParams.action === 'similar_pet') {
        query = this.genaratePetSearchParams()
      }
      this.onExtractQuery({
        ...query,
        server_id,
        areaid,
        server_name
      })
    },
    async openCBGSearch() {
      // Ê£ÄÊü•cookiesÊòØÂê¶ÊúâÊïà
      const isCookieValid = this.$store.getters['cookie/isCookieCacheValid']

      if (!isCookieValid) {
        // CookiesÊó†ÊïàÔºåÊèêÁ§∫Áî®Êà∑ÂÖàÁôªÂΩï
        this.$notify.warning({
          message: 'ËØ∑ÂÖàÁôªÂΩïËóèÂÆùÈòÅÔºåÁ°Æ‰øùCookiesÊúâÊïàÂêéÂÜç‰ΩøÁî®Ê≠§ÂäüËÉΩ',
          duration: 3000,
          showClose: true
        })

        // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢ÁöÑÈÄªËæë
        // this.$router.push('/login')
        return
      }

      let prefix = ''
      let search_type = 'search_role_equip'
      let query = {}
      if (this.externalParams.action === 'similar_equip') {
        if (window.is_pet_equip(this.externalParams.kindid)) {
          // ‰ΩøÁî®Vuex store‰∏≠ÁöÑÊúçÂä°Âô®Êï∞ÊçÆ
          search_type = 'search_pet_equip'
        } else if (window.is_lingshi_equip(this.externalParams.kindid)) {
          search_type = 'search_lingshi'
        } else {
          search_type += 'hide_lingshi=1&'
        }
        query = this.genarateEquipmentSearchParams(this.targetFeatures)
      } else {
        search_type = 'search_pet'
        query = this.genaratePetSearchParams()
      }
      const serverData = this.$store.getters.getCurrentServerData
      prefix = `https://xyq.cbg.163.com/cgi-bin/recommend.py?callback=Request.JSONP.request_map.request_0&_=${new Date().getTime()}&act=recommd_by_role&server_id=${serverData.server_id
        }&areaid=${serverData.areaid}&server_name=${serverData.server_name
        }&page=1&query_order=price%20ASC&view_loc=search_cond&count=15&search_type=${search_type}&`

      let target_url = prefix + qs.stringify(query)
      console.log(target_url, 'target_url')
      this.$api.spider.startPlaywright({
        headless: false,
        target_url
      })
    },
    /**
    * GBKÁºñÁ†ÅÁöÑURLÁºñÁ†Å
    * @param {string} str - Ë¶ÅÁºñÁ†ÅÁöÑÂ≠óÁ¨¶‰∏≤
    * @returns {Promise<string>} - GBKÁºñÁ†ÅÁöÑURLÁºñÁ†ÅÂ≠óÁ¨¶‰∏≤
    */
    encodeGBK(str) {
      if (!str) return ''

      try {
        const gbkBytes = str2gbk(str)
        // Â∞ÜÂ≠óËäÇÊï∞ÁªÑËΩ¨Êç¢‰∏∫URLÁºñÁ†ÅÊ†ºÂºè
        return Array.from(gbkBytes)
          .map((b) => `%${b.toString(16).toUpperCase().padStart(2, '0')}`)
          .join('')
      } catch (error) {
        console.warn('GBKÁºñÁ†ÅÂ§±Ë¥•Ôºå‰ΩøÁî®UTF-8ÁºñÁ†Å‰Ωú‰∏∫ÈôçÁ∫ßÊñπÊ°à:', error)
        // ÈôçÁ∫ßÂà∞UTF-8ÁºñÁ†Å
        return window.encodeURI(str)
      }
    },
    onExtractQuery(query) {
      this.externalSearchParams = JSON.stringify(query, null, 2)
    },
    async loadExternalParams() {
      if (this.externalParams.activeTab) {
        this.activeTab = this.externalParams.activeTab
      }
      if (this.externalParams.equip_type) {
        this.equipForm.equip_type = this.externalParams.equip_type
      }
    },
    // TabÂàáÊç¢Â§ÑÁêÜ
    handleTabClick(tab) {
      console.log('ÂàáÊç¢Âà∞:', tab.name)
      // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†tabÂàáÊç¢Êó∂ÁöÑÈÄªËæë
    },

    // Âø´ÈÄüÈÖçÁΩÆÊñπÊ≥ï - Ê†πÊçÆÂΩìÂâçactiveTabÈÖçÁΩÆ
    quickConfig(size) {
      const configs = {
        small: { max_pages: 10, delay_min: 10, delay_max: 15 },
        medium: { max_pages: 50, delay_min: 15, delay_max: 20 },
        large: { max_pages: 100, delay_min: 20, delay_max: 30 }
      }
      const config = configs[size]
      Object.assign(this.globalSettings, config)
      // ÂêåÊ≠•Êõ¥Êñ∞ÊªëÂùóÂÄº
      this.delayRange = [this.globalSettings.delay_min, this.globalSettings.delay_max]
    },

    // Âª∂ËøüËåÉÂõ¥ÊªëÂùóÂèòÂåñÂ§ÑÁêÜ
    onDelayRangeChange(value) {
      this.globalSettings.delay_min = value[0]
      this.globalSettings.delay_max = value[1]
    },

    // Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆ
    async loadSearchParams() {
      try {
        this.paramsLoading = true
        const response = await this.$api.config.getSearchParams()

        if (response.code === 200) {
          // Êõ¥Êñ∞ÈªòËÆ§ÂèÇÊï∞
          this.defaultParams = {
            role: response.data.role || {},
            equip_normal: response.data.equip_normal || {},
            equip_lingshi: response.data.equip_lingshi || {},
            equip_pet: response.data.equip_pet || {},
            equip_pet_equip: response.data.equip_pet_equip || {},
            pet: response.data.pet || {}
          }

          // ÂàùÂßãÂåñJSONÁºñËæëÂô®
          this.initializeDefaultParams()
        } else {
          this.$notify.error(response.message || 'Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•')
          // ‰ΩøÁî®ÈªòËÆ§ÂÄº
          this.initializeDefaultParams()
        }
      } catch (error) {
        console.error('Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•:', error)
        this.$notify.error('Âä†ËΩΩÊêúÁ¥¢ÂèÇÊï∞ÈÖçÁΩÆÂ§±Ë¥•: ' + error.message)
        // ‰ΩøÁî®ÈªòËÆ§ÂÄº
        this.initializeDefaultParams()
      } finally {
        this.paramsLoading = false
      }
    },

    // ÂàùÂßãÂåñÈªòËÆ§ÂèÇÊï∞
    initializeDefaultParams() {
      this.roleParamsJson = JSON.stringify(this.defaultParams.role, null, 2)
      // Ê†πÊçÆÂΩìÂâçË£ÖÂ§áÁ±ªÂûãÂàùÂßãÂåñË£ÖÂ§áÂèÇÊï∞
      const equipParamKey = this.getEquipParamKey(this.equipForm.equip_type)
      this.equipParamsJson = JSON.stringify(this.defaultParams[equipParamKey], null, 2)
      this.petParamsJson = JSON.stringify(this.defaultParams.pet, null, 2)
    },

    // ÊµèËßàÂô®Ê®°ÂºèÂàáÊç¢‰∫ã‰ª∂
    onRoleBrowserToggle(useBrowser) {
      if (!useBrowser) {
        this.loadCachedParams()
      }
    },

    onEquipBrowserToggle(useBrowser) {
      if (!useBrowser) {
        this.loadCachedParams()
      }
    },

    onPetBrowserToggle(useBrowser) {
      if (!useBrowser) {
        this.loadCachedParams()
      }
    },

    // PlaywrightÊî∂ÈõÜÁõ∏ÂÖ≥ÊñπÊ≥ï
    onHeadlessToggle(headless) {
      if (headless) {
        this.$notify.info({
          title: 'Êó†Â§¥Ê®°Âºè',
          message: 'ÊµèËßàÂô®Â∞ÜÂú®ÂêéÂè∞ËøêË°åÔºå‰∏ç‰ºöÊòæÁ§∫ÁïåÈù¢'
        })
      } else {
        this.$notify.info({
          title: 'ÊúâÂ§¥Ê®°Âºè',
          message: 'ÊµèËßàÂô®Â∞ÜÊòæÁ§∫ÁïåÈù¢ÔºåÂèØ‰ª•ÁúãÂà∞Êìç‰ΩúËøáÁ®ã'
        })
      }
    },

    onTargetUrlChange(value) {
      if (value === 'custom') {
        this.playwrightForm.custom_url = ''
      }
    },

    onEquipTypeChange() {
      // Ë£ÖÂ§áÁ±ªÂûãÊîπÂèòÊó∂ÂàáÊç¢ÂØπÂ∫îÁöÑÈªòËÆ§ÂèÇÊï∞
      if (!this.equipForm.use_browser) {
        const paramKey = this.getEquipParamKey(this.equipForm.equip_type)
        if (this.defaultParams[paramKey]) {
          this.equipParamsJson = JSON.stringify(this.defaultParams[paramKey], null, 2)
          this.equipJsonError = ''
        }
      }
    },

    // Ëé∑ÂèñË£ÖÂ§áÂèÇÊï∞ÈîÆ
    getEquipParamKey(equipType) {
      const paramKeyMap = {
        normal: 'equip_normal',
        lingshi: 'equip_lingshi',
        pet: 'equip_pet_equip'  // ‰øÆÂ§çÔºöÂÆ†Áâ©Ë£ÖÂ§áÂ∫îËØ•‰ΩøÁî®equip_pet_equip
      }
      return paramKeyMap[equipType] || 'equip_normal'
    },

    // JSONÈ™åËØÅÊñπÊ≥ï
    validateRoleJson() {
      this.roleJsonError = this.validateJson(this.roleParamsJson, 'role')
    },

    validateEquipJson() {
      this.equipJsonError = this.validateJson(this.equipParamsJson, 'equip')
    },

    validatePetJson() {
      this.petJsonError = this.validateJson(this.petParamsJson, 'pet')
    },

    validateJson(jsonStr, type) {
      try {
        if (!jsonStr.trim()) {
          return `${type}ÂèÇÊï∞‰∏çËÉΩ‰∏∫Á©∫`
        }
        const parsed = JSON.parse(jsonStr)
        if (typeof parsed !== 'object' || parsed === null) {
          return 'JSONÂøÖÈ°ªÊòØ‰∏Ä‰∏™ÂØπË±°'
        }
        return ''
      } catch (e) {
        return `JSONÊ†ºÂºèÈîôËØØ: ${e.message}`
      }
    },

    // ÈáçÁΩÆÂèÇÊï∞ÊñπÊ≥ï
    resetRoleParams() {
      this.roleParamsJson = JSON.stringify(this.defaultParams.role, null, 2)
      this.roleJsonError = ''
    },

    resetEquipParams() {
      const paramKey = this.getEquipParamKey(this.equipForm.equip_type)
      this.equipParamsJson = JSON.stringify(this.defaultParams[paramKey], null, 2)
      this.equipJsonError = ''
    },

    resetPetParams() {
      this.petParamsJson = JSON.stringify(this.defaultParams.pet, null, 2)
      this.petJsonError = ''
    },

    // ‰øùÂ≠òÂèÇÊï∞ÊñπÊ≥ï
    async saveRoleParams() {
      if (this.roleJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      this.roleSaving = true
      try {
        const params = JSON.parse(this.roleParamsJson)
        const response = await this.$api.config.updateSearchParam('role', params)

        if (response.code === 200) {
          this.$notify.success('ËßíËâ≤ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü')
          // Êõ¥Êñ∞Êú¨Âú∞ÈªòËÆ§ÂèÇÊï∞
          this.defaultParams.role = params
        } else {
          this.$notify.error({
            title: '‰øùÂ≠òÂ§±Ë¥•',
            message: response.message || '‰øùÂ≠òÂ§±Ë¥•'
          })
        }
      } catch (error) {
        console.error('‰øùÂ≠òËßíËâ≤ÂèÇÊï∞Â§±Ë¥•:', error)
        this.$notify.error({
          title: '‰øùÂ≠òÂ§±Ë¥•',
          message: '‰øùÂ≠òÂ§±Ë¥•: ' + error.message
        })
      } finally {
        this.roleSaving = false
      }
    },

    async saveEquipParams() {
      if (this.equipJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      this.equipSaving = true
      try {
        const params = JSON.parse(this.equipParamsJson)
        const paramType = this.getEquipParamKey(this.equipForm.equip_type)
        const response = await this.$api.config.updateSearchParam(paramType, params)

        if (response.code === 200) {
          this.$notify.success(`${this.getEquipTypeName(this.equipForm.equip_type)}ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü`)
          // Êõ¥Êñ∞Êú¨Âú∞ÈªòËÆ§ÂèÇÊï∞
          this.defaultParams[paramType] = params
        } else {
          this.$notify.error({
            title: '‰øùÂ≠òÂ§±Ë¥•',
            message: response.message || '‰øùÂ≠òÂ§±Ë¥•'
          })
        }
      } catch (error) {
        console.error('‰øùÂ≠òË£ÖÂ§áÂèÇÊï∞Â§±Ë¥•:', error)
        this.$notify.error({
          title: '‰øùÂ≠òÂ§±Ë¥•',
          message: '‰øùÂ≠òÂ§±Ë¥•: ' + error.message
        })
      } finally {
        this.equipSaving = false
      }
    },

    async savePetParams() {
      if (this.petJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      this.petSaving = true
      try {
        const params = JSON.parse(this.petParamsJson)
        const response = await this.$api.config.updateSearchParam('pet', params)

        if (response.code === 200) {
          this.$notify.success('ÂÆ†Áâ©ÂèÇÊï∞ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü')
          // Êõ¥Êñ∞Êú¨Âú∞ÈªòËÆ§ÂèÇÊï∞
          this.defaultParams.pet = params
        } else {
          this.$notify.error({
            title: '‰øùÂ≠òÂ§±Ë¥•',
            message: response.message || '‰øùÂ≠òÂ§±Ë¥•'
          })
        }
      } catch (error) {
        console.error('‰øùÂ≠òÂÆ†Áâ©ÂèÇÊï∞Â§±Ë¥•:', error)
        this.$notify.error({
          title: '‰øùÂ≠òÂ§±Ë¥•',
          message: '‰øùÂ≠òÂ§±Ë¥•: ' + error.message
        })
      } finally {
        this.petSaving = false
      }
    },

    // Âä†ËΩΩÁºìÂ≠òÂèÇÊï∞
    async loadCachedParams() {
      try {
        await this.loadSearchParams()
        this.$notify.success({
          title: 'ÁºìÂ≠òÂèÇÊï∞',
          message: 'ÁºìÂ≠òÂèÇÊï∞Â∑≤Âà∑Êñ∞'
        })
      } catch (error) {
        this.$notify.error({
          title: 'Ëé∑ÂèñÂ§±Ë¥•',
          message: 'Ëé∑ÂèñÁºìÂ≠òÂèÇÊï∞Â§±Ë¥•: ' + error.message
        })
      }
    },

    // ÂêØÂä®ËßíËâ≤Áà¨Ëô´
    async startRoleSpider() {
      if (this.isRunning) return

      if (!this.globalSettings.use_browser && this.roleJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      try {
        const params = {
          ...this.globalSettings, // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
          ...this.roleForm // ËßíËâ≤Áà¨Ëô´ÁâπÊúâÁöÑÂèÇÊï∞
        }

        // Â¶ÇÊûú‰∏ç‰ΩøÁî®ÊµèËßàÂô®ÔºåÊ∑ªÂä†ÁºìÂ≠òÂèÇÊï∞
        if (!params.use_browser) {
          params.cached_params = JSON.parse(this.roleParamsJson)
        }

        const response = await this.$api.spider.startRole(params)
        if (response.code === 200) {
          this.$notify.success({
            title: 'Áà¨Ëô´ÂêØÂä®',
            message: 'ËßíËâ≤Áà¨Ëô´Â∑≤ÂêØÂä®'
          })
          this.activeTab = 'role' // Á°Æ‰øùÂàáÊç¢Âà∞ËßíËâ≤tab
          this.isRunning = true // Á´ãÂç≥ËÆæÁΩÆËøêË°åÁä∂ÊÄÅ
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error({
            title: 'ÂêØÂä®Â§±Ë¥•',
            message: response.message || 'ÂêØÂä®Â§±Ë¥•'
          })
        }
      } catch (error) {
        this.$notify.error({
          title: 'ÂêØÂä®Â§±Ë¥•',
          message: 'ÂêØÂä®Â§±Ë¥•: ' + error.message
        })
      }
    },

    // ÂêØÂä®Ë£ÖÂ§áÁà¨Ëô´
    async startEquipSpider() {
      if (this.isRunning) return

      if (!this.equipForm.use_browser && this.equipJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      try {
        const params = {
          ...this.equipForm,
          ...this.globalSettings // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }

        // Â¶ÇÊûú‰∏ç‰ΩøÁî®ÊµèËßàÂô®ÔºåÊ∑ªÂä†ÁºìÂ≠òÂèÇÊï∞
        if (!params.use_browser) {
          params.cached_params = Object.assign(JSON.parse(this.equipParamsJson), JSON.parse(this.externalSearchParams))
        }

        const response = await this.$api.spider.startEquip(params)
        if (response.code === 200) {
          this.$notify.success({
            title: 'Áà¨Ëô´ÂêØÂä®',
            message: `${this.getEquipTypeName(this.equipForm.equip_type)}Áà¨Ëô´Â∑≤ÂêØÂä®`
          })
          this.activeTab = 'equip' // Á°Æ‰øùÂàáÊç¢Âà∞Ë£ÖÂ§átab
          this.isRunning = true // Á´ãÂç≥ËÆæÁΩÆËøêË°åÁä∂ÊÄÅ
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error({
            title: 'ÂêØÂä®Â§±Ë¥•',
            message: response.message || 'ÂêØÂä®Â§±Ë¥•'
          })
        }
      } catch (error) {
        this.$notify.error({
          title: 'ÂêØÂä®Â§±Ë¥•',
          message: 'ÂêØÂä®Â§±Ë¥•: ' + error.message
        })
      }
    },

    // ÂêØÂä®Âè¨Âî§ÂÖΩÁà¨Ëô´
    async startPetSpider() {
      if (this.isRunning) return

      if (!this.petForm.use_browser && this.petJsonError) {
        this.$notify.error('ËØ∑ÂÖà‰øÆÂ§çJSONÊ†ºÂºèÈîôËØØ')
        return
      }

      try {
        const params = {
          ...this.petForm,
          ...this.globalSettings // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }

        // Â¶ÇÊûú‰∏ç‰ΩøÁî®ÊµèËßàÂô®ÔºåÊ∑ªÂä†ÁºìÂ≠òÂèÇÊï∞
        if (!params.use_browser) {
          params.cached_params = JSON.parse(this.petParamsJson)
        }

        const response = await this.$api.spider.startPet(params)
        if (response.code === 200) {
          this.$notify.success({
            title: 'Áà¨Ëô´ÂêØÂä®',
            message: 'Âè¨Âî§ÂÖΩÁà¨Ëô´Â∑≤ÂêØÂä®'
          })
          this.activeTab = 'pet' // Á°Æ‰øùÂàáÊç¢Âà∞Âè¨Âî§ÂÖΩtab
          this.isRunning = true // Á´ãÂç≥ËÆæÁΩÆËøêË°åÁä∂ÊÄÅ
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error({
            title: 'ÂêØÂä®Â§±Ë¥•',
            message: response.message || 'ÂêØÂä®Â§±Ë¥•'
          })
        }
      } catch (error) {
        this.$notify.error({
          title: 'ÂêØÂä®Â§±Ë¥•',
          message: 'ÂêØÂä®Â§±Ë¥•: ' + error.message
        })
      }
    },

    // ÂêØÂä®‰ª£ÁêÜÁà¨Ëô´
    async startProxySpider() {
      if (this.isRunning) return

      try {
        const params = {
          ...this.proxyForm,
          ...this.globalSettings // ‰ΩøÁî®ÂÖ®Â±ÄËÆæÁΩÆ
        }

        const response = await this.$api.spider.startProxy(params)
        if (response.code === 200) {
          this.$notify.success({
            title: 'Áà¨Ëô´ÂêØÂä®',
            message: '‰ª£ÁêÜÁà¨Ëô´Â∑≤ÂêØÂä®'
          })
          // ‰ª£ÁêÜÁà¨Ëô´Ê≤°ÊúâÂØπÂ∫îÁöÑtabÔºå‰ΩøÁî®proxyÁ±ªÂûã
          this.isRunning = true
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error({
            title: 'ÂêØÂä®Â§±Ë¥•',
            message: response.message || 'ÂêØÂä®Â§±Ë¥•'
          })
        }
      } catch (error) {
        this.$notify.error({
          title: 'ÂêØÂä®Â§±Ë¥•',
          message: 'ÂêØÂä®Â§±Ë¥•: ' + error.message
        })
      }
    },

    // ÂêØÂä®PlaywrightÊî∂ÈõÜ
    async startPlaywrightCollector() {
      if (this.isRunning) return

      try {
        const params = {
          headless: this.playwrightForm.headless
          // ‰∏ç‰º†ÈÄítarget_urlÔºå‰ΩøÁî®ÂêéÁ´ØÈªòËÆ§ÂÄº
        }

        console.log('ÂêØÂä®PlaywrightÊî∂ÈõÜÔºåÂèÇÊï∞:', params)

        const response = await this.$api.spider.startPlaywright(params)
        if (response.code === 200) {
          this.$notify.success('PlaywrightÊî∂ÈõÜÂ∑≤ÂêØÂä®')
          this.activeTab = 'playwright'
          this.isRunning = true
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error(response.message || 'ÂêØÂä®Â§±Ë¥•')
        }
      } catch (error) {
        this.$notify.error('ÂêØÂä®Â§±Ë¥•: ' + error.message)
      }
    },

    // ÁÆ°ÁêÜ‰ª£ÁêÜ
    async manageProxies() {
      if (this.isRunning) return

      try {
        const response = await this.$api.spider.manageProxy()
        if (response.code === 200) {
          this.$notify.success('‰ª£ÁêÜÁÆ°ÁêÜÂô®Â∑≤ÂêØÂä®')
          this.isRunning = true
          // Ëá™Âä®ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.toggleLogStream()
          // ÂêØÂä®Áä∂ÊÄÅÁõëÊéß
          this.startStatusMonitor()
        } else {
          this.$notify.error(response.message || 'ÂêØÂä®Â§±Ë¥•')
        }
      } catch (error) {
        this.$notify.error('ÂêØÂä®Â§±Ë¥•: ' + error.message)
      }
    },
    // ÂÅúÊ≠¢‰ªªÂä°
    async stopTask() {
      try {
        const response = await this.$api.spider.stopTask()
        if (response.code === 200) {
          this.$notify.success(response.data?.message || '‰ªªÂä°Â∑≤ÂÅúÊ≠¢')
          this.isRunning = false
          // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.stopLogStream()
          // ÂÅúÊ≠¢Áä∂ÊÄÅÁõëÊéß
          this.stopStatusMonitor()
        } else {
          this.$notify.error(response.message || 'ÂÅúÊ≠¢Â§±Ë¥•')
        }
      } catch (error) {
        this.$notify.error('ÂÅúÊ≠¢Â§±Ë¥•: ' + error.message)
      }
    },

    // ÈáçÁΩÆ‰ªªÂä°Áä∂ÊÄÅ
    async resetTask() {
      try {
        const response = await this.$api.spider.resetTask()
        if (response.code === 200) {
          this.$notify.success(response.data?.message || '‰ªªÂä°Áä∂ÊÄÅÂ∑≤ÈáçÁΩÆ')
          this.isRunning = false
          // ÂÅúÊ≠¢ÂÆûÊó∂Êó•ÂøóÁõëÊéß
          this.stopLogStream()
          // ÂÅúÊ≠¢Áä∂ÊÄÅÁõëÊéß
          this.stopStatusMonitor()
        } else {
          this.$notify.error(response.message || 'ÈáçÁΩÆÂ§±Ë¥•')
        }
      } catch (error) {
        this.$notify.error('ÈáçÁΩÆÂ§±Ë¥•: ' + error.message)
      }
    },
    // Ëé∑ÂèñË£ÖÂ§áÁ±ªÂûãÂêçÁß∞
    getEquipTypeName(type) {
      const names = {
        normal: 'ÊôÆÈÄöË£ÖÂ§á',
        lingshi: 'ÁÅµÈ•∞Ë£ÖÂ§á',
        pet: 'ÂÆ†Áâ©Ë£ÖÂ§á'
      }
      return names[type] || 'Ë£ÖÂ§á'
    },

    // Êó•ÂøóÁõ∏ÂÖ≥ÊñπÊ≥ï
    async refreshLogs() {
      this.logsLoading = true
      try {
        const params = {
          lines: 100,
          type: this.selectedLogFile === 'current' ? 'current' : 'filename',
          spider_type: this.activeTab
        }

        // Â¶ÇÊûúÈÄâÊã©‰∫ÜÂÖ∑‰ΩìÁöÑÊñá‰ª∂ÔºåÊ∑ªÂä†filenameÂèÇÊï∞
        if (this.selectedLogFile && this.selectedLogFile !== 'current') {
          params.filename = this.selectedLogFile
        }

        const response = await this.$api.spider.getLogs(params)
        if (response.code === 200) {
          this.logs = response.data.logs || []
          this.logsInfo = response.data
          this.scrollToBottom()

          // Â¶ÇÊûú‰ªªÂä°Ê≠£Âú®ËøêË°åÔºåËß£ÊûêÊó•ÂøóËÆ°ÁÆóËøõÂ∫¶
          if (this.isRunning) {
            this.parseProgressFromLogs()
          }
        } else {
          this.$notify.error(response.message || 'Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•')
        }
      } catch (error) {
        this.$notify.error('Ëé∑ÂèñÊó•ÂøóÂ§±Ë¥•: ' + error.message)
      } finally {
        this.logsLoading = false
      }
    },

    toggleLogStream() {
      if (this.isLogStreaming) {
        this.stopLogStream()
        this.$notify.info('ÂÆûÊó∂Êó•ÂøóÁõëÊéßÂ∑≤ÂÅúÊ≠¢')
      } else {
        this.startLogStream()
        this.$notify.success('ÂÆûÊó∂Êó•ÂøóÁõëÊéßÂ∑≤ÂêØÂä®')
      }
    },

    startLogStream() {
      if (this.isLogStreaming) return

      try {
        this.logEventSource = this.$api.spider.streamLogs()
        this.isLogStreaming = true

        this.logEventSource.onmessage = (event) => {
          if (event.data) {
            try {
              // Â∞ùËØïËß£ÊûêJSONÊï∞ÊçÆ
              const data = JSON.parse(event.data)
              if (data.log) {
                this.logs.push(data.log)
              } else if (typeof data === 'string') {
                this.logs.push(data)
              }
            } catch (e) {
              // Â¶ÇÊûú‰∏çÊòØJSONÔºåÁõ¥Êé•‰Ωú‰∏∫Â≠óÁ¨¶‰∏≤Â§ÑÁêÜ
              this.logs.push(event.data)
            }

            // ‰øùÊåÅÊúÄÂ§ö1000Ë°åÊó•Âøó
            if (this.logs.length > 1000) {
              this.logs = this.logs.slice(-1000)
            }
            this.scrollToBottom()

            // Â¶ÇÊûú‰ªªÂä°Ê≠£Âú®ËøêË°åÔºåËß£ÊûêÊñ∞Êó•ÂøóËÆ°ÁÆóËøõÂ∫¶
            if (this.isRunning) {
              this.parseProgressFromLogs()
            }
          }
        }

        this.logEventSource.onerror = (error) => {
          console.error('Êó•ÂøóÊµÅÈîôËØØ:', error)
          // ÈîôËØØÊó∂‰∏çÂÅúÊ≠¢ÊµÅÔºåËÄåÊòØÂ∞ùËØïÈáçÊñ∞ËøûÊé•
          setTimeout(() => {
            if (this.isLogStreaming) {
              this.stopLogStream()
              this.startLogStream()
            }
          }, 5000)
        }

        this.logEventSource.onopen = () => {
          console.log('Êó•ÂøóÊµÅËøûÊé•Â∑≤Âª∫Á´ã')
        }

        // Âè™Âú®ÊâãÂä®ÂêØÂä®Êó∂ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÔºåÈÅøÂÖçÈ°µÈù¢Âä†ËΩΩÊó∂ÊòæÁ§∫
        if (this.logs.length === 0) {
          this.logs.push('ÂÆûÊó∂Êó•ÂøóÁõëÊéßÂ∑≤ÂêØÂä®ÔºåÁ≠âÂæÖÊó•ÂøóÊï∞ÊçÆ...')
        }

        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        this.$notify.success('ÂÆûÊó∂Êó•ÂøóÁõëÊéßÂ∑≤ÂêØÂä®')
      } catch (error) {
        console.error('ÂêØÂä®ÂÆûÊó∂Êó•ÂøóÁõëÊéßÂ§±Ë¥•:', error)
        // ÈùôÈªòÂ§ÑÁêÜÈîôËØØÔºåÈÅøÂÖçÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
      }
    },

    stopLogStream() {
      if (this.logEventSource) {
        try {
          this.logEventSource.close()
        } catch (e) {
          console.log('ÂÖ≥Èó≠Êó•ÂøóÊµÅËøûÊé•:', e)
        }
        this.logEventSource = null
      }
      this.isLogStreaming = false
    },

    clearLogs() {
      this.logs = []
      this.logsInfo = null
    },

    scrollToBottom() {
      this.$nextTick(() => {
        const container = this.$refs.logsContainer
        if (container) {
          container.scrollTop = container.scrollHeight
        }
      })
    },

    getLogLevel(log) {
      if (log.includes('ERROR') || log.includes('ÈîôËØØ')) return 'log-error'
      if (log.includes('WARNING') || log.includes('Ë≠¶Âëä')) return 'log-warning'
      if (log.includes('INFO') || log.includes('‰ø°ÊÅØ')) return 'log-info'
      return 'log-default'
    },

    getLogTime(log) {
      // ÊèêÂèñÊó•ÂøóÊó∂Èó¥Êà≥
      const timeMatch = log.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/)
      return timeMatch ? timeMatch[1] : ''
    },

    getLogContent(log) {
      // ÁßªÈô§Êó∂Èó¥Êà≥ÔºåËøîÂõûÊó•ÂøóÂÜÖÂÆπ
      return log.replace(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}[,\d]*\s*/, '')
    },

    onLogFileChange(value) {
      this.selectedLogFile = value

      // Â¶ÇÊûúÊ≠£Âú®ÂÆûÊó∂ÁõëÊéßÔºåÂÅúÊ≠¢ÂÆÉ
      if (this.isLogStreaming) {
        this.stopLogStream()
        this.$notify.info('Â∑≤ÂàáÊç¢Âà∞ÂéÜÂè≤Êó•ÂøóÔºåÂÆûÊó∂ÁõëÊéßÂ∑≤ÂÅúÊ≠¢')
      }

      // Âà∑Êñ∞Êó•Âøó
      this.refreshLogs()
    },

    async loadLogFiles() {
      try {
        const response = await this.$api.spider.getLogFiles()
        if (response.code === 200) {
          this.logFiles = response.data.items || []
        } else {
          console.error('Ëé∑ÂèñÊó•ÂøóÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', response.message)
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÊó•ÂøóÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error)
      }
    },

    // Áä∂ÊÄÅÁõëÊéßÊñπÊ≥ï
    startStatusMonitor() {
      // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÂÆöÊó∂Âô®
      this.stopStatusMonitor()

      // ÂêØÂä®Áä∂ÊÄÅÁõëÊéßÂÆöÊó∂Âô®
      this.statusMonitor = setInterval(async () => {
        await this.checkTaskStatus()
      }, 2000) // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°Áä∂ÊÄÅ
    },

    // Ê£ÄÊü•‰ªªÂä°Áä∂ÊÄÅ
    async checkTaskStatus() {
      try {
        const response = await this.$api.spider.getStatus()
        if (response.code === 200) {
          this.taskStatus = response.data
          const status = response.data.status

          // Êõ¥Êñ∞ËøêË°åÁä∂ÊÄÅ
          this.isRunning = (status === 'running')

          // Â¶ÇÊûú‰ªªÂä°Ê≠£Âú®ËøêË°åÔºåËß£ÊûêÊó•ÂøóËÆ°ÁÆóËøõÂ∫¶
          if (status === 'running') {
            this.parseProgressFromLogs()
          }

          // Â¶ÇÊûú‰ªªÂä°ÂÆåÊàêÊàñÂá∫ÈîôÔºåÊòæÁ§∫Ê∂àÊÅØÂπ∂ÂÅúÊ≠¢ÁõëÊéß
          if (status === 'completed' || status === 'error' || status === 'stopped') {
            if (status === 'error') {
              this.$notify.error(response.data.message || '‰ªªÂä°ÊâßË°åÂá∫Èîô')
            } else if (status === 'stopped') {
              this.$notify.info(response.data.message || '‰ªªÂä°Â∑≤ÂÅúÊ≠¢')
            }

            // ÂÅúÊ≠¢Êó•ÂøóÊµÅ
            this.stopLogStream()

            // ÂÅúÊ≠¢Áä∂ÊÄÅÁõëÊéß
            this.stopStatusMonitor()
          }
        }
      } catch (error) {
        console.error('Áä∂ÊÄÅÁõëÊéßÈîôËØØ:', error)
      }
    },

    // ‰ªéÊó•ÂøóËß£ÊûêËøõÂ∫¶ - Á≤æÁÆÄÁâàÔºåÁõ¥Êé•Ê≠£ÂàôÊèêÂèñËøõÂ∫¶ÁôæÂàÜÊØî
    parseProgressFromLogs() {
      if (!this.logs || this.logs.length === 0) return

      let progress = 0
      let message = 'Ê≠£Âú®ËøêË°å...'
      let status = 'running'

      // ‰ªéÂêéÂæÄÂâçÊâæÊúÄÊñ∞ÁöÑËøõÂ∫¶Êó•Âøó
      for (let i = this.logs.length - 1; i >= 0; i--) {
        const log = this.logs[i]

        // ÂåπÈÖçËøõÂ∫¶ÁôæÂàÜÊØî
        const progressMatch = log.match(/ËøõÂ∫¶\[(\d+)%\]/)
        if (progressMatch) {
          progress = parseInt(progressMatch[1])
          message = log
          break
        }

        // Ê£ÄÊü•ÂÆåÊàê‰ø°ÊÅØ
        if (log.includes('Áà¨ÂèñÂÆåÊàê')) {
          status = 'completed'
          message = log
          progress = 100
          break
        }

        // Ê£ÄÊü•ÈîôËØØ‰ø°ÊÅØ
        if (log.includes('ERROR') || log.includes('ÈîôËØØ') || log.includes('Â§±Ë¥•')) {
          status = 'error'
          message = log
          break
        }
      }

      // Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
      if (this.taskStatus) {
        this.taskStatus.progress = progress
        this.taskStatus.message = message

        if (status === 'completed') {
          this.taskStatus.status = 'completed'
        } else if (status === 'error') {
          this.taskStatus.status = 'error'
        }
      }
    },

    stopStatusMonitor() {
      if (this.statusMonitor) {
        clearInterval(this.statusMonitor)
        this.statusMonitor = null
      }
    },

    // Ëé∑ÂèñÁä∂ÊÄÅÁ±ªÂûã
    getStatusType(status) {
      const typeMap = {
        'idle': 'info',
        'running': 'primary',
        'completed': 'success',
        'error': 'danger',
        'stopped': 'warning'
      }
      return typeMap[status] || 'info'
    },

    // Ëé∑ÂèñËøõÂ∫¶Áä∂ÊÄÅ
    getProgressStatus(status) {
      const statusMap = {
        'idle': '',
        'running': '',
        'completed': 'success',
        'error': 'exception',
        'stopped': 'warning'
      }
      return statusMap[status] || ''
    },

    // Â∫îÁî®ÂÖ®Â±ÄËÆæÁΩÆÂà∞ÊâÄÊúâÁà¨Ëô´
    async applyGlobalSettings() {
      this.$notify.info('Ê≠£Âú®Â∫îÁî®ÂÖ®Â±ÄËÆæÁΩÆÂà∞ÊâÄÊúâÁà¨Ëô´...')

      try {
        // Êõ¥Êñ∞ËßíËâ≤ÂèÇÊï∞
        if (this.defaultParams.role) {
          this.defaultParams.role.max_pages = this.globalSettings.max_pages
          this.defaultParams.role.delay_min = this.globalSettings.delay_min
          this.defaultParams.role.delay_max = this.globalSettings.delay_max
          await this.saveRoleParams()
        }

        // Êõ¥Êñ∞ÊâÄÊúâË£ÖÂ§áÁ±ªÂûãÂèÇÊï∞
        const equipTypes = ['equip_normal', 'equip_lingshi', 'equip_pet_equip']
        for (const equipType of equipTypes) {
          if (this.defaultParams[equipType]) {
            this.defaultParams[equipType].max_pages = this.globalSettings.max_pages
            this.defaultParams[equipType].delay_min = this.globalSettings.delay_min
            this.defaultParams[equipType].delay_max = this.globalSettings.delay_max

            // ‰øùÂ≠òÂà∞ÂêéÁ´Ø
            const response = await this.$api.config.updateSearchParam(equipType, this.defaultParams[equipType])
            if (response.code !== 200) {
              console.warn(`‰øùÂ≠ò${equipType}ÂèÇÊï∞Â§±Ë¥•:`, response.message)
            }
          }
        }

        // Êõ¥Êñ∞ÂÆ†Áâ©ÂèÇÊï∞
        if (this.defaultParams.pet) {
          this.defaultParams.pet.max_pages = this.globalSettings.max_pages
          this.defaultParams.pet.delay_min = this.globalSettings.delay_min
          this.defaultParams.pet.delay_max = this.globalSettings.delay_max
          await this.savePetParams()
        }

        // ÈáçÊñ∞ÂàùÂßãÂåñJSONÁºñËæëÂô®
        this.initializeDefaultParams()

        this.$notify.success('ÂÖ®Â±ÄËÆæÁΩÆÂ∑≤Â∫îÁî®Âà∞ÊâÄÊúâÁà¨Ëô´ÔºÅ')
      } catch (error) {
        console.error('Â∫îÁî®ÂÖ®Â±ÄËÆæÁΩÆÂ§±Ë¥•:', error)
        this.$notify.error('Â∫îÁî®ÂÖ®Â±ÄËÆæÁΩÆÂ§±Ë¥•: ' + error.message)
      }
    },

    // ÈáçÁΩÆÂÖ®Â±ÄËÆæÁΩÆ‰∏∫ÈªòËÆ§ÂÄº
    resetGlobalSettings() {
      this.globalSettings = {
        max_pages: 5,
        delay_min: 8,
        delay_max: 20,
        use_browser: false
      }
      this.$notify.info('ÂÖ®Â±ÄËÆæÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§ÂÄº')
    },

    // ÂÖ®Â±Ä‰ΩøÁî®ÊµèËßàÂô®Ê®°ÂºèÂàáÊç¢
    onGlobalBrowserToggle(useBrowser) {
      // Â¶ÇÊûúÂÖ®Â±Ä‰ΩøÁî®ÊµèËßàÂô®ÔºåÂàôÊâÄÊúâÁà¨Ëô´ÈÉΩ‰ΩøÁî®ÊµèËßàÂô®
      if (useBrowser) {
        this.roleForm.use_browser = true
        this.equipForm.use_browser = true
        this.petForm.use_browser = true
        this.loadCachedParams() // Âä†ËΩΩÁºìÂ≠òÂèÇÊï∞
      } else {
        // Â¶ÇÊûúÂÖ®Â±Ä‰∏ç‰ΩøÁî®ÊµèËßàÂô®ÔºåÂàôÊâÄÊúâÁà¨Ëô´ÈÉΩ‰∏ç‰ΩøÁî®ÊµèËßàÂô®
        this.roleForm.use_browser = false
        this.equipForm.use_browser = false
        this.petForm.use_browser = false
        this.loadCachedParams() // Âä†ËΩΩÁºìÂ≠òÂèÇÊï∞
      }
    },
  }
}
</script>

<style scoped>
/* Âç°ÁâáÊ†∑Âºè */
.spider-config-card,
.logs-card,
.spider-card {
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: bold;
  font-size: 16px;
}

/* Áä∂ÊÄÅÂå∫ÂüüÊ†∑Âºè */
.status-content {
  padding: 10px 0;
}

.status-item {
  display: flex;
  align-items: center;
}

.status-label {
  font-weight: bold;
  margin-right: 10px;
}

/* ËøõÂ∫¶Êù°Ê†∑Âºè */
.progress-wrapper {
  flex: 1;
  margin-left: 10px;
}

.status-item .el-progress {
  width: 100%;
}

.status-item .el-progress__text {
  font-size: 12px;
  color: #606266;
  font-weight: 500;
}

.status-item .el-progress-bar__outer {
  background-color: #f0f0f0;
  border-radius: 4px;
  height: 8px;
}

.status-item .el-progress-bar__inner {
  border-radius: 4px;
  transition: width 0.3s ease;
  background: linear-gradient(90deg, #409eff 0%, #67c23a 100%);
}

/* Â∑•ÂÖ∑ÊåâÈíÆÂå∫Âüü */
.tool-buttons {
  padding: 10px 0;
}

/* ÂèÇÊï∞ÁºñËæëÂô®Ê†∑Âºè */
.params-editor {
  background-color: #f9f9f9;
  padding: 15px;
  border-radius: 6px;
  margin: 15px 0;
  border-left: 4px solid #409eff;
}

.params-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px solid #e4e7ed;
}

.json-editor-wrapper {
  position: relative;
}

.json-editor {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.4;
}

.json-editor textarea {
  background-color: #2d3748;
  color: #e2e8f0;
  border: 1px solid #4a5568;
  border-radius: 4px;
  padding: 12px;
}

.json-editor textarea:focus {
  border-color: #409eff;
  box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
}

.json-error {
  margin-top: 8px;
  padding: 8px 12px;
  background-color: #fef0f0;
  border: 1px solid #fbc4c4;
  border-radius: 4px;
  color: #f56c6c;
  font-size: 12px;
  line-height: 1.4;
}

.json-error i {
  margin-right: 4px;
}

/* Êó•ÂøóÁõ∏ÂÖ≥Ê†∑Âºè */
.logs-content {
  padding: 10px 0;
}

.logs-info {
  margin-bottom: 15px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.logs-container {
  height: 400px;
  overflow-y: auto;
  background-color: #1e1e1e;
  border-radius: 6px;
  padding: 15px;
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.4;
}

.no-logs {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #666;
}

.no-logs i {
  font-size: 48px;
  margin-bottom: 10px;
}

.log-lines {
  display: flex;
  flex-direction: column;
}

.log-line {
  padding: 2px 0;
  display: flex;
  align-items: flex-start;
  word-break: break-all;
}

.log-time {
  color: #888;
  min-width: 150px;
  margin-right: 10px;
  flex-shrink: 0;
}

.log-content {
  color: #e2e8f0;
  flex: 1;
}

.log-error {
  background-color: rgba(245, 108, 108, 0.1);
  border-left: 3px solid #f56c6c;
  padding-left: 10px;
}

.log-error .log-content {
  color: #f56c6c;
}

.log-warning {
  background-color: rgba(230, 162, 60, 0.1);
  border-left: 3px solid #e6a23c;
  padding-left: 10px;
}

.log-warning .log-content {
  color: #e6a23c;
}

.log-info {
  background-color: rgba(64, 158, 255, 0.1);
  border-left: 3px solid #409eff;
  padding-left: 10px;
}

.log-info .log-content {
  color: #409eff;
}

.log-default .log-content {
  color: #e2e8f0;
}

/* Ë°®ÂçïÊèêÁ§∫Ê†∑Âºè */
.form-tip {
  margin-left: 10px;
  color: #909399;
  font-size: 12px;
}

/* ÂõæÊ†áÂíåÈ¢úËâ≤Ê†∑Âºè */
.emoji-icon {
  font-size: 18px;
  margin-right: 5px;
}

.cBlue {
  color: #409eff;
  font-weight: bold;
}
</style>
