<template>
  <div class="equipment-list-view">
    <el-card class="filters" shadow="never">
      <div slot="header" class="card-header">
        <div><span class="emoji-icon">üîç</span> Á≠õÈÄâ</div>
      </div>
      <!-- Á≠õÈÄâÂíåÊêúÁ¥¢Ë°®Âçï -->
      <el-form :inline="true" :model="filters" @submit.native.prevent="fetchEquipments" size="mini">
        <!-- <el-form-item label="ÈÄâÊã©Êúà‰ªΩ">
          <el-date-picker v-model="filters.selectedDate" :clearable="false" type="month" placeholder="ÈÄâÊã©Êúà‰ªΩ"
            format="yyyy-MM" value-format="yyyy-MM" />
        </el-form-item> -->
        <el-form-item label="Ë£ÖÂ§áÂ∫èÂàóÂè∑">
          <el-input v-model="filters.equip_sn" placeholder="Ë£ÖÂ§áÂ∫èÂàóÂè∑"></el-input>
        </el-form-item>
        <el-form-item label="Á≠âÁ∫ßËåÉÂõ¥">
          <div style="width: 500px">
            <el-slider v-model="filters.level_range" range :min="60" :max="160" :step="5" show-input show-input-controls
              :marks="levelMarks" @change="handleLevelRangeChange" />
          </div>
        </el-form-item>
        <el-form-item label="‰ª∑Ê†ºËåÉÂõ¥">
          <el-input-number v-model="filters.price_min" placeholder="ÊúÄ‰Ωé‰ª∑Ê†º" :min="0" :controls="false"></el-input-number>
          -
          <el-input-number v-model="filters.price_max" placeholder="ÊúÄÈ´ò‰ª∑Ê†º" :min="0" :controls="false"></el-input-number>
        </el-form-item>
        <el-form-item label="Á±ªÂûã">
          <el-cascader v-model="filters.kindid" :options="kindidOptions" placeholder="ËØ∑ÈÄâÊã©Ë£ÖÂ§áÁ±ªÂûã" multiple clearable
            filterable collapse-tags collapse-tags-tooltip :props="{
              multiple: true,
              emitPath: false
            }" @change="handleKindidChange">
          </el-cascader>
        </el-form-item>
        <!-- Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÈÄâÊã©Âô® -->
        <el-form-item v-if="showPetEquipType" label="Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûã">
          <el-cascader v-model="filters.equip_type" :options="petEquipTypeOptions" :props="cascaderProps"
            placeholder="ËØ∑ÈÄâÊã©Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûã" multiple clearable filterable collapse-tags collapse-tags-tooltip>
          </el-cascader>
        </el-form-item>
        <el-form-item label="ÁâπÊäÄ">
          <el-select v-model="filters.equip_special_skills" placeholder="ËØ∑ÈÄâÊã©ÁâπÊäÄ" multiple clearable filterable>
            <el-option v-for="[value, label] in equip_special_skills" :key="value" :label="label" :value="value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="ÁâπÊïà">
          <el-select v-model="filters.equip_special_effect" placeholder="ËØ∑ÈÄâÊã©ÁâπÊïà" multiple clearable filterable>
            <el-option v-for="(label, value) in equip_special_effect" :key="value"
              :label="value === '1' ? label + '/Ë∂ÖÁ∫ßÁÆÄÊòì' : label" :value="value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="Â•óË£Ö">
          <el-cascader v-model="filters.suit_effect" :options="suitOptions" placeholder="ËØ∑ÈÄâÊã©Â•óË£ÖÊïàÊûú" separator="" clearable
            filterable @change="handleSuitChange" />
        </el-form-item>
        <el-form-item label="Èï∂ÂµåÂÆùÁü≥">
          <el-select v-model="filters.gem_value" placeholder="Èï∂ÂµåÂÆùÁü≥" clearable filterable style="width: 100px">
            <el-option v-for="(gemName, value) in gems_name" :key="value" :value="value" :label="gemName">
              <el-row type="flex" justify="space-between">
                <el-col style="width: 34px; height: 34px; margin-right: 10px">
                  <el-image style="width: 34px; height: 34px; cursor: pointer"
                    :src="getImageUrl(gem_image[value] + '.gif')" fit="cover" referrerpolicy="no-referrer">
                  </el-image>
                </el-col>
                <el-col style="width: 100px">
                  {{ gemName }}
                </el-col>
              </el-row>
            </el-option>
          </el-select>
          <el-input-number size="mini" v-model="filters.gem_level" :min="0" :max="16" :step="1" style="width: 120px"
            placeholder="ÈîªÁªÉÁ≠âÁ∫ß" controls-equip_type="right"></el-input-number>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="fetchEquipments">Êü•ËØ¢</el-button>
        </el-form-item>
      </el-form>
    </el-card>
    <el-table :data="equipments" stripe style="width: 100%" @sort-change="handleSortChange" :key="tableKey"
      v-loading="tableLoading">
      <el-table-column prop="eid" label="Êìç‰Ωú" width="100" fixed>
        <template #default="scope">
          <el-link :href="getCBGLinkByType(scope.row.eid, 'equip')" type="danger" target="_blank">ËóèÂÆùÈòÅ</el-link>
          <el-divider direction="vertical"></el-divider>
          <SimilarEquipmentModal :equipment="scope.row" :key="scope.row.equip_sn" />
        </template>
      </el-table-column>
      <el-table-column fixed label="Ë£ÖÂ§á" width=" 70">
        <template #default="scope">
          <EquipmentImage :equipment="scope.row" />
        </template>
      </el-table-column>
      <el-table-column fixed prop="price" label="‰ª∑Ê†º (ÂÖÉ)" width="100" sortable="custom">
        <template #default="scope">
          {{ scope.row.server_name }}
          <div v-html="formatFullPrice(scope.row)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="highlight" label="‰∫ÆÁÇπ"  width="100"  align="center" sortable="custom">
        <template slot-scope="scope">
          <span v-html="gen_highlight(scope.row.highlight)"></span>
        </template>
      </el-table-column>
      <el-table-column prop="dynamic_tags" label="Âä®ÊÄÅ"  width="100"  align="center" sortable="custom">
        <template slot-scope="scope">
          <span v-html="gen_dynamic_tags(scope.row.dynamic_tags)"></span>
        </template>
      </el-table-column>
      <el-table-column prop="gem_level" label="ÂÆùÁü≥" width="100"  sortable="custom">
        <template #default="scope">
          <div class="gem-container">
            <el-badge v-if="scope.row.gem_level || scope.row.jinglian_level || scope.row.xiang_qian_level"
              :value="scope.row.gem_level * 1 || scope.row.jinglian_level * 1 || scope.row.xiang_qian_level * 1"
              class="gem-badge">
              <div class="gem-images">
                <el-image v-for="gemImgSrc in getGemImageByGemValue(scope.row)" :key="gemImgSrc"
                  style="width: 30px; height: 30px; cursor: pointer; margin-right: 2px" :src="gemImgSrc" fit="cover"
                  referrerpolicy="no-referrer">
                </el-image>
              </div>
            </el-badge>
          </div>
        </template>
      </el-table-column>
      <el-table-column prop="special_effect" label="ÁâπÊäÄ/ÁâπÊïà" width="120" sortable="custom">
        <template #default="scope">
          <div class="equip_desc_blue" :data-specia-effet="scope.row.special_effect"
            :data-special-skill="scope.row.special_skill" v-html="formatSpecialSkillsAndEffects(scope.row)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="suit_effect" label="Â•óË£Ö" width="160"  sortable="custom">
        <template #default="scope">
          <div class="equip_desc_blue" v-html="formatSuitEffect(scope.row)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="agg_added_attrs" label="ÈôÑÂä†Â±ûÊÄß" width="150" sortable="custom">
        <template #default="scope">
          <div class="cBlue" v-html="formatAddedAttrs(scope.row.agg_added_attrs)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="equip_level" label="Á≠âÁ∫ß" width="80" sortable="custom"></el-table-column>
      <el-table-column prop="all_damage" label="ÊÄª‰º§" width="80" sortable="custom"></el-table-column>
      <el-table-column prop="init_damage" label="Âàù‰º§" width="80" sortable="custom">
        <template #default="scope">
          <span class="cBlue">{{ scope.row.init_damage || scope.row.damage || scope.row.shanghai || '' }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="init_wakan" label="ÂàùÁÅµ" width="80" sortable="custom">
        <template #default="scope">
          <span class="cBlue">{{
            scope.row.init_wakan ||
            (scope.row.magic_damage
              ? `Ê≥ïÊúØ‰º§ÂÆ≥
            +${scope.row.magic_damage}`
              : '')
          }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="init_defense" label="ÂàùÈò≤" width="80" sortable="custom">
        <template #default="scope">
          <span class="cBlue">{{
            scope.row.init_defense ||
            scope.row.defense ||
            scope.row.fangyu ||
            (scope.row.magic_defense
              ? `Ê≥ïÊúØÈò≤Âæ°
            +${scope.row.magic_defense}`
              : '')
          }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="init_hp" label="ÂàùË°Ä" width="80" sortable="custom">
        <template #default="scope">
          <span class="cBlue">{{ scope.row.init_hp || scope.row.qixue || '' }}</span>
        </template>
      </el-table-column>
      <el-table-column prop="init_dex" label="ÂàùÊïè" width="80" sortable="custom">
        <template #default="scope">
          <span class="cBlue">{{ scope.row.init_dex || scope.row.speed || '' }}</span>
        </template>
      </el-table-column>
      <el-table-column label="Êìç‰Ωú" width="100">
        <template #default="scope">
          <el-link href="javascript:void(0)" type="danger" @click.native="handleDelete(scope.row)">Âà†Èô§</el-link>
        </template>
      </el-table-column>
    </el-table>
    <div class="pagination-container">
      <el-pagination @current-change="handlePageChange" :current-page="pagination.page" @size-change="handleSizeChange"
        :page-size="pagination.page_size" :page-sizes="[10, 100, 200, 300, 400]"
        layout="total, sizes, prev, pager, next, jumper" :total="pagination.total">
      </el-pagination>
    </div>
  </div>
</template>

<script>
import SimilarEquipmentModal from '@/components/SimilarEquipmentModal.vue'
import EquipmentImage from '@/components/EquipmentImage/EquipmentImage.vue'
// import dayjs from 'dayjs'
import { equipmentMixin } from '@/utils/mixins/equipmentMixin'
import { commonMixin } from '@/utils/mixins/commonMixin'
//CBG_GAME_CONFIG.pet_equip_class0
window.petEquipTypes = [
  {
    key: '1',
    catagory: 'Èì†Áî≤',
    items: []
  },
  {
    key: '2',
    catagory: 'È°πÂúà',
    items: []
  },
  {
    key: '3',
    catagory: 'Êä§ËÖï',
    items: []
  }
]

for (var keyIndex in window.CBG_GAME_CONFIG.equip_info) {
  if (keyIndex >= 9101 && keyIndex <= 9316) {
    const current = window.CBG_GAME_CONFIG.equip_info[keyIndex]
    const level = current.desc.match(/Á≠âÁ∫ß(\d+)/)[1]
    if (keyIndex >= 9101 && keyIndex <= 9116) {
      window.petEquipTypes[0].items.push({
        ...current,
        keyIndex: parseInt(keyIndex),
        level
      })

    } else if (keyIndex >= 9201 && keyIndex <= 9216) {
      window.petEquipTypes[1].items.push({
        ...current,
        keyIndex: parseInt(keyIndex),
        level
      })

    } else if (keyIndex >= 9301 && keyIndex <= 9316) {
      window.petEquipTypes[2].items.push({
        ...current,
        keyIndex: parseInt(keyIndex),
        level
      })

    }
  }
}
// value: 'keyIndex',
// label: 'name',
// children: 'items',
const kindidOptions = [{
  value: -1,
  label: '‰∫∫Áâ©Ë£ÖÂ§á',
  children: window.AUTO_SEARCH_CONFIG.weapon_armors.map(([value, label]) => ({ value, label }))
}, {
  value: -2,
  label: 'ÁÅµÈ•∞',
  children: window.lingshiKinds.map(([value, label]) => ({ value, label }))
}, {
  value: 29,
  label: 'Âè¨Âî§ÂÖΩË£ÖÂ§á'
}]
export default {
  name: 'EquipmentList',
  components: {
    SimilarEquipmentModal,
    EquipmentImage
  },
  mixins: [equipmentMixin, commonMixin],
  data() {
    return {
      tableLoading: false, // Ë°®Ê†ºÂä†ËΩΩÁä∂ÊÄÅ
      kindidOptions,
      equip_special_skills: window.AUTO_SEARCH_CONFIG.equip_special_skills,
      equip_special_effect: window.AUTO_SEARCH_CONFIG.equip_special_effect,
      equipments: [],
      filters: {
        equip_sn: '',
        //selectedDate: dayjs().format('YYYY-MM'),
        level_range: [60, 160],
        price_min: undefined,
        price_max: undefined,
        kindid: [],
        equip_type: [], // Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÔºàÂ§öÈÄâÔºâ
        equip_special_skills: [],
        equip_special_effect: [],
        suit_effect: [],
        gem_value: undefined,
        gem_level: undefined,
        sort_by: '',
        sort_order: ''
      },
      pagination: {
        page: 1,
        page_size: 10,
        total: 0
      },
      levelMarks: {
        80: '80',
        100: '100',
        120: '120'
      },
      suitOptions: [],
      gems_name: window.AUTO_SEARCH_CONFIG.gems_name,
      gem_image: {
        1: '4011',
        2: '4002',
        3: '4012',
        4: '4004',
        5: '4003',
        6: '4010',
        7: '4005',
        8: '4007',
        9: '4006',
        10: '4008',
        11: '4009',
        12: '1108_4249',
        4244: '4244',
        '755_4036': '755_4036',
        '756_4037': '756_4037',
        '757_4038': '757_4038'
      },

      // Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÈÖçÁΩÆ
      petEquipTypes: window.petEquipTypes,

      // Á∫ßËÅîÈÄâÊã©Âô®ÈÖçÁΩÆ
      cascaderProps: {
        value: 'keyIndex',
        label: 'name',
        children: 'items',
        multiple: true,
        emitPath: false
      },

      // Ë°®Ê†ºÈáçÊñ∞Ê∏≤ÊüìÁöÑkey
      tableKey: 0,

      // URLÂèÇÊï∞ÂêåÊ≠•Áõ∏ÂÖ≥
      isInitializing: true // Ê†áËÆ∞ÊòØÂê¶Ê≠£Âú®ÂàùÂßãÂåñÔºåÈÅøÂÖçÂàùÂßãÂåñÊó∂Ëß¶ÂèëURLÊõ¥Êñ∞
    }
  },
  computed: {
    // ÊòØÂê¶ÊòæÁ§∫Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÈÄâÊã©Âô®
    showPetEquipType() {
      return this.filters.kindid && this.filters.kindid.includes(29)
    },

    // Á∫ßËÅîÈÄâÊã©Âô®ÈÄâÈ°πÊï∞ÊçÆ
    petEquipTypeOptions() {
      return this.petEquipTypes.map(category => ({
        keyIndex: category.key,
        name: category.catagory,
        items: category.items.map(item => ({
          keyIndex: item.keyIndex,
          name: `${item.name}Ôºà${item.level}Á∫ßÔºâ`,
          level: item.level
        }))
      }))
    },
  },
  watch: {
    // ÁõëÂê¨showPetEquipTypeÂèòÂåñÔºåÂº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º
    showPetEquipType() {
      this.tableKey += 1
    },
  },
  methods: {
    async handleDelete(row) {
      try {
        // Á°ÆËÆ§Âà†Èô§
        await this.$confirm(
          `Á°ÆÂÆöË¶ÅÂà†Èô§Ë£ÖÂ§á ${row.equip_name || row.equip_sn} ÂêóÔºü`,
          'Á°ÆËÆ§Âà†Èô§',
          {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        )

        // Ëé∑ÂèñÂΩìÂâçÂπ¥Êúà
        //const [year, month] = this.filters.selectedDate.split('-')

        // Ë∞ÉÁî®Âà†Èô§API
        const response = await this.$api.equipment.deleteEquipment(row.equip_sn)

        if (response.code === 200) {
          this.$notify.success({
            title: 'ÊàêÂäü',
            message: 'Ë£ÖÂ§áÂà†Èô§ÊàêÂäü'
          })
          // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
          await this.fetchEquipments()
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'Âà†Èô§Â§±Ë¥•'
          })
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('Âà†Èô§Ë£ÖÂ§áÂ§±Ë¥•:', error)
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: 'Âà†Èô§Ë£ÖÂ§áÂ§±Ë¥•'
          })
        }
      }
    },
    async fetchEquipments() {
      // const [year, month] = this.filters.selectedDate.split('-')
      try {
        this.tableLoading = true // ÂºÄÂßãÂä†ËΩΩÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        const params = {
          ...this.filters,
          // year,
          // month,
          page: this.pagination.page,
          page_size: this.pagination.page_size
        }

        // Â§ÑÁêÜÁ≠âÁ∫ßËåÉÂõ¥ÊªëÂùóÂÄº
        if (this.filters.level_range && Array.isArray(this.filters.level_range)) {
          params.level_min = this.filters.level_range[0]
          params.level_max = this.filters.level_range[1]
          delete params.level_range
        }

        // Â§ÑÁêÜÂ•óË£ÖÁ∫ßËÅîÈÄâÊã©Âô®ÁöÑÂÄº
        if (
          this.filters.suit_effect &&
          Array.isArray(this.filters.suit_effect) &&
          this.filters.suit_effect.length === 2
        ) {
          const [suitType, suitValue] = this.filters.suit_effect
          const actualValue = suitValue.split('_').pop() // ÊèêÂèñÁúüÂÆûÁöÑÂ•óË£ÖID

          if (suitType === 'added_status') {
            params.suit_added_status = actualValue
          } else if (suitType === 'suit_effects') {
            params.suit_effect = actualValue
          } else if (suitType === 'transform_skills') {
            params.suit_transform_skills = actualValue
          } else if (suitType === 'transform_charms') {
            params.suit_transform_charms = actualValue
          }

          // Âè™ÊúâÂú®Ê≤°ÊúâËÆæÁΩÆ‰ªª‰ΩïÂ•óË£ÖÂèÇÊï∞Êó∂ÊâçÂà†Èô§ÂéüÂßãÁöÑsuit_effect
          if (
            !params.suit_added_status &&
            !params.suit_effect &&
            !params.suit_transform_skills &&
            !params.suit_transform_charms
          ) {
            delete params.suit_effect
          }
        } else {
          // ÂΩìÊ≤°ÊúâÈÄâÊã©Â•óË£ÖÊó∂ÔºåÂà†Èô§ÂéüÂßãÁöÑsuit_effectÂ≠óÊÆµ
          delete params.suit_effect
        }

        // ÁßªÈô§Á©∫ÁöÑÁ≠õÈÄâÊù°‰ª∂
        Object.keys(params).forEach((key) => {
          if (
            params[key] === null ||
            params[key] === '' ||
            (Array.isArray(params[key]) && params[key].length === 0)
          ) {
            delete params[key]
          }
        })

        // ÁâπÊÆäÂ§ÑÁêÜÔºöÂ¶ÇÊûú‰∏çÊòØÂè¨Âî§ÂÖΩË£ÖÂ§áÔºåÁßªÈô§equip_typeÂèÇÊï∞
        if (!params.kindid || !params.kindid.includes(29)) {
          delete params.equip_type
        }

        // Â§ÑÁêÜÂè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÂ§öÈÄâÂèÇÊï∞
        if (params.equip_type && Array.isArray(params.equip_type) && params.equip_type.length === 0) {
          delete params.equip_type
        }

        // ‰ΩøÁî®Êñ∞ÁöÑAPI
        const response = await this.$api.equipment.getEquipmentList(params)

        if (response.code === 200) {
          this.equipments = response.data.data || []
          this.pagination.total = response.data.total || 0
          this.pagination.page = response.data.page || this.pagination.page
        } else {
          this.$notify.error({
            title: 'ÈîôËØØ',
            message: response.message || 'Ëé∑ÂèñË£ÖÂ§áÂàóË°®Â§±Ë¥•'
          })
        }
      } catch (error) {
        console.error('Ëé∑ÂèñË£ÖÂ§áÂàóË°®Â§±Ë¥•:', error)
        this.$notify.error({
          title: 'ÈîôËØØ',
          message: 'Ëé∑ÂèñË£ÖÂ§áÂàóË°®Â§±Ë¥•'
        })
      } finally {
        this.tableLoading = false // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåÈÉΩÁªìÊùüÂä†ËΩΩÁä∂ÊÄÅ
      }
    },
    // ÈáçÂÜô commonMixin ‰∏≠ÁöÑÊñπÊ≥ï‰ª•ÈÄÇÈÖçÊú¨È°µÈù¢ÁöÑÊï∞ÊçÆËé∑ÂèñÊñπÊ≥ïÂêç
    handleSizeChange(val) {
      this.pagination.page_size = val
      this.pagination.page = 1
      this.fetchEquipments()
    },
    handlePageChange(newPage) {
      this.pagination.page = newPage
      this.fetchEquipments()
    },
    handleSortChange({ prop, order }) {
      this.filters.sort_by = prop
      this.filters.sort_order = order === 'ascending' ? 'asc' : 'desc'
      this.fetchEquipments()
    },
    formatGems(gemLevel, gemValue) {
      if (!gemLevel || gemLevel <= 0) return ''

      let result = []
      if (gemValue) {
        try {
          // // gemValueÊòØJSONÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÔºåÂ¶Ç"[4]"
          // const gemIds = JSON.parse(gemValue)
          // if (Array.isArray(gemIds)) {
          //   result = gemIds.map((id) => this.getGemNameById(id))
          // }
        } catch (e) {
          console.error('Ëß£ÊûêÂÆùÁü≥Êï∞ÊçÆÂ§±Ë¥•:', e, gemValue)
        }
      }

      if (result.length > 0) {
        result.push(`ÈîªÁÇºÁ≠âÁ∫ßÔºö${gemLevel}`)
        return result.join('<br />')
      }

      return `ÈîªÁÇºÁ≠âÁ∫ßÔºö${gemLevel}`
    },
    // Ëé∑ÂèñÂÆùÁü≥ÂêçÁß∞
    getGemNameById(id) {
      // Áõ¥Êé•‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáè
      if (window.AUTO_SEARCH_CONFIG && window.AUTO_SEARCH_CONFIG.gems_name) {
        const gemName = window.AUTO_SEARCH_CONFIG.gems_name[id.toString()]
        if (gemName) return gemName
      }

      return `ÂÆùÁü≥${id}`
    },
    // Ëß£ÊûêÂÆùÁü≥ÂõæÁâá
    //Â§™Èò≥Áü≥  Êúà‰∫ÆÁü≥4003 ÂÖâËäíÁü≥4004 Á•ûÁßòÁü≥4005 Á∫¢ÂÆùÁü≥4006 ÈªÑÂÆùÁü≥4007 ËìùÂÆùÁü≥4008  ÁªøÂÆùÁü≥4009  ËàçÂà©Â≠ê4012 ÈªëÂÆùÁü≥4010 Á∫¢ÁéõÁëô4011 Áø°Áø†Áü≥1108_4249
    //ÊòüËæâÁü≥ 4244
    getGemImageByGemValue({ gem_value: gemValue, kindid, fangyu, speed }) {
      const gemIds = (() => {
        try {
          if (kindid === 29) {
            if (fangyu) {
              return ['755_4036']
            }
            if (speed) {
              return ['757_4038']
            }
            return ['756_4037']
          }
          return JSON.parse(gemValue || '["4244"]')
        } catch (e) {
          console.error('Ëß£ÊûêÂÆùÁü≥Êï∞ÊçÆÂ§±Ë¥•:', e, gemValue)
        }
        return []
      })()
      return gemIds.map((id) => {
        if (this.gem_image[id]) {
          return this.getImageUrl(this.gem_image[id] + '.gif')
        }
      })
    },
    // Ëß£ÊûêÈôÑÂä†Â±ûÊÄß
    formatAddedAttrs(aggAddedAttrs) {
      if (!aggAddedAttrs) return ''

      try {
        let attrs = JSON.parse(aggAddedAttrs)
        if (Array.isArray(attrs) && attrs.length > 0) {
          attrs = attrs.map((a) => {
            if (typeof a === 'string') {
              return a
            } else {
              return `${a.attr_type} +${a.attr_value}`
            }
          })
          return attrs.join('<br />')
        }
      } catch (e) {
        console.error('Ëß£ÊûêÈôÑÂä†Â±ûÊÄßÂ§±Ë¥•:', e, aggAddedAttrs)
      }

      return ''
    },
    handleLevelRangeChange(value) {
      this.filters.level_range = value
    },
    handleSuitChange(value) {
      this.filters.suit_effect = value
    },
    // Â§ÑÁêÜË£ÖÂ§áÁ±ªÂûãÂèòÂåñ
    handleKindidChange(value) {
      // Â¶ÇÊûú‰∏çÂÜçÂåÖÂê´Âè¨Âî§ÂÖΩË£ÖÂ§áÔºåÊ∏ÖÁ©∫Âè¨Âî§ÂÖΩË£ÖÂ§áÁ±ªÂûãÈÄâÊã©
      if (!value || !value.includes(29)) {
        this.filters.equip_type = []
      }
    },
   

  },
  mounted() {
    this.initSuitOptions()
    this.fetchEquipments()
  }
}
</script>

<style scoped>
.filters {
  margin-bottom: 10px;
}

.pagination-container {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}


/* Ë£ÖÂ§áÊèèËø∞Ê†∑Âºè */
.equip-desc-content {
  overflow-y: auto;
  line-height: 1.6;
  font-size: 14px;
  color: #ecf0f1;
  padding: 10px;
  border-radius: 4px;
}

/* Áõ∏‰ººË£ÖÂ§áÂºπÁ™óÊ†∑Âºè */
:global(.similar-equip-popper) {
  padding: 16px;
}

/* ÂÆùÁü≥ÊòæÁ§∫Ê†∑Âºè */
.gem-container {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  margin-top: 10px;
}

.gem-badge {
  position: relative;
}

.gem-images {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 2px;
}

.gem-images .el-image {
  display: inline-block;
  border-radius: 2px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* ÊªëÂùóÊ†∑Âºè‰ºòÂåñ */
</style>
