<template>
  <div class="pet-list-view">
    <el-card class="filters" shadow="never">
      <div slot="header" class="card-header">
        <div><span class="emoji-icon">üîç</span> Á≠õÈÄâ</div>
      </div>
   
      <!-- Á≠õÈÄâÂíåÊêúÁ¥¢Ë°®Âçï -->
      <el-form :inline="true" :model="filters" @submit.native.prevent="fetchPets" size="mini">
        <el-form-item label="üìÖÊï∞ÊçÆÊúà‰ªΩ">
          <el-date-picker v-model="filters.selectedDate" :clearable="false" type="month" placeholder="üìÖÈÄâÊã©Êúà‰ªΩ"
            format="yyyy-MM" value-format="yyyy-MM" />
        </el-form-item>
        <el-form-item label="üîëÂ∫èÂàóÂè∑">
          <el-input v-model="filters.equip_sn" placeholder="üîëÂ∫èÂàóÂè∑"></el-input>
        </el-form-item>
        <el-form-item label="üî¢Á≠âÁ∫ß">
          <div style="width: 500px">
            <el-slider v-model="filters.level_range" range :min="0" :max="180" :step="5" show-input show-input-controls
              :marks="levelMarks" @change="handleLevelRangeChange" />
          </div>
        </el-form-item>
        <el-form-item label="üí≤‰ª∑Ê†º">
          <el-input-number v-model="filters.price_min" placeholder="ÊúÄ‰Ωé‰ª∑Ê†º" :min="0" :controls="false"></el-input-number>
          -
          <el-input-number v-model="filters.price_max" placeholder="ÊúÄÈ´ò‰ª∑Ê†º" :min="0" :controls="false"></el-input-number>
        </el-form-item>
        <el-form-item label="üîßÊäÄËÉΩ">
          <el-cascader v-model="filters.skills" :options="skillOptions" :props="cascaderProps" :show-all-levels="false"
            placeholder="üîßËØ∑ÈÄâÊã©ÊäÄËÉΩ" multiple clearable filterable>
            <template slot-scope="{ data }">
              <el-row type="flex" align="middle">
                <el-image v-if="data.value" :src="getSkillImage(data.value)" fit="cover" referrerpolicy="no-referrer"
                  style="display: block;width: 24px;height: 24px;margin-right: 4px;"></el-image>
                <span>{{ data.label }}</span>
              </el-row>
            </template>
          </el-cascader>
        </el-form-item>
        <el-form-item label="üîßÊäÄËÉΩÊï∞Èáè‚â•">
          <el-input-number v-model="filters.pet_skill_count" placeholder="üîßÊäÄËÉΩÊï∞Èáè" :min="0" controls></el-input-number>
        </el-form-item>
        <el-form-item label="üìöÊàêÈïø">
          <el-input-number v-model="filters.pet_growth" placeholder="üìöÊàêÈïø" :min="1" :max="1.4" :step="0.1"
            controls></el-input-number>
        </el-form-item>
        <el-form-item label="üßùÁÅµÊÄßÂÄº‚â•">
          <el-input-number v-model="filters.pet_lx" placeholder="üßùÁÅµÊÄßÂÄº" :min="0" controls></el-input-number>
        </el-form-item>
        <el-form-item label="üî•ÁâπÊÄß">
          <el-select v-model="filters.pet_texing" placeholder="üî•ËØ∑ÈÄâÊã©ÁâπÊÄß" multiple clearable filterable>
            <el-option v-for="([value, label]) in texing_type_list" :key="value" :label="label" :value="value">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="‚ùå‰º∞‰ª∑ÂºÇÂ∏∏">
          <el-switch v-model="filters.equip_list_amount_warning" :active-value="1" :inactive-value="0"
            inactive-color="#409EFF" active-color="#F56C6C"></el-switch>
        </el-form-item>
        <el-form-item label="üîçË£ÖÂ§á‰º∞‰ª∑ÂºÇÂ∏∏Âç†ÊØîÁéá‚â§" v-if="filters.equip_list_amount_warning === 1">
          <el-input-number v-model="filters.warning_rate" placeholder="Ë£ÖÂ§á‰º∞‰ª∑ÂºÇÂ∏∏Âç†ÊØîÁéá" :min="0" :max="99" :step="0.1"
            controls></el-input-number>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="fetchPets">Êü•ËØ¢</el-button>
        </el-form-item>
      </el-form>
      <el-alert type="warning" @close="batchUpdateUnvaluedPets" :loading="unvaluedPetsLoading"
        v-if="unvaluedPetsCount > 0" :title="` ÊúâÔºà${unvaluedPetsCount}ÔºâÂè™Âè¨Âî§ÂÖΩË£ÖÂ§áÊú™‰º∞‰ª∑/‰º∞‰ª∑ÂºÇÂ∏∏`" close-text="Êõ¥Êñ∞">
      </el-alert>
  
</el-card>
 
    <el-table :data="pets" stripe style="width: 100%" @sort-change="handleSortChange" :key="tableKey"
      v-loading="tableLoading">
      <el-table-column prop="eid" label="Êìç‰Ωú" width="100" fixed align="center">
        <template #default="scope">
          <el-link :href="getCBGLinkByType(scope.row.eid, 'pet')" type="danger" target="_blank">ËóèÂÆùÈòÅ</el-link>
          <el-divider direction="vertical"></el-divider>
          <SimilarPetModal :pet="scope.row" :similar-data="similarPets" :valuation="petValuation"
            @show="loadSimilarPets" />
        </template>
      </el-table-column>
      <el-table-column fixed label="Âè¨Âî§ÂÖΩ" width="70" align="center">
        <template #default="scope">
          <PetImage :pet="scope.row.petData" :equip_sn="scope.row.equip_sn" :equipFaceImg="scope.row.equip_face_img"
            :enhanceInfo="getEnhanceInfo(scope.row)" />
        </template>
      </el-table-column>
      <el-table-column fixed prop="price" label="‰ª∑Ê†º (ÂÖÉ)" width="140" sortable="custom" align="center">
        <template #default="scope">
          {{ scope.row.server_name }}
          <div v-html="formatFullPrice(scope.row)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="highlight" label="‰∫ÆÁÇπ" width="100" align="center" sortable="custom">>
        <template slot-scope="scope">
          <span v-html="gen_highlight(scope.row.highlight)"></span>
        </template>
      </el-table-column>
      <el-table-column prop="dynamic_tags" label="Âä®ÊÄÅ" width="100" align="center" sortable="custom">
        <template slot-scope="scope">
          <span v-html="gen_dynamic_tags(scope.row.dynamic_tags)"></span>
        </template>
      </el-table-column>
      <el-table-column prop="equip_list" label="Ë£ÖÂ§á" width="171" sortable="custom" align="center">
        <template #default="{ row: { equip_list, equip_list_amount }, row }">
          <table cellspacing="0" cellpadding="0" class="tb03 size50">
            <tr>
              <td v-for="(eItem, index) in JSON.parse(equip_list).splice(0, 3)" :key="index">
                <EquipmentImage v-if="eItem" :placement="'bottom'" :image="false" :equipment="getEquipImageProps(eItem)"
                  size="small" :popoverWidth="300" />
                <span v-else>&nbsp;</span>
              </td>
            </tr>
          </table>
          <el-row type="flex" justify="space-between" align="middle">
            <p v-if="getEquipSuitEffect(equip_list)" class="cBlue">{{
              getEquipSuitEffect(equip_list) }}Â•óË£Ö</p> <span
              v-html="formatFullPrice({ price: equip_list_amount }, true)"></span>
          </el-row>
          <el-button v-if="JSON.parse(equip_list).slice(0, 3).some(item => item)" type="text" size="mini"
            @click="updatePetEquipmentsPrice(row)" :loading="equipmentValuationLoading"
            :disabled="!JSON.parse(equip_list).some(item => item)" style="float:right ;">
            Ë£ÖÂ§á‰º∞‰ª∑
          </el-button>
        </template>
      </el-table-column>
      <el-table-column prop="growth" label="ÊàêÈïø" width="100" sortable="custom" align="center">
        <template #default="scope">
          <span v-html="getColorNumber(scope.row.growth, [1, 1.3])"></span>
        </template>
      </el-table-column>
      <el-table-column prop="lx" label="ÁÅµÊÄß" width="80" align="center" sortable="custom">
        <template #default="scope">
          <span v-html="getColorNumber(scope.row.lx, [80, 110])"></span>
        </template>
      </el-table-column>
      <el-table-column prop="skill_count" label="ÊäÄËÉΩ" width="280" sortable="custom" align="center">
        <template #default="scope">
          <div class="pet-skills" v-html="formatSkills(scope.row)"></div>
        </template>
      </el-table-column>
      <el-table-column prop="level" label="Á≠âÁ∫ß" width="140" sortable="custom" align="center">
        <template #default="scope">
          <p :class="scope.row.petData.is_baobao === 'ÊòØ' ? 'cBlue' : 'equip_desc_red'">
            <span>{{ scope.row.petData.is_baobao === 'ÊòØ' ? '' : 'ÈáéÁîü' }}</span>
            <span>{{ scope.row.equip_name }}{{ scope.row.petData.is_baobao === 'ÊòØ' ? 'ÂÆùÂÆù' : '' }}/{{ scope.row.level
            }}Á∫ß</span>
          </p>
          <p>ÂèÇÊàòÁ≠âÁ∫ßÔºö{{ scope.row.role_grade_limit }}Á∫ß</p>
        </template>
      </el-table-column>
      <el-table-column prop="petData.texing.name" label="ÁâπÊÄß" width="60" align="center"></el-table-column>
      <el-table-column label="Êìç‰Ωú" width="100">
        <template #default="scope">
          <el-link href="javascript:void(0)" type="danger" @click.native="handleDelete(scope.row)">Âà†Èô§</el-link>
        </template>
      </el-table-column>
    </el-table>
    <div class="pagination-container">
      <el-pagination @current-change="handlePageChange" :current-page="pagination.page" @size-change="handleSizeChange"
        :page-size="pagination.page_size" :page-sizes="[10, 100, 200, 300, 400]"
        layout="total, sizes, prev, pager, next, jumper" :total="pagination.total">
      </el-pagination>
    </div>

    <!-- Ë£ÖÂ§á‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü -->
    <el-dialog :title="valuationDialogTitle" :visible.sync="valuationDialogVisible" width="90%"
      :close-on-click-modal="false" :close-on-press-escape="false" custom-class="batch-valuation-dialog">
      <BatchValuationResult :results="valuationResults" :total-value="valuationTotalValue"
        :equipment-list="valuationEquipmentList" :valuate-params="batchValuateParams" :loading="valuationLoading"
        @close="closeValuationDialog" />
    </el-dialog>

    <!-- ‰ªªÂä°ËøõÂ∫¶ÂØπËØùÊ°Ü -->
    <el-dialog title="ÊâπÈáèÊõ¥Êñ∞ËøõÂ∫¶" :visible.sync="taskProgressVisible" width="500px" :close-on-click-modal="false"
      :close-on-press-escape="false" :show-close="false">
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 16px; margin-bottom: 20px;">
          Ê≠£Âú®ÊâπÈáèÊõ¥Êñ∞Âè¨Âî§ÂÖΩË£ÖÂ§á‰º∞ÁÆó‰ª∑Ê†º...
        </div>
        <el-progress :percentage="taskStatus ? taskStatus.progress_percentage || 0 : 0" :stroke-width="16"
          :text-inside="true">
        </el-progress>
        <div style="margin-top: 20px; font-size: 14px; color: #666;">
          Â∑≤Â§ÑÁêÜ: {{ taskStatus ? taskStatus.processed_count || 0 : 0 }} / {{ taskStatus ? taskStatus.total_count || 0 : 0
          }}
        </div>
        <div style="margin-top: 10px; font-size: 14px; color: #666;">
          ÂΩìÂâçÊâπÊ¨°: {{ taskStatus ? taskStatus.current_batch || 0 : 0 }} / {{ taskStatus ? taskStatus.total_batches || 0 : 0
          }}
        </div>
        <div style="margin-top: 10px; font-size: 14px; color: #666;">
          Â∑≤Êõ¥Êñ∞: {{ taskStatus ? taskStatus.updated_count || 0 : 0 }}
        </div>
      </div>
      <div slot="footer" class="dialog-footer">
        <el-button @click="stopCurrentTask" type="danger">ÂÅúÊ≠¢‰ªªÂä°</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import SimilarPetModal from '@/components/SimilarPetModal.vue'
import BatchValuationResult from '@/components/BatchValuationResult.vue'
import dayjs from 'dayjs'
import PetImage from '@/components/PetImage.vue'
import EquipmentImage from '@/components/EquipmentImage/EquipmentImage.vue'
import { petMixin } from '@/utils/mixins/petMixin'
import { equipmentMixin } from '@/utils/mixins/equipmentMixin'
import { commonMixin } from '@/utils/mixins/commonMixin'
import { petApi } from '@/api/pet'
const skillOptions = []
const pet_skill_classification = window.AUTO_SEARCH_CONFIG.pet_skill_classification
for (const lowOrHightKey in pet_skill_classification) {
  for (const label in pet_skill_classification[lowOrHightKey]) {
    skillOptions.push({
      value: '',
      label: lowOrHightKey.replace('ÊäÄËÉΩ', '') + label,
      children: pet_skill_classification[lowOrHightKey][label]
    })
  }
}
skillOptions.reverse()
export default {
  name: 'PetList',
  components: {
    SimilarPetModal,
    PetImage,
    EquipmentImage,
    BatchValuationResult
  },
  mixins: [equipmentMixin, commonMixin, petMixin],
  data() {
    return {
      batchValuateParams: {
        similarity_threshold: 0.8,
        max_anchors: 30
      },
      tableLoading: false, // Ë°®Ê†ºÂä†ËΩΩÁä∂ÊÄÅ
      // Á∫ßËÅîÈÄâÊã©Âô®ÈÖçÁΩÆ
      cascaderProps: {
        multiple: true,
        checkStrictly: false, // ‰∏çÂÖÅËÆ∏ÈÄâÊã©ÈùûÂè∂Â≠êËäÇÁÇπÔºåÂè™ËÉΩÈÄâÊã©Âè∂Â≠êËäÇÁÇπ
        emitPath: false       // Âè™ËøîÂõûÊúÄÂêé‰∏ÄÁ∫ßÁöÑÂÄºÔºàÊäÄËÉΩIDÔºâÔºåËÄå‰∏çÊòØÂÆåÊï¥Ë∑ØÂæÑ
      },
      texing_type_list: window.AUTO_SEARCH_CONFIG.texing_type_list,
      skillOptions,
      pets: [],
      filters: {
        equip_sn: '',
        pet_skill_count: 0,
        pet_growth: 1.0,
        selectedDate: dayjs().format('YYYY-MM'),
        level_range: [0, 180],
        skills: [],
        price_min: undefined,
        price_max: undefined,
        sort_by: 'price',
        sort_order: 'asc',
        equip_list_amount_warning: 0,
        warning_rate: 0.4
      },
      pagination: {
        page: 1,
        page_size: 10,
        total: 0
      },
      levelMarks: {
        60: '60',
        90: '90',
        120: '120',
        150: '150'
      },
      tableKey: 0,
      // Áõ∏‰ººÂè¨Âî§ÂÖΩÁõ∏ÂÖ≥Êï∞ÊçÆÔºàÂÆûÊó∂ËÆ°ÁÆóÔºå‰∏çÁºìÂ≠òÔºâ
      similarPets: null, // ÂΩìÂâçÊòæÁ§∫ÁöÑÁõ∏‰ººÂè¨Âî§ÂÖΩÊï∞ÊçÆ
      petValuation: null, // ÂΩìÂâçÂè¨Âî§ÂÖΩ‰º∞‰ª∑‰ø°ÊÅØ
      equipmentValuationLoading: false, // Ë£ÖÂ§áÊâπÈáè‰º∞‰ª∑Âä†ËΩΩÁä∂ÊÄÅ
      // Ë£ÖÂ§á‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°ÜÁõ∏ÂÖ≥Êï∞ÊçÆ
      valuationDialogVisible: false,
      valuationResults: [],
      valuationTotalValue: 0,
      valuationEquipmentList: [],
      valuationLoading: false,
      valuationDialogTitle: '',
      // Êú™‰º∞‰ª∑Âè¨Âî§ÂÖΩÊï∞Èáè
      unvaluedPetsCount: 0,
      unvaluedPetsLoading: false,
      // ‰ªªÂä°Áõ∏ÂÖ≥Êï∞ÊçÆ
      currentTaskId: null,
      taskStatus: {},
      taskProgressTimer: null,
      taskProgressVisible: false,
      taskProgressPercentage: 0,
      taskProgressProcessed: 0,
      taskProgressTotal: 0,
      taskProgressCurrentBatch: 0,
      taskProgressTotalBatches: 0,
      taskProgressUpdated: 0,
    }
  },
  methods: {
    async updatePetEquipmentsPrice({ equip_sn, equip_list, equip_name }) {
      try {
        this.equipmentValuationLoading = true

        // ÂÖàËøáÊª§Ë£ÖÂ§áÊï∞ÊçÆÔºåÂè™ÂèñÂâç‰∏â‰∏™
        const validEquipments = JSON.parse(equip_list)
          .filter((item, index) => item && item.desc && index < 3)
          .map(item => ({ ...item, kindid: 29 }))

        // ÂÖàÊòæÁ§∫ÂºπÁ™óÂíåÈ™®Êû∂Â±è
        this.valuationDialogVisible = true
        this.valuationLoading = true
        this.valuationResults = []
        this.valuationTotalValue = 0
        this.valuationEquipmentList = validEquipments
        this.valuationDialogTitle = `Âè¨Âî§ÂÖΩË£ÖÂ§á‰º∞‰ª∑ÁªìÊûú - ${equip_name}`

        // Ë∞ÉÁî®ÊâπÈáè‰º∞‰ª∑API
        const response = await petApi.updatePetEquipmentsPrice({
          equip_sn,
          strategy: 'fair_value',
          similarity_threshold: this.batchValuateParams.similarity_threshold,
          max_anchors: this.batchValuateParams.max_anchors,
          year: this.filters.selectedDate.split('-')[0] * 1,
          month: this.filters.selectedDate.split('-')[1] * 1
        })

        if (response.code === 200) {
          const data = response.data
          const results = data.results || []
          const totalValue = results.reduce((sum, result) => {
            return sum + (result.estimated_price || 0)
          }, 0)

          if (results.length === 0) {
            this.$notify.warning('ËØ•Âè¨Âî§ÂÖΩÊ≤°ÊúâÊê∫Â∏¶Ë£ÖÂ§áÊàñË£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•')
            this.closeValuationDialog()
            return
          }

          // Êõ¥Êñ∞ÂºπÁ™óÂÜÖÂÆπÔºåÊòæÁ§∫ÂÆûÈôÖÊï∞ÊçÆ
          this.valuationResults = results
          this.valuationTotalValue = totalValue
          this.valuationLoading = false
        } else {
          this.$notify.error(response.message || 'Âè¨Âî§ÂÖΩË£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•')
          this.closeValuationDialog()
        }
      } catch (error) {
        console.error('Âè¨Âî§ÂÖΩË£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•:', error)
        this.$notify.error('Âè¨Âî§ÂÖΩË£ÖÂ§á‰º∞‰ª∑Â§±Ë¥•')
        this.closeValuationDialog()
      } finally {
        this.equipmentValuationLoading = false
      }
    },
    async fetchPets() {
      const [year, month] = this.filters.selectedDate.split('-')
      try {
        this.tableLoading = true // ÂºÄÂßãÂä†ËΩΩÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        const params = {
          ...this.filters,
          year,
          month,
          page: this.pagination.page,
          page_size: this.pagination.page_size
        }

        // Â§ÑÁêÜÁ≠âÁ∫ßËåÉÂõ¥ÊªëÂùóÂÄº
        if (this.filters.level_range && Array.isArray(this.filters.level_range)) {
          params.level_min = this.filters.level_range[0]
          params.level_max = this.filters.level_range[1]
          delete params.level_range
        }

        // Â§ÑÁêÜÊäÄËÉΩËøáÊª§ÂèÇÊï∞
        if (this.filters.skills && Array.isArray(this.filters.skills) && this.filters.skills.length > 0) {
          // Áî±‰∫éËÆæÁΩÆ‰∫ÜemitPath: falseÔºåcascaderÁõ¥Êé•ËøîÂõûÊäÄËÉΩID
          params.pet_skills = this.filters.skills
          delete params.skills
        }

        // ÁßªÈô§Á©∫ÁöÑÁ≠õÈÄâÊù°‰ª∂
        Object.keys(params).forEach((key) => {
          if (
            params[key] === null ||
            params[key] === '' ||
            (Array.isArray(params[key]) && params[key].length === 0)
          ) {
            delete params[key]
          }
        })

        // ‰ΩøÁî®Êñ∞ÁöÑAPI
        const response = await this.$api.pet.getPetList(params)
        if (response.code === 200) {
          this.pets = response.data.data.map((item) => {
            const petData = this.parsePetInfo(item.desc)
            return ({
              ...item,
              petData
            })
          }) || []

          this.pagination.total = response.data.total || 0
          this.pagination.page = response.data.page || this.pagination.page
        } else {
          this.$notify.error(response.message || 'Ëé∑ÂèñÂè¨Âî§ÂÖΩÂàóË°®Â§±Ë¥•')
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÂè¨Âî§ÂÖΩÂàóË°®Â§±Ë¥•:', error)
        this.$notify.error('Ëé∑ÂèñÂè¨Âî§ÂÖΩÂàóË°®Â§±Ë¥•')
      } finally {
        this.tableLoading = false // Êó†ËÆ∫ÊàêÂäüÂ§±Ë¥•ÔºåÈÉΩÁªìÊùüÂä†ËΩΩÁä∂ÊÄÅ
      }
    },
    // ÈáçÂÜô commonMixin ‰∏≠ÁöÑÊñπÊ≥ï‰ª•ÈÄÇÈÖçÊú¨È°µÈù¢ÁöÑÊï∞ÊçÆËé∑ÂèñÊñπÊ≥ïÂêç
    handleSizeChange(val) {
      this.pagination.page_size = val
      this.pagination.page = 1
      this.fetchPets()
    },
    handlePageChange(newPage) {
      this.pagination.page = newPage
      this.fetchPets()
    },
    handleSortChange({ prop, order }) {
      this.filters.sort_by = prop
      this.filters.sort_order = order === 'ascending' ? 'asc' : 'desc'
      this.fetchPets()
    },
    handleLevelRangeChange(value) {
      this.filters.level_range = value
    },
    // Âä†ËΩΩÁõ∏‰ººÂè¨Âî§ÂÖΩ
    async loadSimilarPets(pet) {
      this.similarPets = null
      this.petValuation = null
      await this.loadPetValuation(pet, 0.8)
    },
    async loadPetValuation({ petData, ...pet }, similarityThreshold = 0.8) {
      try {
        // Ëé∑Âèñ‰º∞‰ª∑‰ø°ÊÅØÔºàÂåÖÂê´Áõ∏‰ººÂè¨Âî§ÂÖΩÔºâ
        const valuationResponse = await this.$api.pet.getPetValuation({
          pet_data: pet,
          strategy: 'fair_value',
          similarity_threshold: similarityThreshold,
          max_anchors: 30
        })

        // Â§ÑÁêÜ‰º∞‰ª∑ÂìçÂ∫î
        if (valuationResponse.code === 200) {
          const data = valuationResponse.data
          this.petValuation = data
          const { data: { anchors:allAnchors } } = await this.$api.pet.findPetAnchors({
            pet_data: pet,
            similarity_threshold: similarityThreshold,
            max_anchors: 30
          })
          // ‰ªé‰º∞‰ª∑ÁªìÊûú‰∏≠ÊèêÂèñÁõ∏‰ººÂè¨Âî§ÂÖΩ‰ø°ÊÅØ
          if (data?.anchor_count  > 0) {
            this.similarPets = {
              anchor_count: data.anchor_count,
              similarity_threshold: data.similarity_threshold,
              anchors: allAnchors.map((item) => ({ ...item, petData: this.parsePetInfo(item.desc) })),
              statistics: {
                price_range: {
                  min: Math.min(...allAnchors.map((a) => a.price || 0)),
                  max: Math.max(...allAnchors.map((a) => a.price || 0))
                },
                similarity_range: {
                  min: Math.min(...allAnchors.map((a) => a.similarity || 0)),
                  max: Math.max(...allAnchors.map((a) => a.similarity || 0)),
                  avg:
                    allAnchors.reduce((sum, a) => sum + (a.similarity || 0), 0) /
                    allAnchors.length
                }
              }
            }
            return
          }
        }
        this.similarPets = {
          anchor_count: 0,
          similarity_threshold: similarityThreshold,
          statistics: {
            price_range: { min: 0, max: 0 },
            similarity_range: { min: 0, max: 0, avg: 0 }
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩÁõ∏‰ººÂè¨Âî§ÂÖΩÊàñ‰º∞‰ª∑Â§±Ë¥•:', error)
      }
    },
    // ÂÖ≥Èó≠Ë£ÖÂ§á‰º∞‰ª∑ÁªìÊûúÂØπËØùÊ°Ü
    closeValuationDialog() {
      this.valuationDialogVisible = false
      this.valuationResults = []
      this.valuationTotalValue = 0
      this.valuationEquipmentList = []
      this.valuationLoading = false
      this.valuationDialogTitle = ''
    },

    // Ëé∑ÂèñÊú™‰º∞‰ª∑Âè¨Âî§ÂÖΩÊï∞Èáè
    async getUnvaluedPetsCount() {
      try {
        this.unvaluedPetsLoading = true
        const [year, month] = this.filters.selectedDate.split('-')

        const response = await petApi.getUnvaluedPetsCount({
          year: parseInt(year),
          month: parseInt(month)
        })

        if (response.code === 200) {
          this.unvaluedPetsCount = response.data.count || 0
        } else {
          console.error('Ëé∑ÂèñÊú™‰º∞‰ª∑Âè¨Âî§ÂÖΩÊï∞ÈáèÂ§±Ë¥•:', response.message)
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÊú™‰º∞‰ª∑Âè¨Âî§ÂÖΩÊï∞ÈáèÂ§±Ë¥•:', error)
      } finally {
        this.unvaluedPetsLoading = false
      }
    },

    // ÊâπÈáèÊõ¥Êñ∞Êú™‰º∞‰ª∑Âè¨Âî§ÂÖΩË£ÖÂ§á
    async batchUpdateUnvaluedPets() {
      try {
        this.unvaluedPetsLoading = true
        const [year, month] = this.filters.selectedDate.split('-')

        // Á°ÆËÆ§ÂØπËØùÊ°Ü
        await this.$confirm(
          `Á°ÆÂÆöË¶ÅÊâπÈáèÊõ¥Êñ∞ ${this.unvaluedPetsCount} Âè™Êú™‰º∞‰ª∑Âè¨Âî§ÂÖΩÁöÑË£ÖÂ§á‰ª∑Ê†ºÂêóÔºüÊ≠§Êìç‰ΩúÂèØËÉΩÈúÄË¶ÅËæÉÈïøÊó∂Èó¥„ÄÇ`,
          'ÊâπÈáè‰º∞‰ª∑Á°ÆËÆ§',
          {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        )

        const response = await petApi.batchUpdateUnvaluedPets({
          year: parseInt(year),
          month: parseInt(month)
        })

        if (response.code === 200) {
          const data = response.data
          this.currentTaskId = data.task_id
          this.taskStatus = data

          // ÊòæÁ§∫‰ªªÂä°ËøõÂ∫¶ÂØπËØùÊ°Ü
          this.showTaskProgressDialog()

          // ÂºÄÂßãÁõëÊéß‰ªªÂä°ËøõÂ∫¶
          this.startTaskProgressMonitoring()
        } else {
          this.$notify.error(response.message || 'ÊâπÈáèÊõ¥Êñ∞Â§±Ë¥•')
        }
      } catch (error) {
        if (error !== 'cancel') { // Áî®Êà∑ÂèñÊ∂à‰∏çÊòæÁ§∫ÈîôËØØ
          console.error('ÊâπÈáèÊõ¥Êñ∞Êú™‰º∞‰ª∑Âè¨Âî§ÂÖΩË£ÖÂ§áÂ§±Ë¥•:', error)
          this.$notify.error('ÊâπÈáèÊõ¥Êñ∞Â§±Ë¥•')
        }
      } finally {
        this.unvaluedPetsLoading = false
      }
    },

    // ÊòæÁ§∫‰ªªÂä°ËøõÂ∫¶ÂØπËØùÊ°Ü
    showTaskProgressDialog() {
      this.taskProgressVisible = true
    },

    // ÂºÄÂßãÁõëÊéß‰ªªÂä°ËøõÂ∫¶
    startTaskProgressMonitoring() {
      this.taskProgressTimer = setInterval(async () => {
        if (!this.currentTaskId) {
          this.stopTaskProgressMonitoring()
          return
        }

        try {
          const response = await petApi.getTaskStatus(this.currentTaskId)
          if (response.code === 200) {
            this.taskStatus = response.data

            // Ê£ÄÊü•‰ªªÂä°ÊòØÂê¶ÂÆåÊàê
            if (this.taskStatus && this.taskStatus.status === 'completed') {
              this.handleTaskCompleted()
            } else if (this.taskStatus && this.taskStatus.status === 'failed') {
              this.handleTaskFailed()
            } else if (this.taskStatus && this.taskStatus.status === 'cancelled') {
              this.handleTaskCancelled()
            }
          }
        } catch (error) {
          console.error('Ëé∑Âèñ‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•:', error)
        }
      }, 10 * 1000) // ÊØè10ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
    },

    // ÂÅúÊ≠¢ÁõëÊéß‰ªªÂä°ËøõÂ∫¶
    stopTaskProgressMonitoring() {
      if (this.taskProgressTimer) {
        clearInterval(this.taskProgressTimer)
        this.taskProgressTimer = null
      }
    },

    // ÂÅúÊ≠¢ÂΩìÂâç‰ªªÂä°
    async stopCurrentTask() {
      if (this.currentTaskId) {
        try {
          await petApi.stopTask(this.currentTaskId)
          this.$notify.info('Â∑≤ÂèëÈÄÅÂÅúÊ≠¢‰ªªÂä°ËØ∑Ê±Ç')

          // Á≠âÂæÖ‰ªªÂä°Áä∂ÊÄÅÂèò‰∏∫cancelledÔºåÁÑ∂ÂêéÂÖ≥Èó≠ÂºπÁ™ó
          this.waitForTaskCancelled()
        } catch (error) {
          console.error('ÂÅúÊ≠¢‰ªªÂä°Â§±Ë¥•:', error)
        }
      }
    },

    // Á≠âÂæÖ‰ªªÂä°ÂèñÊ∂à
    async waitForTaskCancelled() {
      const maxWaitTime = 10000 // ÊúÄÂ§öÁ≠âÂæÖ10Áßí
      const checkInterval = 1000 // ÊØè1ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
      const startTime = Date.now()

      console.log('ÂºÄÂßãÁ≠âÂæÖ‰ªªÂä°ÂèñÊ∂à...')

      while (Date.now() - startTime < maxWaitTime) {
        try {
          const response = await petApi.getTaskStatus(this.currentTaskId)
          if (response.code === 200 && response.data) {
            const status = response.data.status
            console.log(`‰ªªÂä°Áä∂ÊÄÅ: ${status}`)

            if (status === 'cancelled') {
              // ‰ªªÂä°Â∑≤ÂèñÊ∂àÔºåÂÖ≥Èó≠ÂºπÁ™ó
              console.log('‰ªªÂä°Â∑≤ÂèñÊ∂àÔºåÂÖ≥Èó≠ÂºπÁ™ó')
              this.handleTaskCancelled()
              return
            } else if (status === 'completed' || status === 'failed') {
              // ‰ªªÂä°Â∑≤ÂÆåÊàêÊàñÂ§±Ë¥•Ôºå‰πü‰ºöÂÖ≥Èó≠ÂºπÁ™ó
              console.log(`‰ªªÂä°Áä∂ÊÄÅ‰∏∫ ${status}ÔºåÂÖ≥Èó≠ÂºπÁ™ó`)
              if (status === 'completed') {
                this.handleTaskCompleted()
              } else {
                this.handleTaskFailed()
              }
              return
            }
          }
        } catch (error) {
          console.error('Ê£ÄÊü•‰ªªÂä°Áä∂ÊÄÅÂ§±Ë¥•:', error)
        }

        // Á≠âÂæÖ‰∏ÄÊÆµÊó∂Èó¥ÂÜçÊ£ÄÊü•
        await new Promise(resolve => setTimeout(resolve, checkInterval))
      }

      // Ë∂ÖÊó∂ÂêéÂº∫Âà∂ÂÖ≥Èó≠ÂºπÁ™ó
      console.warn('Á≠âÂæÖ‰ªªÂä°ÂèñÊ∂àË∂ÖÊó∂ÔºåÂº∫Âà∂ÂÖ≥Èó≠ÂºπÁ™ó')
      this.handleTaskCancelled()
    },

    // Â§ÑÁêÜ‰ªªÂä°ÂÆåÊàê
    handleTaskCompleted() {
      this.stopTaskProgressMonitoring()
      this.taskProgressVisible = false

      if (this.taskStatus) {
        this.$notify.success(
          `ÊâπÈáèÊõ¥Êñ∞ÂÆåÊàêÔºÅÊàêÂäüÊõ¥Êñ∞ ${this.taskStatus.updated_count || 0}/${this.taskStatus.total_count || 0} Âè™Âè¨Âî§ÂÖΩÁöÑË£ÖÂ§á‰ª∑Ê†º„ÄÇ`
        )
      } else {
        this.$notify.success('ÊâπÈáèÊõ¥Êñ∞ÂÆåÊàêÔºÅ')
      }

      this.currentTaskId = null
      this.taskStatus = null

      // ÈáçÊñ∞Ëé∑ÂèñÊú™‰º∞‰ª∑Êï∞Èáè
      this.getUnvaluedPetsCount()
      // Âà∑Êñ∞Âè¨Âî§ÂÖΩÂàóË°®
      this.fetchPets()
    },

    // Â§ÑÁêÜ‰ªªÂä°Â§±Ë¥•
    handleTaskFailed() {
      this.stopTaskProgressMonitoring()
      this.taskProgressVisible = false

      if (this.taskStatus) {
        this.$notify.error(`‰ªªÂä°Â§±Ë¥•: ${this.taskStatus.error_message || 'Êú™Áü•ÈîôËØØ'}`)
      } else {
        this.$notify.error('‰ªªÂä°Â§±Ë¥•: Êú™Áü•ÈîôËØØ')
      }

      this.currentTaskId = null
      this.taskStatus = null
    },

    // Â§ÑÁêÜ‰ªªÂä°ÂèñÊ∂à
    handleTaskCancelled() {
      this.stopTaskProgressMonitoring()
      this.taskProgressVisible = false
      this.$notify.info('‰ªªÂä°Â∑≤ÂèñÊ∂à')
      this.currentTaskId = null
      this.taskStatus = null
    },

    // Âà†Èô§Âè¨Âî§ÂÖΩ
    async handleDelete(row) {
      try {
        // Á°ÆËÆ§Âà†Èô§
        await this.$confirm(
          `Á°ÆÂÆöË¶ÅÂà†Èô§Âè¨Âî§ÂÖΩ ${row.equip_name || row.equip_sn} ÂêóÔºü`,
          'Á°ÆËÆ§Âà†Èô§',
          {
            confirmButtonText: 'Á°ÆÂÆö',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        )

        // Ëé∑ÂèñÂΩìÂâçÂπ¥Êúà
        const [year, month] = this.filters.selectedDate.split('-')

        // Ë∞ÉÁî®Âà†Èô§API
        const response = await petApi.deletePet(row.equip_sn, {
          year,
          month
        })

        if (response.code === 200) {
          this.$notify.success('Âè¨Âî§ÂÖΩÂà†Èô§ÊàêÂäü')
          // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
          await this.fetchPets()
        } else {
          this.$notify.error(response.message || 'Âà†Èô§Â§±Ë¥•')
        }
      } catch (error) {
        if (error !== 'cancel') {
          console.error('Âà†Èô§Âè¨Âî§ÂÖΩÂ§±Ë¥•:', error)
          this.$notify.error('Âà†Èô§Âè¨Âî§ÂÖΩÂ§±Ë¥•')
        }
      }
    },

    // Ê£ÄÊü•Ê¥ªË∑É‰ªªÂä°
    async checkActiveTasks() {
      try {
        console.log('ÂºÄÂßãÊ£ÄÊü•Ê¥ªË∑É‰ªªÂä°...')
        const response = await petApi.getActiveTasks()
        console.log('Ê¥ªË∑É‰ªªÂä°APIÂìçÂ∫î:', response)

        if (response.code === 200 && response.data && response.data.length > 0) {
          console.log('ÊâæÂà∞Ê¥ªË∑É‰ªªÂä°:', response.data)

          // ÊâæÂà∞ÂΩìÂâçÂπ¥ÊúàÂØπÂ∫îÁöÑÊ¥ªË∑É‰ªªÂä°
          const [year, month] = this.filters.selectedDate.split('-')
          console.log('ÂΩìÂâçÂπ¥Êúà:', year, month)

          const currentTask = response.data.find(task => {
            console.log('ÊØîËæÉ‰ªªÂä°:', task.year, task.month, 'vs', year, month)
            return task.year === parseInt(year) && task.month === parseInt(month)
          })

          console.log('ÂåπÈÖçÁöÑÂΩìÂâç‰ªªÂä°:', currentTask)

          if (currentTask) {
            this.currentTaskId = currentTask.task_id
            this.taskStatus = currentTask

            // Â¶ÇÊûú‰ªªÂä°ËøòÂú®ËøêË°åÔºåÊòæÁ§∫ËøõÂ∫¶ÂØπËØùÊ°ÜÂπ∂ÂºÄÂßãÁõëÊéß
            if (currentTask.status === 'running') {
              console.log('ÊÅ¢Â§çËøêË°å‰∏≠ÁöÑ‰ªªÂä°:', currentTask.task_id)
              this.showTaskProgressDialog()
              this.startTaskProgressMonitoring()
              this.$notify.info('Ê£ÄÊµãÂà∞Êú™ÂÆåÊàêÁöÑ‰ªªÂä°ÔºåÂ∑≤ÊÅ¢Â§çÁõëÊéß')
            } else if (currentTask.status === 'pending') {
              console.log('ÂèëÁé∞ÂæÖÂ§ÑÁêÜ‰ªªÂä°:', currentTask.task_id)
              this.$notify.info('Ê£ÄÊµãÂà∞ÂæÖÂ§ÑÁêÜÁöÑ‰ªªÂä°ÔºåÊ≠£Âú®Á≠âÂæÖÊâßË°å')
            }
          } else {
            console.log('Êú™ÊâæÂà∞ÂΩìÂâçÂπ¥ÊúàÁöÑÊ¥ªË∑É‰ªªÂä°')
          }
        } else {
          console.log('Ê≤°ÊúâÊ¥ªË∑É‰ªªÂä°ÊàñAPIÂìçÂ∫îÂºÇÂ∏∏')
        }
      } catch (error) {
        console.error('Ê£ÄÊü•Ê¥ªË∑É‰ªªÂä°Â§±Ë¥•:', error)
      }
    }
  },

  mounted() {
    this.fetchPets()
    this.getUnvaluedPetsCount()
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊ¥ªË∑É‰ªªÂä°ÈúÄË¶ÅÊÅ¢Â§ç
    this.checkActiveTasks()
  },

  beforeDestroy() {
    // Ê∏ÖÁêÜ‰ªªÂä°ËøõÂ∫¶ÁõëÊéß
    this.stopTaskProgressMonitoring()
  }
}
</script>

<style scoped>
.filters {
  margin-bottom:10px;
}

.pagination-container {
  margin-top: 20px;
  display: flex;
  justify-content: center;
}


/* ÊäÄËÉΩÊ†∑Âºè */
:global(.pet-skills .tb03 td) {
  width: 30px;
  height: 30px;
}

:global(.pet-skills img) {
  width: 28px;
  height: 28px;
}

:global(.pet-skills img.on) {
  width: 28px;
  height: 28px;
  border: 1px solid #c00;
}

/* Áõ∏‰ººÂè¨Âî§ÂÖΩÂºπÁ™óÊ†∑Âºè */
:global(.similar-pet-popper) {
  padding: 16px;
}

/* ÊâπÈáè‰º∞‰ª∑ÂØπËØùÊ°ÜÊ†∑Âºè */
:global(.batch-valuation-dialog) {
  width: 90% !important;
  max-width:1000px !important;
}

:global(.batch-valuation-dialog .el-message-box__content) {
  padding: 0 !important;
}

:global(.batch-valuation-dialog .el-message-box__body) {
  padding: 0 !important;
}
</style>
