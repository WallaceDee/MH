# 梦幻西游装备评估系统 - 开发规则

## API响应数据序列化规则

### 🚨 重要：JSON序列化问题

**问题描述：**
在API接口返回数据时，如果包含numpy数据类型（如 `np.float64`, `np.int64`, `np.ndarray` 等），会导致JSON序列化失败，抛出 `TypeError: Object of type float64 is not JSON serializable` 错误。

**影响范围：**
- 所有使用numpy计算的API接口
- 包含统计计算的响应数据
- 机器学习模型输出的数值

**解决方案：**
1. **强制类型转换** - 在返回数据前，将所有numpy类型转换为Python原生类型：
   ```python
   # ❌ 错误做法
   result = {
       'price': np.mean(prices),  # np.float64类型
       'confidence': confidence   # 可能是numpy类型
   }
   
   # ✅ 正确做法
   result = {
       'price': float(np.mean(prices)),
       'confidence': float(confidence)
   }
   ```

2. **常见转换规则**：
   ```python
   # 数值类型
   float_value = float(numpy_float)
   int_value = int(numpy_int)
   
   # 数组类型
   list_value = numpy_array.tolist()
   
   # 统计计算
   mean_value = float(np.mean(data))
   median_value = float(np.median(data))
   percentile_value = float(np.percentile(data, 25))
   ```

**检查清单：**
- [ ] 所有numpy计算结果用对应的Python类型包装
- [ ] 统计函数返回值强制转换类型
- [ ] 机器学习模型输出转换类型
- [ ] 批量数据处理时注意每个元素的类型

### 已修复的文件：
- `src/evaluator/mark_anchor/equip/index.py` - 装备估价器中的所有numpy计算结果
- `src/evaluator/market_anchor_evaluator.py` - 市场锚点估价器中的所有numpy计算结果
- `src/app/services/equipment_service.py` - 装备服务中的锚点预览数据和统计信息

### 测试方法：
```python
import json

# 测试API响应是否可以正常序列化
try:
    json.dumps(api_response_data)
    print("✅ 序列化成功")
except TypeError as e:
    print(f"❌ 序列化失败: {e}")
```

### 自动检查工具：
项目提供了自动检查工具来发现潜在的序列化问题：

```bash
# 运行序列化问题检查
python tools/check_serialization.py
```

该工具会：
- 🔍 扫描所有Python文件
- ⚠️ 识别可能的numpy序列化问题
- 💡 提供具体的修复建议
- 📍 显示问题的确切位置

---

## 代码质量规范

### 数据类型处理
1. **数值计算结果必须转换为Python原生类型**
2. **避免直接返回pandas、numpy对象**
3. **API响应数据结构要保持一致性**

### 错误处理
1. **所有外部数据源访问必须有异常处理**
2. **数据库查询失败要有降级方案**
3. **计算错误要记录详细日志**

### 性能优化
1. **数据库查询要使用索引**
2. **大量计算要考虑并行处理**
3. **频繁调用的函数要考虑缓存**

---

## 历史问题记录

### 2024-12-19: JSON序列化问题
**问题**: `/api/v1/equipment/valuation` 接口返回numpy数据类型导致序列化失败
**根因**: 
- numpy计算结果（如 `np.mean()`, `np.percentile()`）返回numpy特定类型
- 锚点预览数据中包含未转换的数值类型
- 统计信息中的价格和相似度数据类型问题
**解决**: 
- 在所有numpy计算结果上使用 `float()`, `int()` 强制转换
- 对锚点预览数据进行清理，确保所有数值字段可序列化
- 修复统计信息中的数据类型转换
**影响文件**: 
- `src/evaluator/mark_anchor/equip/index.py`
- `src/evaluator/market_anchor_evaluator.py`
- `src/app/services/equipment_service.py`
**预防措施**: 添加此开发规则文档，自动检查工具，定期代码审查

### 2024-12-19: 装备特效筛选逻辑优化
**问题**: 装备相似度比较时，有高价值特效的装备和无特效装备比较不公平
**需求**: 如果目标装备不包含1无级别，3愤怒，5永不磨损等高价值特效，则不应该筛选出具有这些特效的装备
**解决**: 
- 在 `get_market_data_for_similarity` 中增加高价值特效检测逻辑
- 在 `get_market_data` 中添加 `exclude_special_effect` 参数
- 实现SQL查询中的排除特效筛选功能
**影响文件**: `src/evaluator/mark_anchor/equip/equip_market_data_collector.py`
**效果**: 确保装备相似度比较的公平性，避免无特效装备和高价值特效装备错误匹配

---

*最后更新: 2024-12-19* 