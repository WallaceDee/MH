# 角色估价接口新增说明

## 概述

本次更新为CBG爬虫项目新增了完整的角色估价功能，参考装备估价接口的实现，提供了基于市场锚定和规则引擎的混合估价系统。

## 新增功能

### 1. 角色估价控制器 (RoleController)
- **新增方法**: `get_role_valuation()` - 单个角色估价
- **新增方法**: `batch_role_valuation()` - 批量角色估价
- **功能**: 参数验证、策略验证、调用服务层

### 2. 角色估价服务 (RoleService)
- **新增方法**: `get_role_valuation()` - 单个角色估价实现
- **新增方法**: `batch_role_valuation()` - 批量角色估价实现
- **新增方法**: `update_role_base_price()` - 更新角色裸号价格
- **集成组件**: 
  - 混合估价引擎 (HybridValuationEngine)
  - 市场锚定估价器 (MarketAnchorEvaluator)
  - 规则估价器 (RuleEvaluator)
  - 特征提取器 (FeatureExtractor)

### 3. 角色估价API接口
- **POST** `/api/v1/role/valuation` - 单个角色估价
- **POST** `/api/v1/role/batch-valuation` - 批量角色估价
- **GET** `/api/v1/role/valuation/{eid}` - 通过eid获取估价（便捷接口）

## 技术特点

### 1. 混合估价引擎
- 结合市场锚定和规则引擎的优势
- 动态权重调整
- 异常检测和校准

### 2. 多种估价策略
- `fair_value`: 公允价值（推荐）
- `competitive`: 竞争性定价
- `premium`: 溢价定价

### 3. 灵活的参数配置
- 相似度阈值: 0.0-1.0
- 最大锚点数量: 1-100
- 详细日志开关

### 4. 完整的错误处理
- 参数验证
- 异常捕获
- 友好的错误信息

## 使用方式

### 单个角色估价
```python
POST /api/v1/role/valuation
{
    "role_data": {
        "level": 129,
        "expt_ski1": 0,
        "expt_ski2": 21,
        # ... 其他角色属性
    },
    "strategy": "fair_value",
    "similarity_threshold": 0.7,
    "max_anchors": 30
}
```

### 批量角色估价
```python
POST /api/v1/role/batch-valuation
{
    "role_list": [role1, role2, ...],
    "strategy": "fair_value",
    "similarity_threshold": 0.7,
    "max_anchors": 30,
    "verbose": true,
    "eid": "role_123"
}
```

## 返回数据结构

### 成功响应
```json
{
    "code": 200,
    "data": {
        "estimated_price": 50000,           // 估价价格（分）
        "estimated_price_yuan": 500.0,     // 估价价格（元）
        "confidence": 0.85,                // 置信度
        "market_value": 48000,             // 市场估价
        "rule_value": 52000,               // 规则估价
        "integration_strategy": "hybrid",  // 整合策略
        "anchor_count": 25,                // 锚点数量
        "value_breakdown": {...},          // 价值分解
        "warnings": []                     // 警告信息
    },
    "message": "获取角色估价成功"
}
```

### 错误响应
```json
{
    "code": 400,
    "data": {
        "error": "估价计算失败: 未找到相似的市场锚点",
        "estimated_price": 0,
        "estimated_price_yuan": 0
    },
    "message": "估价计算失败: 未找到相似的市场锚点"
}
```

## 测试验证

### 测试文件
- `tests/test_role_valuation.py` - 完整的API测试脚本

### 测试内容
- 单个角色估价功能
- 批量角色估价功能
- 参数验证功能
- 不同策略测试
- 错误处理测试

## 与现有系统的集成

### 1. 数据库更新
- 自动更新角色表中的估价价格
- 支持按年月查询和更新

### 2. 前端集成
- 可参考装备估价的前端实现
- 支持批量估价结果展示
- 估价历史记录

### 3. 爬虫系统
- 可集成到角色爬虫中
- 自动估价和价格更新

## 性能考虑

### 1. 批量处理
- 建议单次批量处理不超过100个角色
- 支持详细日志开关，便于调试

### 2. 缓存策略
- 相同角色数据的估价结果建议缓存
- 避免重复计算，提高响应速度

### 3. 异步处理
- 大量角色估价可考虑异步处理
- 返回任务ID，支持进度查询

## 后续优化建议

### 1. 估价模型优化
- 基于历史数据训练更准确的估价模型
- 支持用户反馈的估价结果校准

### 2. 性能优化
- 实现估价结果缓存
- 支持分布式估价计算

### 3. 功能扩展
- 支持角色套装估价
- 支持跨服角色估价
- 支持角色成长轨迹分析

## 总结

本次新增的角色估价接口完全参考了装备估价接口的设计模式，保持了架构的一致性和代码的可维护性。通过集成混合估价引擎，提供了准确、灵活的角色估价服务，为CBG爬虫项目增加了重要的功能模块。

接口设计遵循RESTful规范，错误处理完善，支持多种估价策略，可以满足不同场景下的角色估价需求。
